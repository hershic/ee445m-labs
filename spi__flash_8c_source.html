<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>EE 445M: utils/spi_flash.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">EE 445M
   
   </div>
   <div id="projectbrief">Real Time Operating Systems taken at University of Texas Spring 2015</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('spi__flash_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">utils/spi_flash.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="spi__flash_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//*****************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">//</span>
<a name="l00003"></a>00003 <span class="comment">// spi_flash.c - Driver for a SPI flash that supports the &quot;Intel&quot; SPI flash</span>
<a name="l00004"></a>00004 <span class="comment">//               command set, capable of utilizing Bi-SPI and Quad-SPI.</span>
<a name="l00005"></a>00005 <span class="comment">//</span>
<a name="l00006"></a>00006 <span class="comment">// Copyright (c) 2012-2014 Texas Instruments Incorporated.  All rights reserved.</span>
<a name="l00007"></a>00007 <span class="comment">// Software License Agreement</span>
<a name="l00008"></a>00008 <span class="comment">// </span>
<a name="l00009"></a>00009 <span class="comment">// Texas Instruments (TI) is supplying this software for use solely and</span>
<a name="l00010"></a>00010 <span class="comment">// exclusively on TI&#39;s microcontroller products. The software is owned by</span>
<a name="l00011"></a>00011 <span class="comment">// TI and/or its suppliers, and is protected under applicable copyright</span>
<a name="l00012"></a>00012 <span class="comment">// laws. You may not combine this software with &quot;viral&quot; open-source</span>
<a name="l00013"></a>00013 <span class="comment">// software in order to form a larger program.</span>
<a name="l00014"></a>00014 <span class="comment">// </span>
<a name="l00015"></a>00015 <span class="comment">// THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND WITH ALL FAULTS.</span>
<a name="l00016"></a>00016 <span class="comment">// NO WARRANTIES, WHETHER EXPRESS, IMPLIED OR STATUTORY, INCLUDING, BUT</span>
<a name="l00017"></a>00017 <span class="comment">// NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="l00018"></a>00018 <span class="comment">// A PARTICULAR PURPOSE APPLY TO THIS SOFTWARE. TI SHALL NOT, UNDER ANY</span>
<a name="l00019"></a>00019 <span class="comment">// CIRCUMSTANCES, BE LIABLE FOR SPECIAL, INCIDENTAL, OR CONSEQUENTIAL</span>
<a name="l00020"></a>00020 <span class="comment">// DAMAGES, FOR ANY REASON WHATSOEVER.</span>
<a name="l00021"></a>00021 <span class="comment">// </span>
<a name="l00022"></a>00022 <span class="comment">// This is part of revision 2.1.0.12573 of the Tiva Utility Library.</span>
<a name="l00023"></a>00023 <span class="comment">//</span>
<a name="l00024"></a>00024 <span class="comment">//*****************************************************************************</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;stdbool.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="hw__ssi_8h.html">inc/hw_ssi.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="hw__types_8h.html">inc/hw_types.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="hw__udma_8h.html">inc/hw_udma.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="rom_8h.html">driverlib/rom.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="rom__map_8h.html">driverlib/rom_map.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="ssi_8h.html">driverlib/ssi.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="udma_8h.html">driverlib/udma.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="spi__flash_8h.html">utils/spi_flash.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">//*****************************************************************************</span>
<a name="l00039"></a>00039 <span class="comment">//</span>
<a name="l00042"></a>00042 <span class="comment"></span><span class="comment">//</span>
<a name="l00043"></a>00043 <span class="comment">//*****************************************************************************</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="comment">//*****************************************************************************</span>
<a name="l00046"></a>00046 <span class="comment">//</span>
<a name="l00047"></a>00047 <span class="comment">// The commands that can be sent to the SPI flash.  This is the &quot;generic&quot;</span>
<a name="l00048"></a>00048 <span class="comment">// command set that is supported by a wide number of SPI flashes.</span>
<a name="l00049"></a>00049 <span class="comment">//</span>
<a name="l00050"></a>00050 <span class="comment">//*****************************************************************************</span>
<a name="l00051"></a><a class="code" href="group__spi__flash__api.html#gacf9ec38b37caa1223e957bba6058f626">00051</a> <span class="preprocessor">#define CMD_WRSR                0x01        // Write status register</span>
<a name="l00052"></a><a class="code" href="group__spi__flash__api.html#ga2543fca56aeb170a41cc9f4d9b24c4cf">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_PP                  0x02        // Page program</span>
<a name="l00053"></a><a class="code" href="group__spi__flash__api.html#ga9c953a6c538020e644127ee080608021">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_READ                0x03        // Read data</span>
<a name="l00054"></a><a class="code" href="group__spi__flash__api.html#gaa98eb90657f02a0b7a4634174081799e">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_WRDI                0x04        // Disable writes</span>
<a name="l00055"></a><a class="code" href="group__spi__flash__api.html#gaf36d3b85d64c03760c6b76e916b443c1">00055</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_RDSR                0x05        // Read status register</span>
<a name="l00056"></a><a class="code" href="group__spi__flash__api.html#ga233ab2b77759d1d35814743f08c96347">00056</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_WREN                0x06        // Enable writes</span>
<a name="l00057"></a><a class="code" href="group__spi__flash__api.html#ga95f7567ee4d9880eb6bcdacc88e0bdf9">00057</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_FREAD               0x0b        // Fast read data</span>
<a name="l00058"></a><a class="code" href="group__spi__flash__api.html#gab108a0bca1eff44cfc82862a6931b04f">00058</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_SE                  0x20        // Sector erase (4K)</span>
<a name="l00059"></a><a class="code" href="group__spi__flash__api.html#gac7464fa85e0f285f4f293e4a5109b88a">00059</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_DREAD               0x3b        // 1 in 2 out read data</span>
<a name="l00060"></a><a class="code" href="group__spi__flash__api.html#ga4c5cce6b9a2f31616e9421737feb2f51">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_BE32                0x52        // Block erase (32K)</span>
<a name="l00061"></a><a class="code" href="group__spi__flash__api.html#gaccf40d95b8aa697f4023b4ff334b61fa">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_QREAD               0x6b        // 1 in 4 out read data</span>
<a name="l00062"></a><a class="code" href="group__spi__flash__api.html#ga7dcce537746ff1c0c717f6ac1f4af57b">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_RDID                0x9f        // Read JEDEC ID</span>
<a name="l00063"></a><a class="code" href="group__spi__flash__api.html#ga90f680398020583fafb3d1a9c03a2aeb">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_CE                  0xc7        // Chip erase</span>
<a name="l00064"></a><a class="code" href="group__spi__flash__api.html#ga2e6d2d790472ab4751450307d668fc6a">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define CMD_BE64                0xd8        // Block erase (64K)</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a>00066 <span class="comment">//*****************************************************************************</span>
<a name="l00067"></a>00067 <span class="comment">//</span>
<a name="l00068"></a>00068 <span class="comment">// The states for the SPI flash interrupt handler state machine.</span>
<a name="l00069"></a>00069 <span class="comment">//</span>
<a name="l00070"></a>00070 <span class="comment">//*****************************************************************************</span>
<a name="l00071"></a><a class="code" href="group__spi__flash__api.html#gaafff27c7165f059a969fe60fee51f683">00071</a> <span class="preprocessor">#define STATE_IDLE              0</span>
<a name="l00072"></a><a class="code" href="group__spi__flash__api.html#ga88c4e00f812e9b6becece01b8f60d678">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_CMD               1</span>
<a name="l00073"></a><a class="code" href="group__spi__flash__api.html#ga24066dd67ecabc27f87c908010002988">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_ADDR1             2</span>
<a name="l00074"></a><a class="code" href="group__spi__flash__api.html#ga37df3bc5709b8a9c3658aa65175e04d8">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_ADDR2             3</span>
<a name="l00075"></a><a class="code" href="group__spi__flash__api.html#ga3b7208a6ce8258ad8bf6160d2ea35b2f">00075</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_ADDR3             4</span>
<a name="l00076"></a><a class="code" href="group__spi__flash__api.html#gaa2044cfac78a38212abe959061b73b93">00076</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_READ_DUMMY        5</span>
<a name="l00077"></a><a class="code" href="group__spi__flash__api.html#ga8a38e584b3df3a826f3e3604b59f1341">00077</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_READ_DATA_SETUP   6</span>
<a name="l00078"></a><a class="code" href="group__spi__flash__api.html#gaad5e20feb263b09e1be1f48394fdb50a">00078</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_READ_DATA         7</span>
<a name="l00079"></a><a class="code" href="group__spi__flash__api.html#ga91b29ddde291ec8eb0a75b7d1aa119f9">00079</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_READ_DATA_DMA     8</span>
<a name="l00080"></a><a class="code" href="group__spi__flash__api.html#ga0a0a8dfd33eacde71dfa36beccd55673">00080</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_READ_DATA_END     9</span>
<a name="l00081"></a><a class="code" href="group__spi__flash__api.html#ga75f5fdfe876583fac9954464e1bdacae">00081</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_WRITE_DATA_SETUP  10</span>
<a name="l00082"></a><a class="code" href="group__spi__flash__api.html#ga76d26adac52cf8bd900415b001591008">00082</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_WRITE_DATA        11</span>
<a name="l00083"></a><a class="code" href="group__spi__flash__api.html#ga2a54f197080ab88952cb98579bf86d9e">00083</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_WRITE_DATA_DMA    12</span>
<a name="l00084"></a><a class="code" href="group__spi__flash__api.html#ga6b1d1c61ab08460db62fe8441f7882ee">00084</a> <span class="preprocessor"></span><span class="preprocessor">#define STATE_WRITE_DATA_END    13</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span>
<a name="l00086"></a>00086 <span class="comment">//*****************************************************************************</span>
<a name="l00087"></a>00087 <span class="comment">//</span>
<a name="l00100"></a>00100 <span class="comment"></span><span class="comment">//</span>
<a name="l00101"></a>00101 <span class="comment">//*****************************************************************************</span>
<a name="l00102"></a>00102 uint32_t
<a name="l00103"></a><a class="code" href="group__spi__flash__api.html#ga0d56c3c7817caa138af5f48be143f0f5">00103</a> <a class="code" href="group__spi__flash__api.html#ga0d56c3c7817caa138af5f48be143f0f5">SPIFlashIntHandler</a>(<a class="code" href="structt_s_p_i_flash_state.html" title="The state structure used when performing non-blocking SPI flash operations.">tSPIFlashState</a> *pState)
<a name="l00104"></a>00104 {
<a name="l00105"></a>00105     uint32_t ui32Data, ui32Count;
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     <span class="comment">//</span>
<a name="l00108"></a>00108     <span class="comment">// Set the write count to four.  This is the maximum number of bytes that</span>
<a name="l00109"></a>00109     <span class="comment">// will be written into the SSI transmit FIFO in the interrupt handler.</span>
<a name="l00110"></a>00110     <span class="comment">// Writing more might be possible but makes the latency of handling future</span>
<a name="l00111"></a>00111     <span class="comment">// SSI interrupt critical to preventing receive FIFO overruns.</span>
<a name="l00112"></a>00112     <span class="comment">//</span>
<a name="l00113"></a>00113     ui32Count = 4;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <span class="comment">//</span>
<a name="l00116"></a>00116     <span class="comment">// Get the set of asserted and unmasked SSI module interrupts.  Only some</span>
<a name="l00117"></a>00117     <span class="comment">// of these are directly handled; the others are implicitly handled via the</span>
<a name="l00118"></a>00118     <span class="comment">// operation of the state machine.</span>
<a name="l00119"></a>00119     <span class="comment">//</span>
<a name="l00120"></a>00120     ui32Data = <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#adb7055b4042d647c5810778257911c2f">SSI_O_MIS</a>);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="comment">//</span>
<a name="l00123"></a>00123     <span class="comment">// See if the uDMA transmit complete interrupt has asserted.</span>
<a name="l00124"></a>00124     <span class="comment">//</span>
<a name="l00125"></a>00125     <span class="keywordflow">if</span>(ui32Data &amp; <a class="code" href="hw__ssi_8h.html#aa2d7bfefb90fd58c349d8f52fe6e05f0">SSI_MIS_DMATXMIS</a>)
<a name="l00126"></a>00126     {
<a name="l00127"></a>00127         <span class="comment">//</span>
<a name="l00128"></a>00128         <span class="comment">// Determine the size of the uDMA transfer based on the number of bytes</span>
<a name="l00129"></a>00129         <span class="comment">// left to write.</span>
<a name="l00130"></a>00130         <span class="comment">//</span>
<a name="l00131"></a>00131         <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> &gt; 1024)
<a name="l00132"></a>00132         {
<a name="l00133"></a>00133             <span class="comment">//</span>
<a name="l00134"></a>00134             <span class="comment">// There are more than 1024 bytes left to transfer, so the uDMA</span>
<a name="l00135"></a>00135             <span class="comment">// transfer that just completed was for a full 1024 bytes.</span>
<a name="l00136"></a>00136             <span class="comment">//</span>
<a name="l00137"></a>00137             pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> -= 1024;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139             <span class="comment">//</span>
<a name="l00140"></a>00140             <span class="comment">// If a page program is being performed, then the data buffer</span>
<a name="l00141"></a>00141             <span class="comment">// pointer needs to be incremented as well.</span>
<a name="l00142"></a>00142             <span class="comment">//</span>
<a name="l00143"></a>00143             <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a074f5ab3f6e39f06334bf7ce875c8027" title="The command that is being send to the SPI flash.">ui16Cmd</a> == <a class="code" href="group__spi__flash__api.html#ga2543fca56aeb170a41cc9f4d9b24c4cf">CMD_PP</a>)
<a name="l00144"></a>00144             {
<a name="l00145"></a>00145                 <span class="comment">//</span>
<a name="l00146"></a>00146                 <span class="comment">// Increment the data buffer pointer.</span>
<a name="l00147"></a>00147                 <span class="comment">//</span>
<a name="l00148"></a>00148                 pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a> += 1024;
<a name="l00149"></a>00149 
<a name="l00150"></a>00150                 <span class="comment">//</span>
<a name="l00151"></a>00151                 <span class="comment">// See if there is more than one byte left to transfer.</span>
<a name="l00152"></a>00152                 <span class="comment">//</span>
<a name="l00153"></a>00153                 <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> &gt; 1)
<a name="l00154"></a>00154                 {
<a name="l00155"></a>00155                     <span class="comment">//</span>
<a name="l00156"></a>00156                     <span class="comment">// Configure the uDMA to transmit the next portion of the</span>
<a name="l00157"></a>00157                     <span class="comment">// data buffer.</span>
<a name="l00158"></a>00158                     <span class="comment">//</span>
<a name="l00159"></a>00159                     <a class="code" href="group__udma__api.html#ga938c21dc70cb6e11e6eb826de0fa21c3">uDMAChannelTransferSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>,
<a name="l00160"></a>00160                                            <a class="code" href="udma_8h.html#a0d0916171d90267e53ad4c455f81ab85">UDMA_MODE_BASIC</a>,
<a name="l00161"></a>00161                                            pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a>,
<a name="l00162"></a>00162                                            (<span class="keywordtype">void</span> *)(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> +
<a name="l00163"></a>00163                                                     <a class="code" href="hw__ssi_8h.html#aeee45da597a7055c2b8468367cd8e920">SSI_O_DR</a>),
<a name="l00164"></a>00164                                            (pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> &gt; 1024) ?
<a name="l00165"></a>00165                                            1024 : pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> - 1);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167                     <span class="comment">//</span>
<a name="l00168"></a>00168                     <span class="comment">// Enable the uDMA transmit channel.</span>
<a name="l00169"></a>00169                     <span class="comment">//</span>
<a name="l00170"></a>00170                     <a class="code" href="group__udma__api.html#ga41e21189773539bbc5f302863cd5bf06">uDMAChannelEnable</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>);
<a name="l00171"></a>00171                 }
<a name="l00172"></a>00172             }
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174         <span class="keywordflow">else</span>
<a name="l00175"></a>00175         {
<a name="l00176"></a>00176             <span class="comment">//</span>
<a name="l00177"></a>00177             <span class="comment">// There are 1024 or less bytes left to transfer, so the uDMA</span>
<a name="l00178"></a>00178             <span class="comment">// transfer that just copmleted was for one less than the remaining</span>
<a name="l00179"></a>00179             <span class="comment">// transfer count.  If a page program is being performed, then the</span>
<a name="l00180"></a>00180             <span class="comment">// data buffer pointer needs to be incremented.</span>
<a name="l00181"></a>00181             <span class="comment">//</span>
<a name="l00182"></a>00182             <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a074f5ab3f6e39f06334bf7ce875c8027" title="The command that is being send to the SPI flash.">ui16Cmd</a> == <a class="code" href="group__spi__flash__api.html#ga2543fca56aeb170a41cc9f4d9b24c4cf">CMD_PP</a>)
<a name="l00183"></a>00183             {
<a name="l00184"></a>00184                 pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a> += (pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> - 1);
<a name="l00185"></a>00185             }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187             <span class="comment">//</span>
<a name="l00188"></a>00188             <span class="comment">// Set the remaining transfer count to 1.  The final byte will be</span>
<a name="l00189"></a>00189             <span class="comment">// transferred with PIO since the end of frame flag needs to be set</span>
<a name="l00190"></a>00190             <span class="comment">// first.</span>
<a name="l00191"></a>00191             <span class="comment">//</span>
<a name="l00192"></a>00192             pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> = 1;
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195         <span class="comment">//</span>
<a name="l00196"></a>00196         <span class="comment">// Clear the uDMA transmit complete interrupt.</span>
<a name="l00197"></a>00197         <span class="comment">//</span>
<a name="l00198"></a>00198         <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#aaf63879f2c29b6fd6d9903153dd4271a">SSI_O_ICR</a>) = <a class="code" href="hw__ssi_8h.html#a873e573501798cee815d0e810979e579">SSI_ICR_DMATXIC</a>;
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="comment">//</span>
<a name="l00202"></a>00202     <span class="comment">// See if the uDMA receive complete interrupt has asserted.</span>
<a name="l00203"></a>00203     <span class="comment">//</span>
<a name="l00204"></a>00204     <span class="keywordflow">if</span>(ui32Data &amp; <a class="code" href="hw__ssi_8h.html#a9e26a9350a70e9cd92f99d5a83f6670a">SSI_MIS_DMARXMIS</a>)
<a name="l00205"></a>00205     {
<a name="l00206"></a>00206         <span class="comment">//</span>
<a name="l00207"></a>00207         <span class="comment">// Determine the size of the uDMA transfer based on the number of bytes</span>
<a name="l00208"></a>00208         <span class="comment">// left to read.</span>
<a name="l00209"></a>00209         <span class="comment">//</span>
<a name="l00210"></a>00210         <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> &gt;= 1024)
<a name="l00211"></a>00211         {
<a name="l00212"></a>00212             <span class="comment">//</span>
<a name="l00213"></a>00213             <span class="comment">// There are 1024 or more bytes left to transfer, so the uDMA</span>
<a name="l00214"></a>00214             <span class="comment">// transfer that just completed was for a full 1024 bytes.</span>
<a name="l00215"></a>00215             <span class="comment">//</span>
<a name="l00216"></a>00216             pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> -= 1024;
<a name="l00217"></a>00217             <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> != 0)
<a name="l00218"></a>00218             {
<a name="l00219"></a>00219                 pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> -= 1024;
<a name="l00220"></a>00220             }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222             <span class="comment">//</span>
<a name="l00223"></a>00223             <span class="comment">// The data buffer pointer needs to be incremented as well.</span>
<a name="l00224"></a>00224             <span class="comment">//</span>
<a name="l00225"></a>00225             pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a> += 1024;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227             <span class="comment">//</span>
<a name="l00228"></a>00228             <span class="comment">// See if there is additional data to transfer.</span>
<a name="l00229"></a>00229             <span class="comment">//</span>
<a name="l00230"></a>00230             <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> != 0)
<a name="l00231"></a>00231             {
<a name="l00232"></a>00232                 <span class="comment">//</span>
<a name="l00233"></a>00233                 <span class="comment">// Configure the transmit uDMA if there is more than one byte</span>
<a name="l00234"></a>00234                 <span class="comment">// left to write.</span>
<a name="l00235"></a>00235                 <span class="comment">//</span>
<a name="l00236"></a>00236                 <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> &gt; 1)
<a name="l00237"></a>00237                 {
<a name="l00238"></a>00238                     <span class="comment">//</span>
<a name="l00239"></a>00239                     <span class="comment">// Configure the uDMA to transmit the next portion of the</span>
<a name="l00240"></a>00240                     <span class="comment">// data buffer.</span>
<a name="l00241"></a>00241                     <span class="comment">//</span>
<a name="l00242"></a>00242                     <a class="code" href="group__udma__api.html#ga938c21dc70cb6e11e6eb826de0fa21c3">uDMAChannelTransferSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>,
<a name="l00243"></a>00243                                            <a class="code" href="udma_8h.html#a0d0916171d90267e53ad4c455f81ab85">UDMA_MODE_BASIC</a>, pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a>,
<a name="l00244"></a>00244                                            (<span class="keywordtype">void</span> *)(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> +
<a name="l00245"></a>00245                                                     <a class="code" href="hw__ssi_8h.html#aeee45da597a7055c2b8468367cd8e920">SSI_O_DR</a>),
<a name="l00246"></a>00246                                            (pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> &gt; 1024) ?
<a name="l00247"></a>00247                                            1024 : pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> - 1);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249                     <span class="comment">//</span>
<a name="l00250"></a>00250                     <span class="comment">// Enable the uDMA transmit channel.</span>
<a name="l00251"></a>00251                     <span class="comment">//</span>
<a name="l00252"></a>00252                     <a class="code" href="group__udma__api.html#ga41e21189773539bbc5f302863cd5bf06">uDMAChannelEnable</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>);
<a name="l00253"></a>00253                 }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255                 <span class="comment">//</span>
<a name="l00256"></a>00256                 <span class="comment">// Configure the uDMA to receive the next portion of the data</span>
<a name="l00257"></a>00257                 <span class="comment">// buffer.</span>
<a name="l00258"></a>00258                 <span class="comment">//</span>
<a name="l00259"></a>00259                 <a class="code" href="group__udma__api.html#ga938c21dc70cb6e11e6eb826de0fa21c3">uDMAChannelTransferSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a>, <a class="code" href="udma_8h.html#a0d0916171d90267e53ad4c455f81ab85">UDMA_MODE_BASIC</a>,
<a name="l00260"></a>00260                                        (<span class="keywordtype">void</span> *)(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#aeee45da597a7055c2b8468367cd8e920">SSI_O_DR</a>),
<a name="l00261"></a>00261                                        pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a>,
<a name="l00262"></a>00262                                        (pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> &gt;= 1024) ?
<a name="l00263"></a>00263                                        1024 : pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a>);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265                 <span class="comment">//</span>
<a name="l00266"></a>00266                 <span class="comment">// Enable the uDMA receive channel.</span>
<a name="l00267"></a>00267                 <span class="comment">//</span>
<a name="l00268"></a>00268                 <a class="code" href="group__udma__api.html#ga41e21189773539bbc5f302863cd5bf06">uDMAChannelEnable</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a>);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270                 <span class="comment">//</span>
<a name="l00271"></a>00271                 <span class="comment">// If this is the final receive uDMA buffer and there is a</span>
<a name="l00272"></a>00272                 <span class="comment">// transmit uDMA buffer associated, enable the DMA transmit</span>
<a name="l00273"></a>00273                 <span class="comment">// interrupt.</span>
<a name="l00274"></a>00274                 <span class="comment">//</span>
<a name="l00275"></a>00275                 <span class="keywordflow">if</span>((pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> &lt;= 1024) &amp;&amp;
<a name="l00276"></a>00276                    (pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> &gt; 1))
<a name="l00277"></a>00277                 {
<a name="l00278"></a>00278                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#aaf63879f2c29b6fd6d9903153dd4271a">SSI_O_ICR</a>) = <a class="code" href="hw__ssi_8h.html#a873e573501798cee815d0e810979e579">SSI_ICR_DMATXIC</a>;
<a name="l00279"></a>00279                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) = <a class="code" href="hw__ssi_8h.html#a061b9446afd7711c00e17fb127490c41">SSI_IM_DMATXIM</a>;
<a name="l00280"></a>00280                 }
<a name="l00281"></a>00281             }
<a name="l00282"></a>00282         }
<a name="l00283"></a>00283         <span class="keywordflow">else</span>
<a name="l00284"></a>00284         {
<a name="l00285"></a>00285             <span class="comment">//</span>
<a name="l00286"></a>00286             <span class="comment">// There are less than 1024 bytes left to transfer, so the uDMA</span>
<a name="l00287"></a>00287             <span class="comment">// transfer that copmleted was for the remaining transfer count.</span>
<a name="l00288"></a>00288             <span class="comment">//</span>
<a name="l00289"></a>00289             pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> = 0;
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292         <span class="comment">//</span>
<a name="l00293"></a>00293         <span class="comment">// Clear the uDMA receive complete interrupt.</span>
<a name="l00294"></a>00294         <span class="comment">//</span>
<a name="l00295"></a>00295         <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#aaf63879f2c29b6fd6d9903153dd4271a">SSI_O_ICR</a>) = <a class="code" href="hw__ssi_8h.html#a954860482fa17ad95cd0d4cb44fda84b">SSI_ICR_DMARXIC</a>;
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="comment">//</span>
<a name="l00299"></a>00299     <span class="comment">// Drain the receive FIFO is not using uDMA.</span>
<a name="l00300"></a>00300     <span class="comment">//</span>
<a name="l00301"></a>00301     <span class="keywordflow">if</span>(!pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ab33983a1783bc5f7593f60ebf8975645" title="A flag that is true if uDMA used be used for the transfer.">bUseDMA</a>)
<a name="l00302"></a>00302     {
<a name="l00303"></a>00303         <span class="comment">//</span>
<a name="l00304"></a>00304         <span class="comment">// Loop while there is more data in the receive FIFO and more data to</span>
<a name="l00305"></a>00305         <span class="comment">// be read.</span>
<a name="l00306"></a>00306         <span class="comment">//</span>
<a name="l00307"></a>00307         <span class="keywordflow">while</span>((pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> != 0) &amp;&amp;
<a name="l00308"></a>00308               (<a class="code" href="rom__map_8h.html#a2985d0cd62b5efa437dd6c4053a66e4f">MAP_SSIDataGetNonBlocking</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>, &amp;ui32Data) != 0))
<a name="l00309"></a>00309         {
<a name="l00310"></a>00310             <span class="comment">//</span>
<a name="l00311"></a>00311             <span class="comment">// Save this byte into the data buffer.</span>
<a name="l00312"></a>00312             <span class="comment">//</span>
<a name="l00313"></a>00313             *(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a>)++ = ui32Data &amp; 0xff;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315             <span class="comment">//</span>
<a name="l00316"></a>00316             <span class="comment">// Decrement the read count.</span>
<a name="l00317"></a>00317             <span class="comment">//</span>
<a name="l00318"></a>00318             pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a>--;
<a name="l00319"></a>00319         }
<a name="l00320"></a>00320     }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322     <span class="comment">//</span>
<a name="l00323"></a>00323     <span class="comment">// The SPI flash state machine.  Loop forever; the state machine will</span>
<a name="l00324"></a>00324     <span class="comment">// explicitly return to the caller when there is no further work that can</span>
<a name="l00325"></a>00325     <span class="comment">// be done without stalling.</span>
<a name="l00326"></a>00326     <span class="comment">//</span>
<a name="l00327"></a>00327     <span class="keywordflow">while</span>(1)
<a name="l00328"></a>00328     {
<a name="l00329"></a>00329         <span class="comment">//</span>
<a name="l00330"></a>00330         <span class="comment">// Determine the current state.</span>
<a name="l00331"></a>00331         <span class="comment">//</span>
<a name="l00332"></a>00332         <span class="keywordflow">switch</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a>)
<a name="l00333"></a>00333         {
<a name="l00334"></a>00334             <span class="comment">//</span>
<a name="l00335"></a>00335             <span class="comment">// The state machine is idle.</span>
<a name="l00336"></a>00336             <span class="comment">//</span>
<a name="l00337"></a>00337             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#gaafff27c7165f059a969fe60fee51f683">STATE_IDLE</a>:
<a name="l00338"></a>00338             {
<a name="l00339"></a>00339                 <span class="comment">//</span>
<a name="l00340"></a>00340                 <span class="comment">// Return indicating that the state machine is idle.  This</span>
<a name="l00341"></a>00341                 <span class="comment">// should never happen since no further interrupts should occur</span>
<a name="l00342"></a>00342                 <span class="comment">// once the transfer has completed and the state machine goes</span>
<a name="l00343"></a>00343                 <span class="comment">// into the idle state.</span>
<a name="l00344"></a>00344                 <span class="comment">//</span>
<a name="l00345"></a>00345                 <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ac6eafdef3c4e5d673a746ea45dcafb33">SPI_FLASH_IDLE</a>);
<a name="l00346"></a>00346             }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348             <span class="comment">//</span>
<a name="l00349"></a>00349             <span class="comment">// The state machine is in the command state.</span>
<a name="l00350"></a>00350             <span class="comment">//</span>
<a name="l00351"></a>00351             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#ga88c4e00f812e9b6becece01b8f60d678">STATE_CMD</a>:
<a name="l00352"></a>00352             {
<a name="l00353"></a>00353                 <span class="comment">//</span>
<a name="l00354"></a>00354                 <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l00355"></a>00355                 <span class="comment">//</span>
<a name="l00356"></a>00356                 <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l00357"></a>00357 
<a name="l00358"></a>00358                 <span class="comment">//</span>
<a name="l00359"></a>00359                 <span class="comment">// Attempt to write the command byte into the FIFO.</span>
<a name="l00360"></a>00360                 <span class="comment">//</span>
<a name="l00361"></a>00361                 <span class="keywordflow">if</span>(ui32Count == 0)
<a name="l00362"></a>00362                 {
<a name="l00363"></a>00363                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00364"></a>00364                 }
<a name="l00365"></a>00365                 <span class="keywordflow">if</span>(<a class="code" href="rom__map_8h.html#a8c46066183d1c49c10582b59490607a7">MAP_SSIDataPutNonBlocking</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>,
<a name="l00366"></a>00366                                              pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a074f5ab3f6e39f06334bf7ce875c8027" title="The command that is being send to the SPI flash.">ui16Cmd</a>) == 0)
<a name="l00367"></a>00367                 {
<a name="l00368"></a>00368                     <span class="comment">//</span>
<a name="l00369"></a>00369                     <span class="comment">// The command byte could not be written, so return</span>
<a name="l00370"></a>00370                     <span class="comment">// indicating that the transfer is still in progress.</span>
<a name="l00371"></a>00371                     <span class="comment">//</span>
<a name="l00372"></a>00372                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00373"></a>00373                 }
<a name="l00374"></a>00374                 <span class="keywordflow">else</span>
<a name="l00375"></a>00375                 {
<a name="l00376"></a>00376                     <span class="comment">//</span>
<a name="l00377"></a>00377                     <span class="comment">// The command byte has been written, so move to the first</span>
<a name="l00378"></a>00378                     <span class="comment">// address byte state.</span>
<a name="l00379"></a>00379                     <span class="comment">//</span>
<a name="l00380"></a>00380                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga24066dd67ecabc27f87c908010002988">STATE_ADDR1</a>;
<a name="l00381"></a>00381 
<a name="l00382"></a>00382                     <span class="comment">//</span>
<a name="l00383"></a>00383                     <span class="comment">// Decrement the count of bytes that have been written.</span>
<a name="l00384"></a>00384                     <span class="comment">//</span>
<a name="l00385"></a>00385                     ui32Count--;
<a name="l00386"></a>00386                 }
<a name="l00387"></a>00387 
<a name="l00388"></a>00388                 <span class="comment">//</span>
<a name="l00389"></a>00389                 <span class="comment">// Done with this state.</span>
<a name="l00390"></a>00390                 <span class="comment">//</span>
<a name="l00391"></a>00391                 <span class="keywordflow">break</span>;
<a name="l00392"></a>00392             }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394             <span class="comment">//</span>
<a name="l00395"></a>00395             <span class="comment">// The state machine is in the first address byte state.</span>
<a name="l00396"></a>00396             <span class="comment">//</span>
<a name="l00397"></a>00397             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#ga24066dd67ecabc27f87c908010002988">STATE_ADDR1</a>:
<a name="l00398"></a>00398             {
<a name="l00399"></a>00399                 <span class="comment">//</span>
<a name="l00400"></a>00400                 <span class="comment">// Attempt to write the first address byte into the FIFO.</span>
<a name="l00401"></a>00401                 <span class="comment">//</span>
<a name="l00402"></a>00402                 <span class="keywordflow">if</span>(ui32Count == 0)
<a name="l00403"></a>00403                 {
<a name="l00404"></a>00404                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00405"></a>00405                 }
<a name="l00406"></a>00406                 <span class="keywordflow">if</span>(<a class="code" href="rom__map_8h.html#a8c46066183d1c49c10582b59490607a7">MAP_SSIDataPutNonBlocking</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>,
<a name="l00407"></a>00407                                              (pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a14849eb4c3631e87c93d6bc2ed7c5a9d" title="The SPI flash address associated with the command.">ui32Addr</a> &gt;&gt; 16) &amp;
<a name="l00408"></a>00408                                              0xff) == 0)
<a name="l00409"></a>00409                 {
<a name="l00410"></a>00410                     <span class="comment">//</span>
<a name="l00411"></a>00411                     <span class="comment">// The first address byte could not be written, so return</span>
<a name="l00412"></a>00412                     <span class="comment">// indicating that the transfer is still in progress.</span>
<a name="l00413"></a>00413                     <span class="comment">//</span>
<a name="l00414"></a>00414                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00415"></a>00415                 }
<a name="l00416"></a>00416                 <span class="keywordflow">else</span>
<a name="l00417"></a>00417                 {
<a name="l00418"></a>00418                     <span class="comment">//</span>
<a name="l00419"></a>00419                     <span class="comment">// The first address byte has been written, so move to the</span>
<a name="l00420"></a>00420                     <span class="comment">// second address byte state.</span>
<a name="l00421"></a>00421                     <span class="comment">//</span>
<a name="l00422"></a>00422                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga37df3bc5709b8a9c3658aa65175e04d8">STATE_ADDR2</a>;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424                     <span class="comment">//</span>
<a name="l00425"></a>00425                     <span class="comment">// Decrement the count of bytes that have been written.</span>
<a name="l00426"></a>00426                     <span class="comment">//</span>
<a name="l00427"></a>00427                     ui32Count--;
<a name="l00428"></a>00428                 }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430                 <span class="comment">//</span>
<a name="l00431"></a>00431                 <span class="comment">// Done with this state.</span>
<a name="l00432"></a>00432                 <span class="comment">//</span>
<a name="l00433"></a>00433                 <span class="keywordflow">break</span>;
<a name="l00434"></a>00434             }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436             <span class="comment">//</span>
<a name="l00437"></a>00437             <span class="comment">// The state machine is in the second address byte state.</span>
<a name="l00438"></a>00438             <span class="comment">//</span>
<a name="l00439"></a>00439             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#ga37df3bc5709b8a9c3658aa65175e04d8">STATE_ADDR2</a>:
<a name="l00440"></a>00440             {
<a name="l00441"></a>00441                 <span class="comment">//</span>
<a name="l00442"></a>00442                 <span class="comment">// Attempt to write the second address byte into the FIFO.</span>
<a name="l00443"></a>00443                 <span class="comment">//</span>
<a name="l00444"></a>00444                 <span class="keywordflow">if</span>(ui32Count == 0)
<a name="l00445"></a>00445                 {
<a name="l00446"></a>00446                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00447"></a>00447                 }
<a name="l00448"></a>00448                 <span class="keywordflow">if</span>(<a class="code" href="rom__map_8h.html#a8c46066183d1c49c10582b59490607a7">MAP_SSIDataPutNonBlocking</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>,
<a name="l00449"></a>00449                                              (pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a14849eb4c3631e87c93d6bc2ed7c5a9d" title="The SPI flash address associated with the command.">ui32Addr</a> &gt;&gt; 8) &amp; 0xff) ==
<a name="l00450"></a>00450                    0)
<a name="l00451"></a>00451                 {
<a name="l00452"></a>00452                     <span class="comment">//</span>
<a name="l00453"></a>00453                     <span class="comment">// The second address byte could not be written, so return</span>
<a name="l00454"></a>00454                     <span class="comment">// indicating that the transfer is still in progress.</span>
<a name="l00455"></a>00455                     <span class="comment">//</span>
<a name="l00456"></a>00456                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00457"></a>00457                 }
<a name="l00458"></a>00458                 <span class="keywordflow">else</span>
<a name="l00459"></a>00459                 {
<a name="l00460"></a>00460                     <span class="comment">//</span>
<a name="l00461"></a>00461                     <span class="comment">// The second address byte has been written, so move to the</span>
<a name="l00462"></a>00462                     <span class="comment">// third address byte state.</span>
<a name="l00463"></a>00463                     <span class="comment">//</span>
<a name="l00464"></a>00464                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga3b7208a6ce8258ad8bf6160d2ea35b2f">STATE_ADDR3</a>;
<a name="l00465"></a>00465 
<a name="l00466"></a>00466                     <span class="comment">//</span>
<a name="l00467"></a>00467                     <span class="comment">// Decrement the count of bytes that have been written.</span>
<a name="l00468"></a>00468                     <span class="comment">//</span>
<a name="l00469"></a>00469                     ui32Count--;
<a name="l00470"></a>00470                 }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472                 <span class="comment">//</span>
<a name="l00473"></a>00473                 <span class="comment">// Done with this state.</span>
<a name="l00474"></a>00474                 <span class="comment">//</span>
<a name="l00475"></a>00475                 <span class="keywordflow">break</span>;
<a name="l00476"></a>00476             }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478             <span class="comment">//</span>
<a name="l00479"></a>00479             <span class="comment">// The state machine is in the third address byte state.</span>
<a name="l00480"></a>00480             <span class="comment">//</span>
<a name="l00481"></a>00481             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#ga3b7208a6ce8258ad8bf6160d2ea35b2f">STATE_ADDR3</a>:
<a name="l00482"></a>00482             {
<a name="l00483"></a>00483                 <span class="comment">//</span>
<a name="l00484"></a>00484                 <span class="comment">// Attempt to write the third address byte into the FIFO.</span>
<a name="l00485"></a>00485                 <span class="comment">//</span>
<a name="l00486"></a>00486                 <span class="keywordflow">if</span>(ui32Count == 0)
<a name="l00487"></a>00487                 {
<a name="l00488"></a>00488                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00489"></a>00489                 }
<a name="l00490"></a>00490                 <span class="keywordflow">if</span>(<a class="code" href="rom__map_8h.html#a8c46066183d1c49c10582b59490607a7">MAP_SSIDataPutNonBlocking</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>,
<a name="l00491"></a>00491                                              pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a14849eb4c3631e87c93d6bc2ed7c5a9d" title="The SPI flash address associated with the command.">ui32Addr</a> &amp; 0xff) == 0)
<a name="l00492"></a>00492                 {
<a name="l00493"></a>00493                     <span class="comment">//</span>
<a name="l00494"></a>00494                     <span class="comment">// The third address byte could not be written, so return</span>
<a name="l00495"></a>00495                     <span class="comment">// indicating that the transfer is still in progress.</span>
<a name="l00496"></a>00496                     <span class="comment">//</span>
<a name="l00497"></a>00497                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00498"></a>00498                 }
<a name="l00499"></a>00499                 <span class="keywordflow">else</span>
<a name="l00500"></a>00500                 {
<a name="l00501"></a>00501                     <span class="comment">//</span>
<a name="l00502"></a>00502                     <span class="comment">// The third address byte has been written, so determine</span>
<a name="l00503"></a>00503                     <span class="comment">// the next state based on the command byte.</span>
<a name="l00504"></a>00504                     <span class="comment">//</span>
<a name="l00505"></a>00505                     <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a074f5ab3f6e39f06334bf7ce875c8027" title="The command that is being send to the SPI flash.">ui16Cmd</a> == <a class="code" href="group__spi__flash__api.html#ga2543fca56aeb170a41cc9f4d9b24c4cf">CMD_PP</a>)
<a name="l00506"></a>00506                     {
<a name="l00507"></a>00507                         <span class="comment">//</span>
<a name="l00508"></a>00508                         <span class="comment">// A page program is being performed, so move to the</span>
<a name="l00509"></a>00509                         <span class="comment">// write data setup state.</span>
<a name="l00510"></a>00510                         <span class="comment">//</span>
<a name="l00511"></a>00511                         pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga75f5fdfe876583fac9954464e1bdacae">STATE_WRITE_DATA_SETUP</a>;
<a name="l00512"></a>00512                     }
<a name="l00513"></a>00513                     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a074f5ab3f6e39f06334bf7ce875c8027" title="The command that is being send to the SPI flash.">ui16Cmd</a> == <a class="code" href="group__spi__flash__api.html#ga9c953a6c538020e644127ee080608021">CMD_READ</a>)
<a name="l00514"></a>00514                     {
<a name="l00515"></a>00515                         <span class="comment">//</span>
<a name="l00516"></a>00516                         <span class="comment">// A read is being performed, so move to the read data</span>
<a name="l00517"></a>00517                         <span class="comment">// setup state.</span>
<a name="l00518"></a>00518                         <span class="comment">//</span>
<a name="l00519"></a>00519                         pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga8a38e584b3df3a826f3e3604b59f1341">STATE_READ_DATA_SETUP</a>;
<a name="l00520"></a>00520                     }
<a name="l00521"></a>00521                     <span class="keywordflow">else</span>
<a name="l00522"></a>00522                     {
<a name="l00523"></a>00523                         <span class="comment">//</span>
<a name="l00524"></a>00524                         <span class="comment">// The other forms of read (fast read, dual read, and</span>
<a name="l00525"></a>00525                         <span class="comment">// quad read) all require a dummy byte.  Move to the</span>
<a name="l00526"></a>00526                         <span class="comment">// dummy byte state.</span>
<a name="l00527"></a>00527                         <span class="comment">//</span>
<a name="l00528"></a>00528                         pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#gaa2044cfac78a38212abe959061b73b93">STATE_READ_DUMMY</a>;
<a name="l00529"></a>00529                     }
<a name="l00530"></a>00530 
<a name="l00531"></a>00531                     <span class="comment">//</span>
<a name="l00532"></a>00532                     <span class="comment">// Decrement the count of bytes that have been written.</span>
<a name="l00533"></a>00533                     <span class="comment">//</span>
<a name="l00534"></a>00534                     ui32Count--;
<a name="l00535"></a>00535                 }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537                 <span class="comment">//</span>
<a name="l00538"></a>00538                 <span class="comment">// Done with this state.</span>
<a name="l00539"></a>00539                 <span class="comment">//</span>
<a name="l00540"></a>00540                 <span class="keywordflow">break</span>;
<a name="l00541"></a>00541             }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543             <span class="comment">//</span>
<a name="l00544"></a>00544             <span class="comment">// The state machine is in the dummy byte state.</span>
<a name="l00545"></a>00545             <span class="comment">//</span>
<a name="l00546"></a>00546             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#gaa2044cfac78a38212abe959061b73b93">STATE_READ_DUMMY</a>:
<a name="l00547"></a>00547             {
<a name="l00548"></a>00548                 <span class="comment">//</span>
<a name="l00549"></a>00549                 <span class="comment">// Attempt to write the dummy byte into the FIFO.</span>
<a name="l00550"></a>00550                 <span class="comment">//</span>
<a name="l00551"></a>00551                 <span class="keywordflow">if</span>(ui32Count == 0)
<a name="l00552"></a>00552                 {
<a name="l00553"></a>00553                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00554"></a>00554                 }
<a name="l00555"></a>00555                 <span class="keywordflow">if</span>(<a class="code" href="rom__map_8h.html#a8c46066183d1c49c10582b59490607a7">MAP_SSIDataPutNonBlocking</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>, 0) == 0)
<a name="l00556"></a>00556                 {
<a name="l00557"></a>00557                     <span class="comment">//</span>
<a name="l00558"></a>00558                     <span class="comment">// THe dummy byte could not be written, so return</span>
<a name="l00559"></a>00559                     <span class="comment">// indicating that the transfer is still in progress.</span>
<a name="l00560"></a>00560                     <span class="comment">//</span>
<a name="l00561"></a>00561                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00562"></a>00562                 }
<a name="l00563"></a>00563                 <span class="keywordflow">else</span>
<a name="l00564"></a>00564                 {
<a name="l00565"></a>00565                     <span class="comment">//</span>
<a name="l00566"></a>00566                     <span class="comment">// The dummy byte has been written, so move to the read</span>
<a name="l00567"></a>00567                     <span class="comment">// data setup state.</span>
<a name="l00568"></a>00568                     <span class="comment">//</span>
<a name="l00569"></a>00569                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga8a38e584b3df3a826f3e3604b59f1341">STATE_READ_DATA_SETUP</a>;
<a name="l00570"></a>00570 
<a name="l00571"></a>00571                     <span class="comment">//</span>
<a name="l00572"></a>00572                     <span class="comment">// Decrement the count of bytes that have been written.</span>
<a name="l00573"></a>00573                     <span class="comment">//</span>
<a name="l00574"></a>00574                     ui32Count--;
<a name="l00575"></a>00575                 }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577                 <span class="comment">//</span>
<a name="l00578"></a>00578                 <span class="comment">// Done with this state.</span>
<a name="l00579"></a>00579                 <span class="comment">//</span>
<a name="l00580"></a>00580                 <span class="keywordflow">break</span>;
<a name="l00581"></a>00581             }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583             <span class="comment">//</span>
<a name="l00584"></a>00584             <span class="comment">// The state machine is in the read data setup state.</span>
<a name="l00585"></a>00585             <span class="comment">//</span>
<a name="l00586"></a>00586             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#ga8a38e584b3df3a826f3e3604b59f1341">STATE_READ_DATA_SETUP</a>:
<a name="l00587"></a>00587             {
<a name="l00588"></a>00588                 <span class="comment">//</span>
<a name="l00589"></a>00589                 <span class="comment">// Set the SSI module into the appropriate mode based on the</span>
<a name="l00590"></a>00590                 <span class="comment">// command byte.</span>
<a name="l00591"></a>00591                 <span class="comment">//</span>
<a name="l00592"></a>00592                 <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a074f5ab3f6e39f06334bf7ce875c8027" title="The command that is being send to the SPI flash.">ui16Cmd</a> == <a class="code" href="group__spi__flash__api.html#gac7464fa85e0f285f4f293e4a5109b88a">CMD_DREAD</a>)
<a name="l00593"></a>00593                 {
<a name="l00594"></a>00594                     <span class="comment">//</span>
<a name="l00595"></a>00595                     <span class="comment">// Bi-SPI read mode is used for the dual read command.</span>
<a name="l00596"></a>00596                     <span class="comment">//</span>
<a name="l00597"></a>00597                     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>, <a class="code" href="ssi_8h.html#a0d3b574fbf3d0b60970d6f3357ac13bd">SSI_ADV_MODE_BI_READ</a>);
<a name="l00598"></a>00598                 }
<a name="l00599"></a>00599                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a074f5ab3f6e39f06334bf7ce875c8027" title="The command that is being send to the SPI flash.">ui16Cmd</a> == <a class="code" href="group__spi__flash__api.html#gaccf40d95b8aa697f4023b4ff334b61fa">CMD_QREAD</a>)
<a name="l00600"></a>00600                 {
<a name="l00601"></a>00601                     <span class="comment">//</span>
<a name="l00602"></a>00602                     <span class="comment">// Quad-SPI read mode is used for the quad read command.</span>
<a name="l00603"></a>00603                     <span class="comment">//</span>
<a name="l00604"></a>00604                     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>,
<a name="l00605"></a>00605                                       <a class="code" href="ssi_8h.html#a4dd541d5976ffab841e75cbaa5515a48">SSI_ADV_MODE_QUAD_READ</a>);
<a name="l00606"></a>00606                 }
<a name="l00607"></a>00607                 <span class="keywordflow">else</span>
<a name="l00608"></a>00608                 {
<a name="l00609"></a>00609                     <span class="comment">//</span>
<a name="l00610"></a>00610                     <span class="comment">// Advanced read/write mode is used for the read and fast</span>
<a name="l00611"></a>00611                     <span class="comment">// read commands.</span>
<a name="l00612"></a>00612                     <span class="comment">//</span>
<a name="l00613"></a>00613                     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>,
<a name="l00614"></a>00614                                       <a class="code" href="ssi_8h.html#a3b381e1d2c940e29363b2e12591f9a0b">SSI_ADV_MODE_READ_WRITE</a>);
<a name="l00615"></a>00615                 }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617                 <span class="comment">//</span>
<a name="l00618"></a>00618                 <span class="comment">// See if a single byte is being transferred.</span>
<a name="l00619"></a>00619                 <span class="comment">//</span>
<a name="l00620"></a>00620                 <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> == 1)
<a name="l00621"></a>00621                 {
<a name="l00622"></a>00622                     <span class="comment">//</span>
<a name="l00623"></a>00623                     <span class="comment">// Disable the use of uDMA.</span>
<a name="l00624"></a>00624                     <span class="comment">//</span>
<a name="l00625"></a>00625                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ab33983a1783bc5f7593f60ebf8975645" title="A flag that is true if uDMA used be used for the transfer.">bUseDMA</a> = <span class="keyword">false</span>;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627                     <span class="comment">//</span>
<a name="l00628"></a>00628                     <span class="comment">// Move to the read data end state to transfer the single</span>
<a name="l00629"></a>00629                     <span class="comment">// byte.  This uses PIO even if uDMA has been requested.</span>
<a name="l00630"></a>00630                     <span class="comment">//</span>
<a name="l00631"></a>00631                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga0a0a8dfd33eacde71dfa36beccd55673">STATE_READ_DATA_END</a>;
<a name="l00632"></a>00632                 }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634                 <span class="comment">//</span>
<a name="l00635"></a>00635                 <span class="comment">// See if uDMA has been requested for this transfer.</span>
<a name="l00636"></a>00636                 <span class="comment">//</span>
<a name="l00637"></a>00637                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ab33983a1783bc5f7593f60ebf8975645" title="A flag that is true if uDMA used be used for the transfer.">bUseDMA</a> || (pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> &lt; 4))
<a name="l00638"></a>00638                 {
<a name="l00639"></a>00639                     <span class="comment">//</span>
<a name="l00640"></a>00640                     <span class="comment">// Disable the use of uDMA.</span>
<a name="l00641"></a>00641                     <span class="comment">//</span>
<a name="l00642"></a>00642                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ab33983a1783bc5f7593f60ebf8975645" title="A flag that is true if uDMA used be used for the transfer.">bUseDMA</a> = <span class="keyword">false</span>;
<a name="l00643"></a>00643 
<a name="l00644"></a>00644                     <span class="comment">//</span>
<a name="l00645"></a>00645                     <span class="comment">// Move to the read data state.</span>
<a name="l00646"></a>00646                     <span class="comment">//</span>
<a name="l00647"></a>00647                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#gaad5e20feb263b09e1be1f48394fdb50a">STATE_READ_DATA</a>;
<a name="l00648"></a>00648                 }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650                 <span class="comment">//</span>
<a name="l00651"></a>00651                 <span class="comment">// This transfer should use uDMA.</span>
<a name="l00652"></a>00652                 <span class="comment">//</span>
<a name="l00653"></a>00653                 <span class="keywordflow">else</span>
<a name="l00654"></a>00654                 {
<a name="l00655"></a>00655                     <span class="comment">//</span>
<a name="l00656"></a>00656                     <span class="comment">// If the transfer is larger than 1024 bytes, enable the</span>
<a name="l00657"></a>00657                     <span class="comment">// uDMA receive complete interrupt which will be used to</span>
<a name="l00658"></a>00658                     <span class="comment">// move to the next block of the transfer.  Otherwise,</span>
<a name="l00659"></a>00659                     <span class="comment">// enable the uDMA transmit complete interrupt which will</span>
<a name="l00660"></a>00660                     <span class="comment">// be used to complete the transaction.</span>
<a name="l00661"></a>00661                     <span class="comment">//</span>
<a name="l00662"></a>00662                     <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> &gt; 1024)
<a name="l00663"></a>00663                     {
<a name="l00664"></a>00664                         <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) = <a class="code" href="hw__ssi_8h.html#ab5b00bc0dac2957c1e749feda9745280">SSI_IM_DMARXIM</a>;
<a name="l00665"></a>00665                     }
<a name="l00666"></a>00666                     <span class="keywordflow">else</span>
<a name="l00667"></a>00667                     {
<a name="l00668"></a>00668                         <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) = <a class="code" href="hw__ssi_8h.html#a061b9446afd7711c00e17fb127490c41">SSI_IM_DMATXIM</a>;
<a name="l00669"></a>00669                     }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671                     <span class="comment">//</span>
<a name="l00672"></a>00672                     <span class="comment">// Disable the uDMA channels.</span>
<a name="l00673"></a>00673                     <span class="comment">//</span>
<a name="l00674"></a>00674                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(<a class="code" href="hw__udma_8h.html#ad6083ee9273019db8454bc298c3673e0">UDMA_ENACLR</a>) = ((1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>) |
<a name="l00675"></a>00675                                           (1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a>));
<a name="l00676"></a>00676 
<a name="l00677"></a>00677                     <span class="comment">//</span>
<a name="l00678"></a>00678                     <span class="comment">// Configure the attributes for the transmit uDMA channel.</span>
<a name="l00679"></a>00679                     <span class="comment">//</span>
<a name="l00680"></a>00680                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(<a class="code" href="hw__udma_8h.html#a93b7ff36ae2aa59087166fc2445a5f86">UDMA_USEBURSTSET</a>) = ((1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>) |
<a name="l00681"></a>00681                                                (1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a>));
<a name="l00682"></a>00682                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(<a class="code" href="hw__udma_8h.html#a297a23ad50e4111b1fbd0690c4c4a1c2">UDMA_ALTCLR</a>) = ((1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>) |
<a name="l00683"></a>00683                                           (1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a>));
<a name="l00684"></a>00684                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(<a class="code" href="hw__udma_8h.html#a4551274bc3f8c607d10e7407030a043d">UDMA_PRIOCLR</a>) = 1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>;
<a name="l00685"></a>00685                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(<a class="code" href="hw__udma_8h.html#a616a171071e25adf3b2ffb37b3c4e31b">UDMA_PRIOSET</a>) = 1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a>;
<a name="l00686"></a>00686                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(<a class="code" href="hw__udma_8h.html#a9bf39ed430bce60aff19ce8115120751">UDMA_REQMASKCLR</a>) = ((1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>) |
<a name="l00687"></a>00687                                               (1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a>));
<a name="l00688"></a>00688 
<a name="l00689"></a>00689                     <span class="comment">//</span>
<a name="l00690"></a>00690                     <span class="comment">// Configure the control parameters of the uDMA channels.</span>
<a name="l00691"></a>00691                     <span class="comment">//</span>
<a name="l00692"></a>00692                     <a class="code" href="group__udma__api.html#ga6f73ab006ff6a593eeeb947130bbdf6f">uDMAChannelControlSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>,
<a name="l00693"></a>00693                                           <a class="code" href="udma_8h.html#ace9a62c226f2e73cc1a7c56d80efa361">UDMA_SRC_INC_NONE</a> |
<a name="l00694"></a>00694                                           <a class="code" href="udma_8h.html#aff850520540f2dd5ef6c016ac9bc85f8">UDMA_DST_INC_NONE</a> |
<a name="l00695"></a>00695                                           <a class="code" href="udma_8h.html#acfd5e57fa4a0c7e33d76c9f0f663c70e">UDMA_SIZE_8</a> | <a class="code" href="udma_8h.html#a06a426feec6bae050e1ceec32feb6524">UDMA_ARB_2</a>);
<a name="l00696"></a>00696                     <a class="code" href="group__udma__api.html#ga6f73ab006ff6a593eeeb947130bbdf6f">uDMAChannelControlSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a>,
<a name="l00697"></a>00697                                           <a class="code" href="udma_8h.html#ace9a62c226f2e73cc1a7c56d80efa361">UDMA_SRC_INC_NONE</a> |
<a name="l00698"></a>00698                                           <a class="code" href="udma_8h.html#a8df004d5dabcc2302bc3170f228d6a8e">UDMA_DST_INC_8</a> |
<a name="l00699"></a>00699                                           <a class="code" href="udma_8h.html#acfd5e57fa4a0c7e33d76c9f0f663c70e">UDMA_SIZE_8</a> | <a class="code" href="udma_8h.html#a54624c18043cb15f52b95faad3251f6d">UDMA_ARB_4</a>);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701                     <span class="comment">//</span>
<a name="l00702"></a>00702                     <span class="comment">// Configure the uDMA receive channel to transfer the first</span>
<a name="l00703"></a>00703                     <span class="comment">// portion of the data buffer.</span>
<a name="l00704"></a>00704                     <span class="comment">//</span>
<a name="l00705"></a>00705                     <a class="code" href="group__udma__api.html#ga938c21dc70cb6e11e6eb826de0fa21c3">uDMAChannelTransferSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a>,
<a name="l00706"></a>00706                                            <a class="code" href="udma_8h.html#a0d0916171d90267e53ad4c455f81ab85">UDMA_MODE_BASIC</a>,
<a name="l00707"></a>00707                                            (<span class="keywordtype">void</span> *)(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> +
<a name="l00708"></a>00708                                                     <a class="code" href="hw__ssi_8h.html#aeee45da597a7055c2b8468367cd8e920">SSI_O_DR</a>),
<a name="l00709"></a>00709                                            pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a>,
<a name="l00710"></a>00710                                            (pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> &gt;= 1024) ?
<a name="l00711"></a>00711                                            1024 : pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a>);
<a name="l00712"></a>00712 
<a name="l00713"></a>00713                     <span class="comment">//</span>
<a name="l00714"></a>00714                     <span class="comment">// Enable the uDMA receive channel.</span>
<a name="l00715"></a>00715                     <span class="comment">//</span>
<a name="l00716"></a>00716                     <a class="code" href="group__udma__api.html#ga41e21189773539bbc5f302863cd5bf06">uDMAChannelEnable</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a>);
<a name="l00717"></a>00717 
<a name="l00718"></a>00718                     <span class="comment">//</span>
<a name="l00719"></a>00719                     <span class="comment">// Configure the uDMA channel to transfer the dummy bytes</span>
<a name="l00720"></a>00720                     <span class="comment">// for the first portion of the data buffer.  The last</span>
<a name="l00721"></a>00721                     <span class="comment">// dummy byte will not be included since it must be treated</span>
<a name="l00722"></a>00722                     <span class="comment">// special.</span>
<a name="l00723"></a>00723                     <span class="comment">//</span>
<a name="l00724"></a>00724                     <a class="code" href="group__udma__api.html#ga938c21dc70cb6e11e6eb826de0fa21c3">uDMAChannelTransferSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>,
<a name="l00725"></a>00725                                            <a class="code" href="udma_8h.html#a0d0916171d90267e53ad4c455f81ab85">UDMA_MODE_BASIC</a>,
<a name="l00726"></a>00726                                            pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a>,
<a name="l00727"></a>00727                                            (<span class="keywordtype">void</span> *)(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> +
<a name="l00728"></a>00728                                                     <a class="code" href="hw__ssi_8h.html#aeee45da597a7055c2b8468367cd8e920">SSI_O_DR</a>),
<a name="l00729"></a>00729                                            (pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> &gt; 1024) ?
<a name="l00730"></a>00730                                            1024 : pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> - 1);
<a name="l00731"></a>00731 
<a name="l00732"></a>00732                     <span class="comment">//</span>
<a name="l00733"></a>00733                     <span class="comment">// Enable the uDMA transmit channel.</span>
<a name="l00734"></a>00734                     <span class="comment">//</span>
<a name="l00735"></a>00735                     <a class="code" href="group__udma__api.html#ga41e21189773539bbc5f302863cd5bf06">uDMAChannelEnable</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>);
<a name="l00736"></a>00736 
<a name="l00737"></a>00737                     <span class="comment">//</span>
<a name="l00738"></a>00738                     <span class="comment">// Clear any previously pending uDMA completion interrupt.</span>
<a name="l00739"></a>00739                     <span class="comment">//</span>
<a name="l00740"></a>00740                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#aaf63879f2c29b6fd6d9903153dd4271a">SSI_O_ICR</a>) = <a class="code" href="hw__ssi_8h.html#a954860482fa17ad95cd0d4cb44fda84b">SSI_ICR_DMARXIC</a>;
<a name="l00741"></a>00741 
<a name="l00742"></a>00742                     <span class="comment">//</span>
<a name="l00743"></a>00743                     <span class="comment">// Enable uDMA transmit and receive in the SSI module.</span>
<a name="l00744"></a>00744                     <span class="comment">//</span>
<a name="l00745"></a>00745                     <a class="code" href="rom__map_8h.html#a2afd24398ee80ff8864f68c470c0e9b5">MAP_SSIDMAEnable</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>,
<a name="l00746"></a>00746                                      <a class="code" href="ssi_8h.html#a90f31eb354206da6173911200ba7d2cb">SSI_DMA_TX</a> | <a class="code" href="ssi_8h.html#acad5d21da630367195b15fe80be03a64">SSI_DMA_RX</a>);
<a name="l00747"></a>00747 
<a name="l00748"></a>00748                     <span class="comment">//</span>
<a name="l00749"></a>00749                     <span class="comment">// Move to the uDMA data read state.</span>
<a name="l00750"></a>00750                     <span class="comment">//</span>
<a name="l00751"></a>00751                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga91b29ddde291ec8eb0a75b7d1aa119f9">STATE_READ_DATA_DMA</a>;
<a name="l00752"></a>00752                 }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754                 <span class="comment">//</span>
<a name="l00755"></a>00755                 <span class="comment">// Done with this state.</span>
<a name="l00756"></a>00756                 <span class="comment">//</span>
<a name="l00757"></a>00757                 <span class="keywordflow">break</span>;
<a name="l00758"></a>00758             }
<a name="l00759"></a>00759 
<a name="l00760"></a>00760             <span class="comment">//</span>
<a name="l00761"></a>00761             <span class="comment">// The state machine is in the read data state.</span>
<a name="l00762"></a>00762             <span class="comment">//</span>
<a name="l00763"></a>00763             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#gaad5e20feb263b09e1be1f48394fdb50a">STATE_READ_DATA</a>:
<a name="l00764"></a>00764             {
<a name="l00765"></a>00765                 <span class="comment">//</span>
<a name="l00766"></a>00766                 <span class="comment">// Loop while there is more than one byte left to write.</span>
<a name="l00767"></a>00767                 <span class="comment">//</span>
<a name="l00768"></a>00768                 <span class="keywordflow">while</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> != 1)
<a name="l00769"></a>00769                 {
<a name="l00770"></a>00770                     <span class="comment">//</span>
<a name="l00771"></a>00771                     <span class="comment">// Dummy bytes are written into the FIFO in order to</span>
<a name="l00772"></a>00772                     <span class="comment">// trigger the read operation.  Attempt to write another</span>
<a name="l00773"></a>00773                     <span class="comment">// dummy byte into the FIFO.</span>
<a name="l00774"></a>00774                     <span class="comment">//</span>
<a name="l00775"></a>00775                     <span class="keywordflow">if</span>(ui32Count == 0)
<a name="l00776"></a>00776                     {
<a name="l00777"></a>00777                         <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00778"></a>00778                     }
<a name="l00779"></a>00779                     <span class="keywordflow">if</span>(<a class="code" href="rom__map_8h.html#a8c46066183d1c49c10582b59490607a7">MAP_SSIDataPutNonBlocking</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>, 0) == 0)
<a name="l00780"></a>00780                     {
<a name="l00781"></a>00781                         <span class="comment">//</span>
<a name="l00782"></a>00782                         <span class="comment">// The dummy byte could not be written, so return</span>
<a name="l00783"></a>00783                         <span class="comment">// indicating that the transfer is still in progress.</span>
<a name="l00784"></a>00784                         <span class="comment">//</span>
<a name="l00785"></a>00785                         <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00786"></a>00786                     }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788                     <span class="comment">//</span>
<a name="l00789"></a>00789                     <span class="comment">// Decrement the count of dummy bytes to write.</span>
<a name="l00790"></a>00790                     <span class="comment">//</span>
<a name="l00791"></a>00791                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a>--;
<a name="l00792"></a>00792 
<a name="l00793"></a>00793                     <span class="comment">//</span>
<a name="l00794"></a>00794                     <span class="comment">// Decrement the count of bytes that have been written.</span>
<a name="l00795"></a>00795                     <span class="comment">//</span>
<a name="l00796"></a>00796                     ui32Count--;
<a name="l00797"></a>00797                 }
<a name="l00798"></a>00798 
<a name="l00799"></a>00799                 <span class="comment">//</span>
<a name="l00800"></a>00800                 <span class="comment">// Move to the read data end state.</span>
<a name="l00801"></a>00801                 <span class="comment">//</span>
<a name="l00802"></a>00802                 pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga0a0a8dfd33eacde71dfa36beccd55673">STATE_READ_DATA_END</a>;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804                 <span class="comment">//</span>
<a name="l00805"></a>00805                 <span class="comment">// Done with this state.</span>
<a name="l00806"></a>00806                 <span class="comment">//</span>
<a name="l00807"></a>00807                 <span class="keywordflow">break</span>;
<a name="l00808"></a>00808             }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810             <span class="comment">//</span>
<a name="l00811"></a>00811             <span class="comment">// The state machine is in the uDMA read data state.</span>
<a name="l00812"></a>00812             <span class="comment">//</span>
<a name="l00813"></a>00813             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#ga91b29ddde291ec8eb0a75b7d1aa119f9">STATE_READ_DATA_DMA</a>:
<a name="l00814"></a>00814             {
<a name="l00815"></a>00815                 <span class="comment">//</span>
<a name="l00816"></a>00816                 <span class="comment">// See if the write count is greater than one.</span>
<a name="l00817"></a>00817                 <span class="comment">//</span>
<a name="l00818"></a>00818                 <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> &gt; 1)
<a name="l00819"></a>00819                 {
<a name="l00820"></a>00820                     <span class="comment">//</span>
<a name="l00821"></a>00821                     <span class="comment">// Return indicating that the transfer is still in</span>
<a name="l00822"></a>00822                     <span class="comment">// progress.</span>
<a name="l00823"></a>00823                     <span class="comment">//</span>
<a name="l00824"></a>00824                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00825"></a>00825                 }
<a name="l00826"></a>00826 
<a name="l00827"></a>00827                 <span class="comment">//</span>
<a name="l00828"></a>00828                 <span class="comment">// Disable uDMA transmit in the SSI module.</span>
<a name="l00829"></a>00829                 <span class="comment">//</span>
<a name="l00830"></a>00830                 <a class="code" href="rom__map_8h.html#a07161e7fa7b8499571fcc680d3bbd527">MAP_SSIDMADisable</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>, <a class="code" href="ssi_8h.html#a90f31eb354206da6173911200ba7d2cb">SSI_DMA_TX</a>);
<a name="l00831"></a>00831 
<a name="l00832"></a>00832                 <span class="comment">//</span>
<a name="l00833"></a>00833                 <span class="comment">// Enable the uDMA receive done and FIFO transmit interrupt.</span>
<a name="l00834"></a>00834                 <span class="comment">//</span>
<a name="l00835"></a>00835                 <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) =
<a name="l00836"></a>00836                     <a class="code" href="hw__ssi_8h.html#ab5b00bc0dac2957c1e749feda9745280">SSI_IM_DMARXIM</a> | <a class="code" href="hw__ssi_8h.html#a22cc1ee908ec15a4ae5cec1f77195b53">SSI_IM_TXIM</a>;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838                 <span class="comment">//</span>
<a name="l00839"></a>00839                 <span class="comment">// Move to the read data end state.</span>
<a name="l00840"></a>00840                 <span class="comment">//</span>
<a name="l00841"></a>00841                 pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga0a0a8dfd33eacde71dfa36beccd55673">STATE_READ_DATA_END</a>;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843                 <span class="comment">//</span>
<a name="l00844"></a>00844                 <span class="comment">// Done with this state.</span>
<a name="l00845"></a>00845                 <span class="comment">//</span>
<a name="l00846"></a>00846                 <span class="keywordflow">break</span>;
<a name="l00847"></a>00847             }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849             <span class="comment">//</span>
<a name="l00850"></a>00850             <span class="comment">// The state machine is in the data read end state.</span>
<a name="l00851"></a>00851             <span class="comment">//</span>
<a name="l00852"></a>00852             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#ga0a0a8dfd33eacde71dfa36beccd55673">STATE_READ_DATA_END</a>:
<a name="l00853"></a>00853             {
<a name="l00854"></a>00854                 <span class="comment">//</span>
<a name="l00855"></a>00855                 <span class="comment">// See if the final dummy byte still needs to be written.</span>
<a name="l00856"></a>00856                 <span class="comment">//</span>
<a name="l00857"></a>00857                 <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> != 0)
<a name="l00858"></a>00858                 {
<a name="l00859"></a>00859                     <span class="comment">//</span>
<a name="l00860"></a>00860                     <span class="comment">// Attempt to write the final dummy byte into the FIFO and</span>
<a name="l00861"></a>00861                     <span class="comment">// mark it as the end of the frame.</span>
<a name="l00862"></a>00862                     <span class="comment">//</span>
<a name="l00863"></a>00863                     <span class="keywordflow">if</span>(ui32Count == 0)
<a name="l00864"></a>00864                     {
<a name="l00865"></a>00865                         <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00866"></a>00866                     }
<a name="l00867"></a>00867                     <span class="keywordflow">if</span>(<a class="code" href="rom__map_8h.html#aed0a08c7007456819f7e6ddc22ddeaba">MAP_SSIAdvDataPutFrameEndNonBlocking</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>,
<a name="l00868"></a>00868                                                             0) == 0)
<a name="l00869"></a>00869                     {
<a name="l00870"></a>00870                         <span class="comment">//</span>
<a name="l00871"></a>00871                         <span class="comment">// The dummy byte could not be written, so return</span>
<a name="l00872"></a>00872                         <span class="comment">// indicating that the transfer is still in progress.</span>
<a name="l00873"></a>00873                         <span class="comment">//</span>
<a name="l00874"></a>00874                         <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00875"></a>00875                     }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877                     <span class="comment">//</span>
<a name="l00878"></a>00878                     <span class="comment">// The write portion of the transfer has completed.</span>
<a name="l00879"></a>00879                     <span class="comment">//</span>
<a name="l00880"></a>00880                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> = 0;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882                     <span class="comment">//</span>
<a name="l00883"></a>00883                     <span class="comment">// Disable the transmit interrupt now that the write</span>
<a name="l00884"></a>00884                     <span class="comment">// write portion of the transfer has completed.</span>
<a name="l00885"></a>00885                     <span class="comment">//</span>
<a name="l00886"></a>00886                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) &amp;= ~(<a class="code" href="hw__ssi_8h.html#a22cc1ee908ec15a4ae5cec1f77195b53">SSI_IM_TXIM</a>);
<a name="l00887"></a>00887                 }
<a name="l00888"></a>00888 
<a name="l00889"></a>00889                 <span class="comment">//</span>
<a name="l00890"></a>00890                 <span class="comment">// Return indicating that the transfer is still in progress if</span>
<a name="l00891"></a>00891                 <span class="comment">// there are still data bytes to be read.</span>
<a name="l00892"></a>00892                 <span class="comment">//</span>
<a name="l00893"></a>00893                 <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> != 0)
<a name="l00894"></a>00894                 {
<a name="l00895"></a>00895                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l00896"></a>00896                 }
<a name="l00897"></a>00897 
<a name="l00898"></a>00898                 <span class="comment">//</span>
<a name="l00899"></a>00899                 <span class="comment">// Disable uDMA receive in the SSI module.</span>
<a name="l00900"></a>00900                 <span class="comment">//</span>
<a name="l00901"></a>00901                 <a class="code" href="rom__map_8h.html#a07161e7fa7b8499571fcc680d3bbd527">MAP_SSIDMADisable</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>, <a class="code" href="ssi_8h.html#acad5d21da630367195b15fe80be03a64">SSI_DMA_RX</a>);
<a name="l00902"></a>00902 
<a name="l00903"></a>00903                 <span class="comment">//</span>
<a name="l00904"></a>00904                 <span class="comment">// The transfer is complete, so disable all interrupts.</span>
<a name="l00905"></a>00905                 <span class="comment">//</span>
<a name="l00906"></a>00906                 <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) = 0;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908                 <span class="comment">//</span>
<a name="l00909"></a>00909                 <span class="comment">// Move to the idle state.</span>
<a name="l00910"></a>00910                 <span class="comment">//</span>
<a name="l00911"></a>00911                 pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#gaafff27c7165f059a969fe60fee51f683">STATE_IDLE</a>;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913                 <span class="comment">//</span>
<a name="l00914"></a>00914                 <span class="comment">// Return indicating that the transfer has completed.</span>
<a name="l00915"></a>00915                 <span class="comment">//</span>
<a name="l00916"></a>00916                 <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#aca3e474ded3319802c56c082e198903c">SPI_FLASH_DONE</a>);
<a name="l00917"></a>00917             }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919             <span class="comment">//</span>
<a name="l00920"></a>00920             <span class="comment">// The state machine is in the write data setup state.</span>
<a name="l00921"></a>00921             <span class="comment">//</span>
<a name="l00922"></a>00922             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#ga75f5fdfe876583fac9954464e1bdacae">STATE_WRITE_DATA_SETUP</a>:
<a name="l00923"></a>00923             {
<a name="l00924"></a>00924                 <span class="comment">//</span>
<a name="l00925"></a>00925                 <span class="comment">// See if a single data byte is being transferred.</span>
<a name="l00926"></a>00926                 <span class="comment">//</span>
<a name="l00927"></a>00927                 <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> == 1)
<a name="l00928"></a>00928                 {
<a name="l00929"></a>00929                     <span class="comment">//</span>
<a name="l00930"></a>00930                     <span class="comment">// Disable the use of uDMA.</span>
<a name="l00931"></a>00931                     <span class="comment">//</span>
<a name="l00932"></a>00932                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ab33983a1783bc5f7593f60ebf8975645" title="A flag that is true if uDMA used be used for the transfer.">bUseDMA</a> = <span class="keyword">false</span>;
<a name="l00933"></a>00933 
<a name="l00934"></a>00934                     <span class="comment">//</span>
<a name="l00935"></a>00935                     <span class="comment">// Move to the write data end state to transfer the single</span>
<a name="l00936"></a>00936                     <span class="comment">// byte.  This uses PIO even if uDMA has been requested.</span>
<a name="l00937"></a>00937                     <span class="comment">//</span>
<a name="l00938"></a>00938                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga6b1d1c61ab08460db62fe8441f7882ee">STATE_WRITE_DATA_END</a>;
<a name="l00939"></a>00939                 }
<a name="l00940"></a>00940 
<a name="l00941"></a>00941                 <span class="comment">//</span>
<a name="l00942"></a>00942                 <span class="comment">// See if uDMA has been requested for this transfer.</span>
<a name="l00943"></a>00943                 <span class="comment">//</span>
<a name="l00944"></a>00944                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ab33983a1783bc5f7593f60ebf8975645" title="A flag that is true if uDMA used be used for the transfer.">bUseDMA</a> || (pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> &lt; 4))
<a name="l00945"></a>00945                 {
<a name="l00946"></a>00946                     <span class="comment">//</span>
<a name="l00947"></a>00947                     <span class="comment">// Disable the use of uDMA.</span>
<a name="l00948"></a>00948                     <span class="comment">//</span>
<a name="l00949"></a>00949                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ab33983a1783bc5f7593f60ebf8975645" title="A flag that is true if uDMA used be used for the transfer.">bUseDMA</a> = <span class="keyword">false</span>;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951                     <span class="comment">//</span>
<a name="l00952"></a>00952                     <span class="comment">// uDMA is not being used, so move to the write data state.</span>
<a name="l00953"></a>00953                     <span class="comment">//</span>
<a name="l00954"></a>00954                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga76d26adac52cf8bd900415b001591008">STATE_WRITE_DATA</a>;
<a name="l00955"></a>00955                 }
<a name="l00956"></a>00956 
<a name="l00957"></a>00957                 <span class="comment">//</span>
<a name="l00958"></a>00958                 <span class="comment">// This transfer should use uDMA.</span>
<a name="l00959"></a>00959                 <span class="comment">//</span>
<a name="l00960"></a>00960                 <span class="keywordflow">else</span>
<a name="l00961"></a>00961                 {
<a name="l00962"></a>00962                     <span class="comment">//</span>
<a name="l00963"></a>00963                     <span class="comment">// Enable the uDMA transmit complete interrupt.</span>
<a name="l00964"></a>00964                     <span class="comment">//</span>
<a name="l00965"></a>00965                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) = <a class="code" href="hw__ssi_8h.html#a061b9446afd7711c00e17fb127490c41">SSI_IM_DMATXIM</a>;
<a name="l00966"></a>00966 
<a name="l00967"></a>00967                     <span class="comment">//</span>
<a name="l00968"></a>00968                     <span class="comment">// Disable the transmit uDMA channel.</span>
<a name="l00969"></a>00969                     <span class="comment">//</span>
<a name="l00970"></a>00970                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(<a class="code" href="hw__udma_8h.html#ad6083ee9273019db8454bc298c3673e0">UDMA_ENACLR</a>) = 1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>;
<a name="l00971"></a>00971 
<a name="l00972"></a>00972                     <span class="comment">//</span>
<a name="l00973"></a>00973                     <span class="comment">// Configure the attributes for the transmit uDMA channel.</span>
<a name="l00974"></a>00974                     <span class="comment">//</span>
<a name="l00975"></a>00975                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(<a class="code" href="hw__udma_8h.html#a93b7ff36ae2aa59087166fc2445a5f86">UDMA_USEBURSTSET</a>) = 1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>;
<a name="l00976"></a>00976                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(<a class="code" href="hw__udma_8h.html#a297a23ad50e4111b1fbd0690c4c4a1c2">UDMA_ALTCLR</a>) = 1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>;
<a name="l00977"></a>00977                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(<a class="code" href="hw__udma_8h.html#a4551274bc3f8c607d10e7407030a043d">UDMA_PRIOCLR</a>) = 1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>;
<a name="l00978"></a>00978                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(<a class="code" href="hw__udma_8h.html#a9bf39ed430bce60aff19ce8115120751">UDMA_REQMASKCLR</a>) = 1 &lt;&lt; pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>;
<a name="l00979"></a>00979 
<a name="l00980"></a>00980                     <span class="comment">//</span>
<a name="l00981"></a>00981                     <span class="comment">// Configure the control parameters of the uDMA channel.</span>
<a name="l00982"></a>00982                     <span class="comment">//</span>
<a name="l00983"></a>00983                     <a class="code" href="group__udma__api.html#ga6f73ab006ff6a593eeeb947130bbdf6f">uDMAChannelControlSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>,
<a name="l00984"></a>00984                                           <a class="code" href="udma_8h.html#a3a2ecfdeedc93963d2c5b6dcf3598d80">UDMA_SRC_INC_8</a> |
<a name="l00985"></a>00985                                           <a class="code" href="udma_8h.html#aff850520540f2dd5ef6c016ac9bc85f8">UDMA_DST_INC_NONE</a> |
<a name="l00986"></a>00986                                           <a class="code" href="udma_8h.html#acfd5e57fa4a0c7e33d76c9f0f663c70e">UDMA_SIZE_8</a> | <a class="code" href="udma_8h.html#a54624c18043cb15f52b95faad3251f6d">UDMA_ARB_4</a>);
<a name="l00987"></a>00987 
<a name="l00988"></a>00988                     <span class="comment">//</span>
<a name="l00989"></a>00989                     <span class="comment">// Configure the uDMA channel to transfer the next portion</span>
<a name="l00990"></a>00990                     <span class="comment">// of the data buffer.  The last byte in the buffer will</span>
<a name="l00991"></a>00991                     <span class="comment">// not be included since it must be treated special.</span>
<a name="l00992"></a>00992                     <span class="comment">//</span>
<a name="l00993"></a>00993                     <a class="code" href="group__udma__api.html#ga938c21dc70cb6e11e6eb826de0fa21c3">uDMAChannelTransferSet</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>,
<a name="l00994"></a>00994                                            <a class="code" href="udma_8h.html#a0d0916171d90267e53ad4c455f81ab85">UDMA_MODE_BASIC</a>,
<a name="l00995"></a>00995                                            pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a>,
<a name="l00996"></a>00996                                            (<span class="keywordtype">void</span> *)(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> +
<a name="l00997"></a>00997                                                     <a class="code" href="hw__ssi_8h.html#aeee45da597a7055c2b8468367cd8e920">SSI_O_DR</a>),
<a name="l00998"></a>00998                                            (pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> &gt; 1024) ?
<a name="l00999"></a>00999                                            1024 : pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> - 1);
<a name="l01000"></a>01000 
<a name="l01001"></a>01001                     <span class="comment">//</span>
<a name="l01002"></a>01002                     <span class="comment">// Enable the uDMA transmit channel.</span>
<a name="l01003"></a>01003                     <span class="comment">//</span>
<a name="l01004"></a>01004                     <a class="code" href="group__udma__api.html#ga41e21189773539bbc5f302863cd5bf06">uDMAChannelEnable</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a>);
<a name="l01005"></a>01005                     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#aaf63879f2c29b6fd6d9903153dd4271a">SSI_O_ICR</a>) = <a class="code" href="hw__ssi_8h.html#a873e573501798cee815d0e810979e579">SSI_ICR_DMATXIC</a>;
<a name="l01006"></a>01006 
<a name="l01007"></a>01007                     <span class="comment">//</span>
<a name="l01008"></a>01008                     <span class="comment">// Enable uDMA in the SSI module.</span>
<a name="l01009"></a>01009                     <span class="comment">//</span>
<a name="l01010"></a>01010                     <a class="code" href="rom__map_8h.html#a2afd24398ee80ff8864f68c470c0e9b5">MAP_SSIDMAEnable</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>, <a class="code" href="ssi_8h.html#a90f31eb354206da6173911200ba7d2cb">SSI_DMA_TX</a>);
<a name="l01011"></a>01011 
<a name="l01012"></a>01012                     <span class="comment">//</span>
<a name="l01013"></a>01013                     <span class="comment">// Move to the uDMA data write state.</span>
<a name="l01014"></a>01014                     <span class="comment">//</span>
<a name="l01015"></a>01015                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga2a54f197080ab88952cb98579bf86d9e">STATE_WRITE_DATA_DMA</a>;
<a name="l01016"></a>01016                 }
<a name="l01017"></a>01017 
<a name="l01018"></a>01018                 <span class="comment">//</span>
<a name="l01019"></a>01019                 <span class="comment">// Done with this state.</span>
<a name="l01020"></a>01020                 <span class="comment">//</span>
<a name="l01021"></a>01021                 <span class="keywordflow">break</span>;
<a name="l01022"></a>01022             }
<a name="l01023"></a>01023 
<a name="l01024"></a>01024             <span class="comment">//</span>
<a name="l01025"></a>01025             <span class="comment">// The state machine is in the write data state.</span>
<a name="l01026"></a>01026             <span class="comment">//</span>
<a name="l01027"></a>01027             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#ga76d26adac52cf8bd900415b001591008">STATE_WRITE_DATA</a>:
<a name="l01028"></a>01028             {
<a name="l01029"></a>01029                 <span class="comment">//</span>
<a name="l01030"></a>01030                 <span class="comment">// Loop while there is more than one byte left to write.</span>
<a name="l01031"></a>01031                 <span class="comment">//</span>
<a name="l01032"></a>01032                 <span class="keywordflow">while</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> != 1)
<a name="l01033"></a>01033                 {
<a name="l01034"></a>01034                     <span class="comment">//</span>
<a name="l01035"></a>01035                     <span class="comment">// Attempt to write the next data byte into the FIFO.</span>
<a name="l01036"></a>01036                     <span class="comment">//</span>
<a name="l01037"></a>01037                     <span class="keywordflow">if</span>(ui32Count == 0)
<a name="l01038"></a>01038                     {
<a name="l01039"></a>01039                         <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l01040"></a>01040                     }
<a name="l01041"></a>01041                     <span class="keywordflow">if</span>(<a class="code" href="rom__map_8h.html#a8c46066183d1c49c10582b59490607a7">MAP_SSIDataPutNonBlocking</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>,
<a name="l01042"></a>01042                                                  *(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a>)) == 0)
<a name="l01043"></a>01043                     {
<a name="l01044"></a>01044                         <span class="comment">//</span>
<a name="l01045"></a>01045                         <span class="comment">// The next data byte could not be written, so return</span>
<a name="l01046"></a>01046                         <span class="comment">// indicating that the transfer is still in progress.</span>
<a name="l01047"></a>01047                         <span class="comment">//</span>
<a name="l01048"></a>01048                         <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l01049"></a>01049                     }
<a name="l01050"></a>01050 
<a name="l01051"></a>01051                     <span class="comment">//</span>
<a name="l01052"></a>01052                     <span class="comment">// Increment the buffer pointer and decrement the byte</span>
<a name="l01053"></a>01053                     <span class="comment">// count.</span>
<a name="l01054"></a>01054                     <span class="comment">//</span>
<a name="l01055"></a>01055                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a>++;
<a name="l01056"></a>01056                     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a>--;
<a name="l01057"></a>01057 
<a name="l01058"></a>01058                     <span class="comment">//</span>
<a name="l01059"></a>01059                     <span class="comment">// Decrement the count of bytes that have been written.</span>
<a name="l01060"></a>01060                     <span class="comment">//</span>
<a name="l01061"></a>01061                     ui32Count--;
<a name="l01062"></a>01062                 }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064                 <span class="comment">//</span>
<a name="l01065"></a>01065                 <span class="comment">// Move to the write data end state.</span>
<a name="l01066"></a>01066                 <span class="comment">//</span>
<a name="l01067"></a>01067                 pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga6b1d1c61ab08460db62fe8441f7882ee">STATE_WRITE_DATA_END</a>;
<a name="l01068"></a>01068 
<a name="l01069"></a>01069                 <span class="comment">//</span>
<a name="l01070"></a>01070                 <span class="comment">// Done with this state.</span>
<a name="l01071"></a>01071                 <span class="comment">//</span>
<a name="l01072"></a>01072                 <span class="keywordflow">break</span>;
<a name="l01073"></a>01073             }
<a name="l01074"></a>01074 
<a name="l01075"></a>01075             <span class="comment">//</span>
<a name="l01076"></a>01076             <span class="comment">// The state machine is in the uDMA write data state.</span>
<a name="l01077"></a>01077             <span class="comment">//</span>
<a name="l01078"></a>01078             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#ga2a54f197080ab88952cb98579bf86d9e">STATE_WRITE_DATA_DMA</a>:
<a name="l01079"></a>01079             {
<a name="l01080"></a>01080                 <span class="comment">//</span>
<a name="l01081"></a>01081                 <span class="comment">// See if the write count is greater than one.</span>
<a name="l01082"></a>01082                 <span class="comment">//</span>
<a name="l01083"></a>01083                 <span class="keywordflow">if</span>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> &gt; 1)
<a name="l01084"></a>01084                 {
<a name="l01085"></a>01085                     <span class="comment">//</span>
<a name="l01086"></a>01086                     <span class="comment">// Return indicating that the transfer is still in</span>
<a name="l01087"></a>01087                     <span class="comment">// progress.</span>
<a name="l01088"></a>01088                     <span class="comment">//</span>
<a name="l01089"></a>01089                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l01090"></a>01090                 }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092                 <span class="comment">//</span>
<a name="l01093"></a>01093                 <span class="comment">// Disable uDMA in the SSI module.</span>
<a name="l01094"></a>01094                 <span class="comment">//</span>
<a name="l01095"></a>01095                 <a class="code" href="rom__map_8h.html#a07161e7fa7b8499571fcc680d3bbd527">MAP_SSIDMADisable</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>, <a class="code" href="ssi_8h.html#a90f31eb354206da6173911200ba7d2cb">SSI_DMA_TX</a>);
<a name="l01096"></a>01096 
<a name="l01097"></a>01097                 <span class="comment">//</span>
<a name="l01098"></a>01098                 <span class="comment">// Disable the uDMA transmit complete interrupt and enable the</span>
<a name="l01099"></a>01099                 <span class="comment">// FIFO interrupt.</span>
<a name="l01100"></a>01100                 <span class="comment">//</span>
<a name="l01101"></a>01101                 <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) = <a class="code" href="hw__ssi_8h.html#a22cc1ee908ec15a4ae5cec1f77195b53">SSI_IM_TXIM</a>;
<a name="l01102"></a>01102 
<a name="l01103"></a>01103                 <span class="comment">//</span>
<a name="l01104"></a>01104                 <span class="comment">// Move to the write data end state.</span>
<a name="l01105"></a>01105                 <span class="comment">//</span>
<a name="l01106"></a>01106                 pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga6b1d1c61ab08460db62fe8441f7882ee">STATE_WRITE_DATA_END</a>;
<a name="l01107"></a>01107 
<a name="l01108"></a>01108                 <span class="comment">//</span>
<a name="l01109"></a>01109                 <span class="comment">// Done with this state.</span>
<a name="l01110"></a>01110                 <span class="comment">//</span>
<a name="l01111"></a>01111                 <span class="keywordflow">break</span>;
<a name="l01112"></a>01112             }
<a name="l01113"></a>01113 
<a name="l01114"></a>01114             <span class="comment">//</span>
<a name="l01115"></a>01115             <span class="comment">// The state machine is in the write data end state.</span>
<a name="l01116"></a>01116             <span class="comment">//</span>
<a name="l01117"></a>01117             <span class="keywordflow">case</span> <a class="code" href="group__spi__flash__api.html#ga6b1d1c61ab08460db62fe8441f7882ee">STATE_WRITE_DATA_END</a>:
<a name="l01118"></a>01118             {
<a name="l01119"></a>01119                 <span class="comment">//</span>
<a name="l01120"></a>01120                 <span class="comment">// Attempt to write the final data byte into the FIFO.</span>
<a name="l01121"></a>01121                 <span class="comment">//</span>
<a name="l01122"></a>01122                 <span class="keywordflow">if</span>(<a class="code" href="rom__map_8h.html#aed0a08c7007456819f7e6ddc22ddeaba">MAP_SSIAdvDataPutFrameEndNonBlocking</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a>,
<a name="l01123"></a>01123                                                       *(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a>)) ==
<a name="l01124"></a>01124                    0)
<a name="l01125"></a>01125                 {
<a name="l01126"></a>01126                     <span class="comment">//</span>
<a name="l01127"></a>01127                     <span class="comment">// The final data byte could not be written, so return</span>
<a name="l01128"></a>01128                     <span class="comment">// indicating that the transfer is still in progress.</span>
<a name="l01129"></a>01129                     <span class="comment">//</span>
<a name="l01130"></a>01130                     <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#ae368a0a3d565b6e96aeb09c7ee4db481">SPI_FLASH_WORKING</a>);
<a name="l01131"></a>01131                 }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133                 <span class="comment">//</span>
<a name="l01134"></a>01134                 <span class="comment">// The transfer is complete, so disable all interrupts.</span>
<a name="l01135"></a>01135                 <span class="comment">//</span>
<a name="l01136"></a>01136                 <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) = 0;
<a name="l01137"></a>01137 
<a name="l01138"></a>01138                 <span class="comment">//</span>
<a name="l01139"></a>01139                 <span class="comment">// Move to the idle state.</span>
<a name="l01140"></a>01140                 <span class="comment">//</span>
<a name="l01141"></a>01141                 pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#gaafff27c7165f059a969fe60fee51f683">STATE_IDLE</a>;
<a name="l01142"></a>01142 
<a name="l01143"></a>01143                 <span class="comment">//</span>
<a name="l01144"></a>01144                 <span class="comment">// Return indicating that the transfer has completed.</span>
<a name="l01145"></a>01145                 <span class="comment">//</span>
<a name="l01146"></a>01146                 <span class="keywordflow">return</span>(<a class="code" href="spi__flash_8h.html#aca3e474ded3319802c56c082e198903c">SPI_FLASH_DONE</a>);
<a name="l01147"></a>01147             }
<a name="l01148"></a>01148         }
<a name="l01149"></a>01149     }
<a name="l01150"></a>01150 }
<a name="l01151"></a>01151 
<a name="l01152"></a>01152 <span class="comment">//*****************************************************************************</span>
<a name="l01153"></a>01153 <span class="comment">//</span>
<a name="l01171"></a>01171 <span class="comment"></span><span class="comment">//</span>
<a name="l01172"></a>01172 <span class="comment">//*****************************************************************************</span>
<a name="l01173"></a>01173 <span class="keywordtype">void</span>
<a name="l01174"></a><a class="code" href="group__spi__flash__api.html#ga39a63f47dbd0d32d90990b2010684c13">01174</a> <a class="code" href="group__spi__flash__api.html#ga39a63f47dbd0d32d90990b2010684c13">SPIFlashInit</a>(uint32_t ui32Base, uint32_t ui32Clock, uint32_t ui32BitRate)
<a name="l01175"></a>01175 {
<a name="l01176"></a>01176     <span class="comment">//</span>
<a name="l01177"></a>01177     <span class="comment">// Configure the SPI module.</span>
<a name="l01178"></a>01178     <span class="comment">//</span>
<a name="l01179"></a>01179     <a class="code" href="rom__map_8h.html#a8b3859fa774e2ad6f31aad1f8644c03d">MAP_SSIConfigSetExpClk</a>(ui32Base, ui32Clock, <a class="code" href="ssi_8h.html#a510fb7c5fbaa13005b174e144eb29260">SSI_FRF_MOTO_MODE_0</a>,
<a name="l01180"></a>01180                            <a class="code" href="ssi_8h.html#a56dae2de51b66a6533a27e858bc76fe9">SSI_MODE_MASTER</a>, ui32BitRate, 8);
<a name="l01181"></a>01181 
<a name="l01182"></a>01182     <span class="comment">//</span>
<a name="l01183"></a>01183     <span class="comment">// Enable the advanced mode of operation, defaulting to read/write mode.</span>
<a name="l01184"></a>01184     <span class="comment">//</span>
<a name="l01185"></a>01185     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#a3b381e1d2c940e29363b2e12591f9a0b">SSI_ADV_MODE_READ_WRITE</a>);
<a name="l01186"></a>01186 
<a name="l01187"></a>01187     <span class="comment">//</span>
<a name="l01188"></a>01188     <span class="comment">// Enable the frame hold feature.</span>
<a name="l01189"></a>01189     <span class="comment">//</span>
<a name="l01190"></a>01190     <a class="code" href="rom__map_8h.html#a565341d92d0eaebda9f9d911602688ce">MAP_SSIAdvFrameHoldEnable</a>(ui32Base);
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     <span class="comment">//</span>
<a name="l01193"></a>01193     <span class="comment">// Enable the SPI module.</span>
<a name="l01194"></a>01194     <span class="comment">//</span>
<a name="l01195"></a>01195     <a class="code" href="rom__map_8h.html#ab92ada8d1854704fdf4c8b58ac687f2a">MAP_SSIEnable</a>(ui32Base);
<a name="l01196"></a>01196 }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198 <span class="comment">//*****************************************************************************</span>
<a name="l01199"></a>01199 <span class="comment">//</span>
<a name="l01209"></a>01209 <span class="comment"></span><span class="comment">//</span>
<a name="l01210"></a>01210 <span class="comment">//*****************************************************************************</span>
<a name="l01211"></a>01211 <span class="keywordtype">void</span>
<a name="l01212"></a><a class="code" href="group__spi__flash__api.html#ga901b800fe1f8a373dcc1e269f4f40e04">01212</a> <a class="code" href="group__spi__flash__api.html#ga901b800fe1f8a373dcc1e269f4f40e04">SPIFlashWriteStatus</a>(uint32_t ui32Base, uint8_t ui8Status)
<a name="l01213"></a>01213 {
<a name="l01214"></a>01214     <span class="comment">//</span>
<a name="l01215"></a>01215     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l01216"></a>01216     <span class="comment">//</span>
<a name="l01217"></a>01217     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     <span class="comment">//</span>
<a name="l01220"></a>01220     <span class="comment">// Send the write status register command.</span>
<a name="l01221"></a>01221     <span class="comment">//</span>
<a name="l01222"></a>01222     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#gacf9ec38b37caa1223e957bba6058f626">CMD_WRSR</a>);
<a name="l01223"></a>01223 
<a name="l01224"></a>01224     <span class="comment">//</span>
<a name="l01225"></a>01225     <span class="comment">// Send the new status register value, marking this byte as the end of the</span>
<a name="l01226"></a>01226     <span class="comment">// frame.</span>
<a name="l01227"></a>01227     <span class="comment">//</span>
<a name="l01228"></a>01228     <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, ui8Status);
<a name="l01229"></a>01229 }
<a name="l01230"></a>01230 
<a name="l01231"></a>01231 <span class="comment">//*****************************************************************************</span>
<a name="l01232"></a>01232 <span class="comment">//</span>
<a name="l01245"></a>01245 <span class="comment"></span><span class="comment">//</span>
<a name="l01246"></a>01246 <span class="comment">//*****************************************************************************</span>
<a name="l01247"></a>01247 <span class="keywordtype">void</span>
<a name="l01248"></a><a class="code" href="group__spi__flash__api.html#ga1bd70e866ded923d10aee1a43bc2b349">01248</a> <a class="code" href="group__spi__flash__api.html#ga1bd70e866ded923d10aee1a43bc2b349">SPIFlashPageProgram</a>(uint32_t ui32Base, uint32_t ui32Addr,
<a name="l01249"></a>01249                     <span class="keyword">const</span> uint8_t *pui8Data, uint32_t ui32Count)
<a name="l01250"></a>01250 {
<a name="l01251"></a>01251     <span class="comment">//</span>
<a name="l01252"></a>01252     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l01253"></a>01253     <span class="comment">//</span>
<a name="l01254"></a>01254     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l01255"></a>01255 
<a name="l01256"></a>01256     <span class="comment">//</span>
<a name="l01257"></a>01257     <span class="comment">// Send the page program command.</span>
<a name="l01258"></a>01258     <span class="comment">//</span>
<a name="l01259"></a>01259     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#ga2543fca56aeb170a41cc9f4d9b24c4cf">CMD_PP</a>);
<a name="l01260"></a>01260 
<a name="l01261"></a>01261     <span class="comment">//</span>
<a name="l01262"></a>01262     <span class="comment">// Send the address of the first byte to program.</span>
<a name="l01263"></a>01263     <span class="comment">//</span>
<a name="l01264"></a>01264     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 16) &amp; 0xff);
<a name="l01265"></a>01265     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 8) &amp; 0xff);
<a name="l01266"></a>01266     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, ui32Addr &amp; 0xff);
<a name="l01267"></a>01267 
<a name="l01268"></a>01268     <span class="comment">//</span>
<a name="l01269"></a>01269     <span class="comment">// Loop while there is more than one data byte left to be sent.</span>
<a name="l01270"></a>01270     <span class="comment">//</span>
<a name="l01271"></a>01271     <span class="keywordflow">while</span>(ui32Count-- != 1)
<a name="l01272"></a>01272     {
<a name="l01273"></a>01273         <span class="comment">//</span>
<a name="l01274"></a>01274         <span class="comment">// Send the next data byte.</span>
<a name="l01275"></a>01275         <span class="comment">//</span>
<a name="l01276"></a>01276         <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, *pui8Data++);
<a name="l01277"></a>01277     }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279     <span class="comment">//</span>
<a name="l01280"></a>01280     <span class="comment">// Send the last data byte, marking it as the end of the frame.</span>
<a name="l01281"></a>01281     <span class="comment">//</span>
<a name="l01282"></a>01282     <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, *pui8Data);
<a name="l01283"></a>01283 }
<a name="l01284"></a>01284 
<a name="l01285"></a>01285 <span class="comment">//*****************************************************************************</span>
<a name="l01286"></a>01286 <span class="comment">//</span>
<a name="l01324"></a>01324 <span class="comment"></span><span class="comment">//</span>
<a name="l01325"></a>01325 <span class="comment">//*****************************************************************************</span>
<a name="l01326"></a>01326 <span class="keywordtype">void</span>
<a name="l01327"></a><a class="code" href="group__spi__flash__api.html#gab47e95a2c22ec3d0eafe80e8fad1e84f">01327</a> <a class="code" href="group__spi__flash__api.html#gab47e95a2c22ec3d0eafe80e8fad1e84f">SPIFlashPageProgramNonBlocking</a>(<a class="code" href="structt_s_p_i_flash_state.html" title="The state structure used when performing non-blocking SPI flash operations.">tSPIFlashState</a> *pState, uint32_t ui32Base,
<a name="l01328"></a>01328                                uint32_t ui32Addr, <span class="keyword">const</span> uint8_t *pui8Data,
<a name="l01329"></a>01329                                uint32_t ui32Count, <span class="keywordtype">bool</span> bUseDMA,
<a name="l01330"></a>01330                                uint32_t ui32TxChannel)
<a name="l01331"></a>01331 {
<a name="l01332"></a>01332     <span class="comment">//</span>
<a name="l01333"></a>01333     <span class="comment">// Save the parameters of this program operation to the state structure.</span>
<a name="l01334"></a>01334     <span class="comment">//</span>
<a name="l01335"></a>01335     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> = ui32Base;
<a name="l01336"></a>01336     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a074f5ab3f6e39f06334bf7ce875c8027" title="The command that is being send to the SPI flash.">ui16Cmd</a> = <a class="code" href="group__spi__flash__api.html#ga2543fca56aeb170a41cc9f4d9b24c4cf">CMD_PP</a>;
<a name="l01337"></a>01337     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga88c4e00f812e9b6becece01b8f60d678">STATE_CMD</a>;
<a name="l01338"></a>01338     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a14849eb4c3631e87c93d6bc2ed7c5a9d" title="The SPI flash address associated with the command.">ui32Addr</a> = ui32Addr;
<a name="l01339"></a>01339     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a> = (uint8_t *)pui8Data;
<a name="l01340"></a>01340     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> = 0;
<a name="l01341"></a>01341     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> = ui32Count;
<a name="l01342"></a>01342     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ab33983a1783bc5f7593f60ebf8975645" title="A flag that is true if uDMA used be used for the transfer.">bUseDMA</a> = bUseDMA;
<a name="l01343"></a>01343     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a> = ui32TxChannel &amp; 0x1f;
<a name="l01344"></a>01344 
<a name="l01345"></a>01345     <span class="comment">//</span>
<a name="l01346"></a>01346     <span class="comment">// Enable the SSI transmit interrupt.  This will start the transfer.  If</span>
<a name="l01347"></a>01347     <span class="comment">// uDMA is being used, the uDMA-related interrupt will be enabled at the</span>
<a name="l01348"></a>01348     <span class="comment">// appropriate time by the interrupt handler.</span>
<a name="l01349"></a>01349     <span class="comment">//</span>
<a name="l01350"></a>01350     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(ui32Base + <a class="code" href="hw__ssi_8h.html#aaf63879f2c29b6fd6d9903153dd4271a">SSI_O_ICR</a>) = <a class="code" href="hw__ssi_8h.html#a873e573501798cee815d0e810979e579">SSI_ICR_DMATXIC</a>;
<a name="l01351"></a>01351     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(ui32Base + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) = <a class="code" href="hw__ssi_8h.html#a22cc1ee908ec15a4ae5cec1f77195b53">SSI_IM_TXIM</a>;
<a name="l01352"></a>01352 }
<a name="l01353"></a>01353 
<a name="l01354"></a>01354 <span class="comment">//*****************************************************************************</span>
<a name="l01355"></a>01355 <span class="comment">//</span>
<a name="l01369"></a>01369 <span class="comment"></span><span class="comment">//</span>
<a name="l01370"></a>01370 <span class="comment">//*****************************************************************************</span>
<a name="l01371"></a>01371 <span class="keywordtype">void</span>
<a name="l01372"></a><a class="code" href="group__spi__flash__api.html#gad3dbb731a043f828f04867ff9146b07a">01372</a> <a class="code" href="group__spi__flash__api.html#gad3dbb731a043f828f04867ff9146b07a">SPIFlashRead</a>(uint32_t ui32Base, uint32_t ui32Addr, uint8_t *pui8Data,
<a name="l01373"></a>01373              uint32_t ui32Count)
<a name="l01374"></a>01374 {
<a name="l01375"></a>01375     uint32_t ui32Trash;
<a name="l01376"></a>01376 
<a name="l01377"></a>01377     <span class="comment">//</span>
<a name="l01378"></a>01378     <span class="comment">// Drain any residual data from the receive FIFO.</span>
<a name="l01379"></a>01379     <span class="comment">//</span>
<a name="l01380"></a>01380     <span class="keywordflow">while</span>(<a class="code" href="rom__map_8h.html#a2985d0cd62b5efa437dd6c4053a66e4f">MAP_SSIDataGetNonBlocking</a>(ui32Base, &amp;ui32Trash) != 0)
<a name="l01381"></a>01381     {
<a name="l01382"></a>01382     }
<a name="l01383"></a>01383 
<a name="l01384"></a>01384     <span class="comment">//</span>
<a name="l01385"></a>01385     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l01386"></a>01386     <span class="comment">//</span>
<a name="l01387"></a>01387     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l01388"></a>01388 
<a name="l01389"></a>01389     <span class="comment">//</span>
<a name="l01390"></a>01390     <span class="comment">// Send the read command.</span>
<a name="l01391"></a>01391     <span class="comment">//</span>
<a name="l01392"></a>01392     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#ga9c953a6c538020e644127ee080608021">CMD_READ</a>);
<a name="l01393"></a>01393 
<a name="l01394"></a>01394     <span class="comment">//</span>
<a name="l01395"></a>01395     <span class="comment">// Send the address of the first byte to read.</span>
<a name="l01396"></a>01396     <span class="comment">//</span>
<a name="l01397"></a>01397     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 16) &amp; 0xff);
<a name="l01398"></a>01398     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 8) &amp; 0xff);
<a name="l01399"></a>01399     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, ui32Addr &amp; 0xff);
<a name="l01400"></a>01400 
<a name="l01401"></a>01401     <span class="comment">//</span>
<a name="l01402"></a>01402     <span class="comment">// Set the SSI module into read/write mode.  In this mode, dummy writes are</span>
<a name="l01403"></a>01403     <span class="comment">// required in order to make the transfer occur; the SPI flash will ignore</span>
<a name="l01404"></a>01404     <span class="comment">// the data.</span>
<a name="l01405"></a>01405     <span class="comment">//</span>
<a name="l01406"></a>01406     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#a3b381e1d2c940e29363b2e12591f9a0b">SSI_ADV_MODE_READ_WRITE</a>);
<a name="l01407"></a>01407 
<a name="l01408"></a>01408     <span class="comment">//</span>
<a name="l01409"></a>01409     <span class="comment">// See if there is a single byte to be read.</span>
<a name="l01410"></a>01410     <span class="comment">//</span>
<a name="l01411"></a>01411     <span class="keywordflow">if</span>(ui32Count == 1)
<a name="l01412"></a>01412     {
<a name="l01413"></a>01413         <span class="comment">//</span>
<a name="l01414"></a>01414         <span class="comment">// Perform a single dummy write, marking it as the end of the frame.</span>
<a name="l01415"></a>01415         <span class="comment">//</span>
<a name="l01416"></a>01416         <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, 0);
<a name="l01417"></a>01417     }
<a name="l01418"></a>01418     <span class="keywordflow">else</span>
<a name="l01419"></a>01419     {
<a name="l01420"></a>01420         <span class="comment">//</span>
<a name="l01421"></a>01421         <span class="comment">// Perform a dummy write to prime the loop.</span>
<a name="l01422"></a>01422         <span class="comment">//</span>
<a name="l01423"></a>01423         <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l01424"></a>01424 
<a name="l01425"></a>01425         <span class="comment">//</span>
<a name="l01426"></a>01426         <span class="comment">// Loop while there is more than one byte left to be read.</span>
<a name="l01427"></a>01427         <span class="comment">//</span>
<a name="l01428"></a>01428         <span class="keywordflow">while</span>(--ui32Count != 1)
<a name="l01429"></a>01429         {
<a name="l01430"></a>01430             <span class="comment">//</span>
<a name="l01431"></a>01431             <span class="comment">// Perform a dummy write to keep the transmit FIFO from going</span>
<a name="l01432"></a>01432             <span class="comment">// empty.</span>
<a name="l01433"></a>01433             <span class="comment">//</span>
<a name="l01434"></a>01434             <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l01435"></a>01435 
<a name="l01436"></a>01436             <span class="comment">//</span>
<a name="l01437"></a>01437             <span class="comment">// Read the next data byte from the receive FIFO and place it into</span>
<a name="l01438"></a>01438             <span class="comment">// the data buffer.</span>
<a name="l01439"></a>01439             <span class="comment">//</span>
<a name="l01440"></a>01440             <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Addr);
<a name="l01441"></a>01441             *pui8Data++ = ui32Addr &amp; 0xff;
<a name="l01442"></a>01442         }
<a name="l01443"></a>01443 
<a name="l01444"></a>01444         <span class="comment">//</span>
<a name="l01445"></a>01445         <span class="comment">// Perform the final dummy write, marking it as the end of the frame.</span>
<a name="l01446"></a>01446         <span class="comment">//</span>
<a name="l01447"></a>01447         <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, 0);
<a name="l01448"></a>01448 
<a name="l01449"></a>01449         <span class="comment">//</span>
<a name="l01450"></a>01450         <span class="comment">// Read the next data byte from the receive FIFO and place it into the</span>
<a name="l01451"></a>01451         <span class="comment">// data buffer.</span>
<a name="l01452"></a>01452         <span class="comment">//</span>
<a name="l01453"></a>01453         <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Addr);
<a name="l01454"></a>01454         *pui8Data++ = ui32Addr &amp; 0xff;
<a name="l01455"></a>01455     }
<a name="l01456"></a>01456 
<a name="l01457"></a>01457     <span class="comment">//</span>
<a name="l01458"></a>01458     <span class="comment">// Read the final data byte from the receive FIFO and place it into the</span>
<a name="l01459"></a>01459     <span class="comment">// data buffer.</span>
<a name="l01460"></a>01460     <span class="comment">//</span>
<a name="l01461"></a>01461     <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Addr);
<a name="l01462"></a>01462     *pui8Data++ = ui32Addr &amp; 0xff;
<a name="l01463"></a>01463 }
<a name="l01464"></a>01464 
<a name="l01465"></a>01465 <span class="comment">//*****************************************************************************</span>
<a name="l01466"></a>01466 <span class="comment">//</span>
<a name="l01507"></a>01507 <span class="comment"></span><span class="comment">//</span>
<a name="l01508"></a>01508 <span class="comment">//*****************************************************************************</span>
<a name="l01509"></a>01509 <span class="keywordtype">void</span>
<a name="l01510"></a><a class="code" href="group__spi__flash__api.html#gaf8c7a404794d8d63406154471c73540f">01510</a> <a class="code" href="group__spi__flash__api.html#gaf8c7a404794d8d63406154471c73540f">SPIFlashReadNonBlocking</a>(<a class="code" href="structt_s_p_i_flash_state.html" title="The state structure used when performing non-blocking SPI flash operations.">tSPIFlashState</a> *pState, uint32_t ui32Base,
<a name="l01511"></a>01511                         uint32_t ui32Addr, uint8_t *pui8Data,
<a name="l01512"></a>01512                         uint32_t ui32Count, <span class="keywordtype">bool</span> bUseDMA,
<a name="l01513"></a>01513                         uint32_t ui32TxChannel, uint32_t ui32RxChannel)
<a name="l01514"></a>01514 {
<a name="l01515"></a>01515     uint32_t ui32Trash;
<a name="l01516"></a>01516 
<a name="l01517"></a>01517     <span class="comment">//</span>
<a name="l01518"></a>01518     <span class="comment">// Drain any residual data from the receive FIFO.</span>
<a name="l01519"></a>01519     <span class="comment">//</span>
<a name="l01520"></a>01520     <span class="keywordflow">while</span>(<a class="code" href="rom__map_8h.html#a2985d0cd62b5efa437dd6c4053a66e4f">MAP_SSIDataGetNonBlocking</a>(ui32Base, &amp;ui32Trash) != 0)
<a name="l01521"></a>01521     {
<a name="l01522"></a>01522     }
<a name="l01523"></a>01523 
<a name="l01524"></a>01524     <span class="comment">//</span>
<a name="l01525"></a>01525     <span class="comment">// Save the parameters of this read operation to the state structure.</span>
<a name="l01526"></a>01526     <span class="comment">//</span>
<a name="l01527"></a>01527     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> = ui32Base;
<a name="l01528"></a>01528     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a074f5ab3f6e39f06334bf7ce875c8027" title="The command that is being send to the SPI flash.">ui16Cmd</a> = <a class="code" href="group__spi__flash__api.html#ga9c953a6c538020e644127ee080608021">CMD_READ</a>;
<a name="l01529"></a>01529     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga88c4e00f812e9b6becece01b8f60d678">STATE_CMD</a>;
<a name="l01530"></a>01530     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a14849eb4c3631e87c93d6bc2ed7c5a9d" title="The SPI flash address associated with the command.">ui32Addr</a> = ui32Addr;
<a name="l01531"></a>01531     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a> = pui8Data;
<a name="l01532"></a>01532     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> = ui32Count;
<a name="l01533"></a>01533     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> = ui32Count;
<a name="l01534"></a>01534     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ab33983a1783bc5f7593f60ebf8975645" title="A flag that is true if uDMA used be used for the transfer.">bUseDMA</a> = bUseDMA;
<a name="l01535"></a>01535     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a> = ui32TxChannel &amp; 0x1f;
<a name="l01536"></a>01536     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a> = ui32RxChannel &amp; 0x1f;
<a name="l01537"></a>01537 
<a name="l01538"></a>01538     <span class="comment">//</span>
<a name="l01539"></a>01539     <span class="comment">// Enable the SSI transmit and receive interrupts.  This will start the</span>
<a name="l01540"></a>01540     <span class="comment">// transfer.  If uDMA is being used, the uDMA-related interrupts will be</span>
<a name="l01541"></a>01541     <span class="comment">// enabled at the appropriate time by the interrupt handler.</span>
<a name="l01542"></a>01542     <span class="comment">//</span>
<a name="l01543"></a>01543     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(ui32Base + <a class="code" href="hw__ssi_8h.html#aaf63879f2c29b6fd6d9903153dd4271a">SSI_O_ICR</a>) = <a class="code" href="hw__ssi_8h.html#a873e573501798cee815d0e810979e579">SSI_ICR_DMATXIC</a> | <a class="code" href="hw__ssi_8h.html#a954860482fa17ad95cd0d4cb44fda84b">SSI_ICR_DMARXIC</a>;
<a name="l01544"></a>01544     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(ui32Base + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) = <a class="code" href="hw__ssi_8h.html#a22cc1ee908ec15a4ae5cec1f77195b53">SSI_IM_TXIM</a> | <a class="code" href="hw__ssi_8h.html#a991109b454b7f2a294ce9dd2b523f378">SSI_IM_RXIM</a> | <a class="code" href="hw__ssi_8h.html#afd3ac990370ed4a0100b719fc1c7da7f">SSI_IM_RTIM</a>;
<a name="l01545"></a>01545 }
<a name="l01546"></a>01546 
<a name="l01547"></a>01547 <span class="comment">//*****************************************************************************</span>
<a name="l01548"></a>01548 <span class="comment">//</span>
<a name="l01557"></a>01557 <span class="comment"></span><span class="comment">//</span>
<a name="l01558"></a>01558 <span class="comment">//*****************************************************************************</span>
<a name="l01559"></a>01559 <span class="keywordtype">void</span>
<a name="l01560"></a><a class="code" href="group__spi__flash__api.html#ga86346f2b25c46fb16acdb7a0315f68c9">01560</a> <a class="code" href="group__spi__flash__api.html#ga86346f2b25c46fb16acdb7a0315f68c9">SPIFlashWriteDisable</a>(uint32_t ui32Base)
<a name="l01561"></a>01561 {
<a name="l01562"></a>01562     <span class="comment">//</span>
<a name="l01563"></a>01563     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l01564"></a>01564     <span class="comment">//</span>
<a name="l01565"></a>01565     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l01566"></a>01566 
<a name="l01567"></a>01567     <span class="comment">//</span>
<a name="l01568"></a>01568     <span class="comment">// Send the write disable command, marking this byte as the end of the</span>
<a name="l01569"></a>01569     <span class="comment">// frame.</span>
<a name="l01570"></a>01570     <span class="comment">//</span>
<a name="l01571"></a>01571     <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#gaa98eb90657f02a0b7a4634174081799e">CMD_WRDI</a>);
<a name="l01572"></a>01572 }
<a name="l01573"></a>01573 
<a name="l01574"></a>01574 <span class="comment">//*****************************************************************************</span>
<a name="l01575"></a>01575 <span class="comment">//</span>
<a name="l01584"></a>01584 <span class="comment"></span><span class="comment">//</span>
<a name="l01585"></a>01585 <span class="comment">//*****************************************************************************</span>
<a name="l01586"></a>01586 uint8_t
<a name="l01587"></a><a class="code" href="group__spi__flash__api.html#gabb1bf43047839456adfc4c6e484585a6">01587</a> <a class="code" href="group__spi__flash__api.html#gabb1bf43047839456adfc4c6e484585a6">SPIFlashReadStatus</a>(uint32_t ui32Base)
<a name="l01588"></a>01588 {
<a name="l01589"></a>01589     uint32_t ui32Data;
<a name="l01590"></a>01590 
<a name="l01591"></a>01591     <span class="comment">//</span>
<a name="l01592"></a>01592     <span class="comment">// Drain any residual data from the receive FIFO.</span>
<a name="l01593"></a>01593     <span class="comment">//</span>
<a name="l01594"></a>01594     <span class="keywordflow">while</span>(<a class="code" href="rom__map_8h.html#a2985d0cd62b5efa437dd6c4053a66e4f">MAP_SSIDataGetNonBlocking</a>(ui32Base, &amp;ui32Data) != 0)
<a name="l01595"></a>01595     {
<a name="l01596"></a>01596     }
<a name="l01597"></a>01597 
<a name="l01598"></a>01598     <span class="comment">//</span>
<a name="l01599"></a>01599     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l01600"></a>01600     <span class="comment">//</span>
<a name="l01601"></a>01601     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l01602"></a>01602 
<a name="l01603"></a>01603     <span class="comment">//</span>
<a name="l01604"></a>01604     <span class="comment">// Send the write status register command.</span>
<a name="l01605"></a>01605     <span class="comment">//</span>
<a name="l01606"></a>01606     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#gaf36d3b85d64c03760c6b76e916b443c1">CMD_RDSR</a>);
<a name="l01607"></a>01607 
<a name="l01608"></a>01608     <span class="comment">//</span>
<a name="l01609"></a>01609     <span class="comment">// Set the SSI module into read/write mode.  In this mode, dummy writes are</span>
<a name="l01610"></a>01610     <span class="comment">// required in order to make the transfer occur; the SPI flash will ignore</span>
<a name="l01611"></a>01611     <span class="comment">// the data.</span>
<a name="l01612"></a>01612     <span class="comment">//</span>
<a name="l01613"></a>01613     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#a3b381e1d2c940e29363b2e12591f9a0b">SSI_ADV_MODE_READ_WRITE</a>);
<a name="l01614"></a>01614 
<a name="l01615"></a>01615     <span class="comment">//</span>
<a name="l01616"></a>01616     <span class="comment">// Perform a single dummy write, marking it as the end of the frame.</span>
<a name="l01617"></a>01617     <span class="comment">//</span>
<a name="l01618"></a>01618     <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, 0);
<a name="l01619"></a>01619 
<a name="l01620"></a>01620     <span class="comment">//</span>
<a name="l01621"></a>01621     <span class="comment">// Read the value of the status register.</span>
<a name="l01622"></a>01622     <span class="comment">//</span>
<a name="l01623"></a>01623     <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Data);
<a name="l01624"></a>01624 
<a name="l01625"></a>01625     <span class="comment">//</span>
<a name="l01626"></a>01626     <span class="comment">// Return the status register value.</span>
<a name="l01627"></a>01627     <span class="comment">//</span>
<a name="l01628"></a>01628     <span class="keywordflow">return</span>(ui32Data &amp; 0xff);
<a name="l01629"></a>01629 }
<a name="l01630"></a>01630 
<a name="l01631"></a>01631 <span class="comment">//*****************************************************************************</span>
<a name="l01632"></a>01632 <span class="comment">//</span>
<a name="l01644"></a>01644 <span class="comment"></span><span class="comment">//</span>
<a name="l01645"></a>01645 <span class="comment">//*****************************************************************************</span>
<a name="l01646"></a>01646 <span class="keywordtype">void</span>
<a name="l01647"></a><a class="code" href="group__spi__flash__api.html#gadd97a4e0bcaa224283744a64c10a701c">01647</a> <a class="code" href="group__spi__flash__api.html#gadd97a4e0bcaa224283744a64c10a701c">SPIFlashWriteEnable</a>(uint32_t ui32Base)
<a name="l01648"></a>01648 {
<a name="l01649"></a>01649     <span class="comment">//</span>
<a name="l01650"></a>01650     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l01651"></a>01651     <span class="comment">//</span>
<a name="l01652"></a>01652     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l01653"></a>01653 
<a name="l01654"></a>01654     <span class="comment">//</span>
<a name="l01655"></a>01655     <span class="comment">// Send the write enable command, marking this byte as the end of the</span>
<a name="l01656"></a>01656     <span class="comment">// frame.</span>
<a name="l01657"></a>01657     <span class="comment">//</span>
<a name="l01658"></a>01658     <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#ga233ab2b77759d1d35814743f08c96347">CMD_WREN</a>);
<a name="l01659"></a>01659 }
<a name="l01660"></a>01660 
<a name="l01661"></a>01661 <span class="comment">//*****************************************************************************</span>
<a name="l01662"></a>01662 <span class="comment">//</span>
<a name="l01678"></a>01678 <span class="comment"></span><span class="comment">//</span>
<a name="l01679"></a>01679 <span class="comment">//*****************************************************************************</span>
<a name="l01680"></a>01680 <span class="keywordtype">void</span>
<a name="l01681"></a><a class="code" href="group__spi__flash__api.html#ga550aa252bfb93bfe45061f4aa73683b9">01681</a> <a class="code" href="group__spi__flash__api.html#ga550aa252bfb93bfe45061f4aa73683b9">SPIFlashFastRead</a>(uint32_t ui32Base, uint32_t ui32Addr, uint8_t *pui8Data,
<a name="l01682"></a>01682                  uint32_t ui32Count)
<a name="l01683"></a>01683 {
<a name="l01684"></a>01684     uint32_t ui32Trash;
<a name="l01685"></a>01685 
<a name="l01686"></a>01686     <span class="comment">//</span>
<a name="l01687"></a>01687     <span class="comment">// Drain any residual data from the receive FIFO.</span>
<a name="l01688"></a>01688     <span class="comment">//</span>
<a name="l01689"></a>01689     <span class="keywordflow">while</span>(<a class="code" href="rom__map_8h.html#a2985d0cd62b5efa437dd6c4053a66e4f">MAP_SSIDataGetNonBlocking</a>(ui32Base, &amp;ui32Trash) != 0)
<a name="l01690"></a>01690     {
<a name="l01691"></a>01691     }
<a name="l01692"></a>01692 
<a name="l01693"></a>01693     <span class="comment">//</span>
<a name="l01694"></a>01694     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l01695"></a>01695     <span class="comment">//</span>
<a name="l01696"></a>01696     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l01697"></a>01697 
<a name="l01698"></a>01698     <span class="comment">//</span>
<a name="l01699"></a>01699     <span class="comment">// Send the fast read command.</span>
<a name="l01700"></a>01700     <span class="comment">//</span>
<a name="l01701"></a>01701     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#ga95f7567ee4d9880eb6bcdacc88e0bdf9">CMD_FREAD</a>);
<a name="l01702"></a>01702 
<a name="l01703"></a>01703     <span class="comment">//</span>
<a name="l01704"></a>01704     <span class="comment">// Send the address of the first byte to read.</span>
<a name="l01705"></a>01705     <span class="comment">//</span>
<a name="l01706"></a>01706     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 16) &amp; 0xff);
<a name="l01707"></a>01707     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 8) &amp; 0xff);
<a name="l01708"></a>01708     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, ui32Addr &amp; 0xff);
<a name="l01709"></a>01709 
<a name="l01710"></a>01710     <span class="comment">//</span>
<a name="l01711"></a>01711     <span class="comment">// Send a dummy byte.</span>
<a name="l01712"></a>01712     <span class="comment">//</span>
<a name="l01713"></a>01713     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l01714"></a>01714 
<a name="l01715"></a>01715     <span class="comment">//</span>
<a name="l01716"></a>01716     <span class="comment">// Set the SSI module into read/write mode.  In this mode, dummy writes are</span>
<a name="l01717"></a>01717     <span class="comment">// required in order to make the transfer occur; the SPI flash will ignore</span>
<a name="l01718"></a>01718     <span class="comment">// the data.</span>
<a name="l01719"></a>01719     <span class="comment">//</span>
<a name="l01720"></a>01720     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#a3b381e1d2c940e29363b2e12591f9a0b">SSI_ADV_MODE_READ_WRITE</a>);
<a name="l01721"></a>01721 
<a name="l01722"></a>01722     <span class="comment">//</span>
<a name="l01723"></a>01723     <span class="comment">// See if there is a single byte to be read.</span>
<a name="l01724"></a>01724     <span class="comment">//</span>
<a name="l01725"></a>01725     <span class="keywordflow">if</span>(ui32Count == 1)
<a name="l01726"></a>01726     {
<a name="l01727"></a>01727         <span class="comment">//</span>
<a name="l01728"></a>01728         <span class="comment">// Perform a single dummy write, marking it as the end of the frame.</span>
<a name="l01729"></a>01729         <span class="comment">//</span>
<a name="l01730"></a>01730         <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, 0);
<a name="l01731"></a>01731     }
<a name="l01732"></a>01732     <span class="keywordflow">else</span>
<a name="l01733"></a>01733     {
<a name="l01734"></a>01734         <span class="comment">//</span>
<a name="l01735"></a>01735         <span class="comment">// Perform a dummy write to prime the loop.</span>
<a name="l01736"></a>01736         <span class="comment">//</span>
<a name="l01737"></a>01737         <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l01738"></a>01738 
<a name="l01739"></a>01739         <span class="comment">//</span>
<a name="l01740"></a>01740         <span class="comment">// Loop while there is more than one byte left to be read.</span>
<a name="l01741"></a>01741         <span class="comment">//</span>
<a name="l01742"></a>01742         <span class="keywordflow">while</span>(--ui32Count != 1)
<a name="l01743"></a>01743         {
<a name="l01744"></a>01744             <span class="comment">//</span>
<a name="l01745"></a>01745             <span class="comment">// Perform a dummy write to keep the transmit FIFO from going</span>
<a name="l01746"></a>01746             <span class="comment">// empty.</span>
<a name="l01747"></a>01747             <span class="comment">//</span>
<a name="l01748"></a>01748             <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l01749"></a>01749 
<a name="l01750"></a>01750             <span class="comment">//</span>
<a name="l01751"></a>01751             <span class="comment">// Read the next data byte from the receive FIFO and place it into</span>
<a name="l01752"></a>01752             <span class="comment">// the data buffer.</span>
<a name="l01753"></a>01753             <span class="comment">//</span>
<a name="l01754"></a>01754             <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Addr);
<a name="l01755"></a>01755             *pui8Data++ = ui32Addr &amp; 0xff;
<a name="l01756"></a>01756         }
<a name="l01757"></a>01757 
<a name="l01758"></a>01758         <span class="comment">//</span>
<a name="l01759"></a>01759         <span class="comment">// Perform the final dummy write, marking it as the end of the frame.</span>
<a name="l01760"></a>01760         <span class="comment">//</span>
<a name="l01761"></a>01761         <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, 0);
<a name="l01762"></a>01762 
<a name="l01763"></a>01763         <span class="comment">//</span>
<a name="l01764"></a>01764         <span class="comment">// Read the next data byte from the receive FIFO and place it into the</span>
<a name="l01765"></a>01765         <span class="comment">// data buffer.</span>
<a name="l01766"></a>01766         <span class="comment">//</span>
<a name="l01767"></a>01767         <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Addr);
<a name="l01768"></a>01768         *pui8Data++ = ui32Addr &amp; 0xff;
<a name="l01769"></a>01769     }
<a name="l01770"></a>01770 
<a name="l01771"></a>01771     <span class="comment">//</span>
<a name="l01772"></a>01772     <span class="comment">// Read the final data byte from the receive FIFO and place it into the</span>
<a name="l01773"></a>01773     <span class="comment">// data buffer.</span>
<a name="l01774"></a>01774     <span class="comment">//</span>
<a name="l01775"></a>01775     <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Addr);
<a name="l01776"></a>01776     *pui8Data++ = ui32Addr &amp; 0xff;
<a name="l01777"></a>01777 }
<a name="l01778"></a>01778 
<a name="l01779"></a>01779 <span class="comment">//*****************************************************************************</span>
<a name="l01780"></a>01780 <span class="comment">//</span>
<a name="l01824"></a>01824 <span class="comment"></span><span class="comment">//</span>
<a name="l01825"></a>01825 <span class="comment">//*****************************************************************************</span>
<a name="l01826"></a>01826 <span class="keywordtype">void</span>
<a name="l01827"></a><a class="code" href="group__spi__flash__api.html#gaaf27b3eebe2782b3986e0a4603ce9c5b">01827</a> <a class="code" href="group__spi__flash__api.html#gaaf27b3eebe2782b3986e0a4603ce9c5b">SPIFlashFastReadNonBlocking</a>(<a class="code" href="structt_s_p_i_flash_state.html" title="The state structure used when performing non-blocking SPI flash operations.">tSPIFlashState</a> *pState, uint32_t ui32Base,
<a name="l01828"></a>01828                             uint32_t ui32Addr, uint8_t *pui8Data,
<a name="l01829"></a>01829                             uint32_t ui32Count, <span class="keywordtype">bool</span> bUseDMA,
<a name="l01830"></a>01830                             uint32_t ui32TxChannel, uint32_t ui32RxChannel)
<a name="l01831"></a>01831 {
<a name="l01832"></a>01832     uint32_t ui32Trash;
<a name="l01833"></a>01833 
<a name="l01834"></a>01834     <span class="comment">//</span>
<a name="l01835"></a>01835     <span class="comment">// Drain any residual data from the receive FIFO.</span>
<a name="l01836"></a>01836     <span class="comment">//</span>
<a name="l01837"></a>01837     <span class="keywordflow">while</span>(<a class="code" href="rom__map_8h.html#a2985d0cd62b5efa437dd6c4053a66e4f">MAP_SSIDataGetNonBlocking</a>(ui32Base, &amp;ui32Trash) != 0)
<a name="l01838"></a>01838     {
<a name="l01839"></a>01839     }
<a name="l01840"></a>01840 
<a name="l01841"></a>01841     <span class="comment">//</span>
<a name="l01842"></a>01842     <span class="comment">// Save the parameters of this read operation to the state structure.</span>
<a name="l01843"></a>01843     <span class="comment">//</span>
<a name="l01844"></a>01844     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> = ui32Base;
<a name="l01845"></a>01845     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a074f5ab3f6e39f06334bf7ce875c8027" title="The command that is being send to the SPI flash.">ui16Cmd</a> = <a class="code" href="group__spi__flash__api.html#ga95f7567ee4d9880eb6bcdacc88e0bdf9">CMD_FREAD</a>;
<a name="l01846"></a>01846     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga88c4e00f812e9b6becece01b8f60d678">STATE_CMD</a>;
<a name="l01847"></a>01847     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a14849eb4c3631e87c93d6bc2ed7c5a9d" title="The SPI flash address associated with the command.">ui32Addr</a> = ui32Addr;
<a name="l01848"></a>01848     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a> = pui8Data;
<a name="l01849"></a>01849     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> = ui32Count;
<a name="l01850"></a>01850     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> = ui32Count;
<a name="l01851"></a>01851     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ab33983a1783bc5f7593f60ebf8975645" title="A flag that is true if uDMA used be used for the transfer.">bUseDMA</a> = bUseDMA;
<a name="l01852"></a>01852     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a> = ui32TxChannel &amp; 0x1f;
<a name="l01853"></a>01853     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a> = ui32RxChannel &amp; 0x1f;
<a name="l01854"></a>01854 
<a name="l01855"></a>01855     <span class="comment">//</span>
<a name="l01856"></a>01856     <span class="comment">// Enable the SSI transmit and receive interrupts.  This will start the</span>
<a name="l01857"></a>01857     <span class="comment">// transfer.  If uDMA is being used, the uDMA-related interrupts will be</span>
<a name="l01858"></a>01858     <span class="comment">// enabled at the appropriate time by the interrupt handler.</span>
<a name="l01859"></a>01859     <span class="comment">//</span>
<a name="l01860"></a>01860     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(ui32Base + <a class="code" href="hw__ssi_8h.html#aaf63879f2c29b6fd6d9903153dd4271a">SSI_O_ICR</a>) = <a class="code" href="hw__ssi_8h.html#a873e573501798cee815d0e810979e579">SSI_ICR_DMATXIC</a> | <a class="code" href="hw__ssi_8h.html#a954860482fa17ad95cd0d4cb44fda84b">SSI_ICR_DMARXIC</a>;
<a name="l01861"></a>01861     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(ui32Base + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) = <a class="code" href="hw__ssi_8h.html#a22cc1ee908ec15a4ae5cec1f77195b53">SSI_IM_TXIM</a> | <a class="code" href="hw__ssi_8h.html#a991109b454b7f2a294ce9dd2b523f378">SSI_IM_RXIM</a> | <a class="code" href="hw__ssi_8h.html#afd3ac990370ed4a0100b719fc1c7da7f">SSI_IM_RTIM</a>;
<a name="l01862"></a>01862 }
<a name="l01863"></a>01863 
<a name="l01864"></a>01864 <span class="comment">//*****************************************************************************</span>
<a name="l01865"></a>01865 <span class="comment">//</span>
<a name="l01879"></a>01879 <span class="comment"></span><span class="comment">//</span>
<a name="l01880"></a>01880 <span class="comment">//*****************************************************************************</span>
<a name="l01881"></a>01881 <span class="keywordtype">void</span>
<a name="l01882"></a><a class="code" href="group__spi__flash__api.html#ga058368211f1723e85295eb32b637360e">01882</a> <a class="code" href="group__spi__flash__api.html#ga058368211f1723e85295eb32b637360e">SPIFlashSectorErase</a>(uint32_t ui32Base, uint32_t ui32Addr)
<a name="l01883"></a>01883 {
<a name="l01884"></a>01884     <span class="comment">//</span>
<a name="l01885"></a>01885     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l01886"></a>01886     <span class="comment">//</span>
<a name="l01887"></a>01887     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l01888"></a>01888 
<a name="l01889"></a>01889     <span class="comment">//</span>
<a name="l01890"></a>01890     <span class="comment">// Send the sector erase command.</span>
<a name="l01891"></a>01891     <span class="comment">//</span>
<a name="l01892"></a>01892     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#gab108a0bca1eff44cfc82862a6931b04f">CMD_SE</a>);
<a name="l01893"></a>01893 
<a name="l01894"></a>01894     <span class="comment">//</span>
<a name="l01895"></a>01895     <span class="comment">// Send the address of the sector to be erased, marking the last byte of</span>
<a name="l01896"></a>01896     <span class="comment">// the address as the end of the frame.</span>
<a name="l01897"></a>01897     <span class="comment">//</span>
<a name="l01898"></a>01898     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 16) &amp; 0xff);
<a name="l01899"></a>01899     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 8) &amp; 0xff);
<a name="l01900"></a>01900     <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, ui32Addr &amp; 0xff);
<a name="l01901"></a>01901 }
<a name="l01902"></a>01902 
<a name="l01903"></a>01903 <span class="comment">//*****************************************************************************</span>
<a name="l01904"></a>01904 <span class="comment">//</span>
<a name="l01918"></a>01918 <span class="comment"></span><span class="comment">//</span>
<a name="l01919"></a>01919 <span class="comment">//*****************************************************************************</span>
<a name="l01920"></a>01920 <span class="keywordtype">void</span>
<a name="l01921"></a><a class="code" href="group__spi__flash__api.html#ga5d1b036b4baa2af303faaffb33bd2657">01921</a> <a class="code" href="group__spi__flash__api.html#ga5d1b036b4baa2af303faaffb33bd2657">SPIFlashDualRead</a>(uint32_t ui32Base, uint32_t ui32Addr, uint8_t *pui8Data,
<a name="l01922"></a>01922                  uint32_t ui32Count)
<a name="l01923"></a>01923 {
<a name="l01924"></a>01924     uint32_t ui32Trash;
<a name="l01925"></a>01925 
<a name="l01926"></a>01926     <span class="comment">//</span>
<a name="l01927"></a>01927     <span class="comment">// Drain any residual data from the receive FIFO.</span>
<a name="l01928"></a>01928     <span class="comment">//</span>
<a name="l01929"></a>01929     <span class="keywordflow">while</span>(<a class="code" href="rom__map_8h.html#a2985d0cd62b5efa437dd6c4053a66e4f">MAP_SSIDataGetNonBlocking</a>(ui32Base, &amp;ui32Trash) != 0)
<a name="l01930"></a>01930     {
<a name="l01931"></a>01931     }
<a name="l01932"></a>01932 
<a name="l01933"></a>01933     <span class="comment">//</span>
<a name="l01934"></a>01934     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l01935"></a>01935     <span class="comment">//</span>
<a name="l01936"></a>01936     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l01937"></a>01937 
<a name="l01938"></a>01938     <span class="comment">//</span>
<a name="l01939"></a>01939     <span class="comment">// Send the dual read command.</span>
<a name="l01940"></a>01940     <span class="comment">//</span>
<a name="l01941"></a>01941     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#gac7464fa85e0f285f4f293e4a5109b88a">CMD_DREAD</a>);
<a name="l01942"></a>01942 
<a name="l01943"></a>01943     <span class="comment">//</span>
<a name="l01944"></a>01944     <span class="comment">// Send the address of the first byte to read.</span>
<a name="l01945"></a>01945     <span class="comment">//</span>
<a name="l01946"></a>01946     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 16) &amp; 0xff);
<a name="l01947"></a>01947     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 8) &amp; 0xff);
<a name="l01948"></a>01948     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, ui32Addr &amp; 0xff);
<a name="l01949"></a>01949 
<a name="l01950"></a>01950     <span class="comment">//</span>
<a name="l01951"></a>01951     <span class="comment">// Send a dummy byte.</span>
<a name="l01952"></a>01952     <span class="comment">//</span>
<a name="l01953"></a>01953     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l01954"></a>01954 
<a name="l01955"></a>01955     <span class="comment">//</span>
<a name="l01956"></a>01956     <span class="comment">// Set the SSI module into Bi-SPI read mode.  In this mode, dummy writes</span>
<a name="l01957"></a>01957     <span class="comment">// are required in order to make the transfer occur; the SSI module will</span>
<a name="l01958"></a>01958     <span class="comment">// ignore the data (the SPI flash will never see the dummy data since</span>
<a name="l01959"></a>01959     <span class="comment">// Bi-SPI read mode is a uni-directional input mode).</span>
<a name="l01960"></a>01960     <span class="comment">//</span>
<a name="l01961"></a>01961     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#a0d3b574fbf3d0b60970d6f3357ac13bd">SSI_ADV_MODE_BI_READ</a>);
<a name="l01962"></a>01962 
<a name="l01963"></a>01963     <span class="comment">//</span>
<a name="l01964"></a>01964     <span class="comment">// See if there is a single byte to be read.</span>
<a name="l01965"></a>01965     <span class="comment">//</span>
<a name="l01966"></a>01966     <span class="keywordflow">if</span>(ui32Count == 1)
<a name="l01967"></a>01967     {
<a name="l01968"></a>01968         <span class="comment">//</span>
<a name="l01969"></a>01969         <span class="comment">// Perform a single dummy write, marking it as the end of the frame.</span>
<a name="l01970"></a>01970         <span class="comment">//</span>
<a name="l01971"></a>01971         <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, 0);
<a name="l01972"></a>01972     }
<a name="l01973"></a>01973     <span class="keywordflow">else</span>
<a name="l01974"></a>01974     {
<a name="l01975"></a>01975         <span class="comment">//</span>
<a name="l01976"></a>01976         <span class="comment">// Perform a dummy write to prime the loop.</span>
<a name="l01977"></a>01977         <span class="comment">//</span>
<a name="l01978"></a>01978         <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l01979"></a>01979 
<a name="l01980"></a>01980         <span class="comment">//</span>
<a name="l01981"></a>01981         <span class="comment">// Loop while there is more than one byte left to be read.</span>
<a name="l01982"></a>01982         <span class="comment">//</span>
<a name="l01983"></a>01983         <span class="keywordflow">while</span>(--ui32Count != 1)
<a name="l01984"></a>01984         {
<a name="l01985"></a>01985             <span class="comment">//</span>
<a name="l01986"></a>01986             <span class="comment">// Perform a dummy write to keep the transmit FIFO from going</span>
<a name="l01987"></a>01987             <span class="comment">// empty.</span>
<a name="l01988"></a>01988             <span class="comment">//</span>
<a name="l01989"></a>01989             <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l01990"></a>01990 
<a name="l01991"></a>01991             <span class="comment">//</span>
<a name="l01992"></a>01992             <span class="comment">// Read the next data byte from the receive FIFO and place it into</span>
<a name="l01993"></a>01993             <span class="comment">// the data buffer.</span>
<a name="l01994"></a>01994             <span class="comment">//</span>
<a name="l01995"></a>01995             <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Addr);
<a name="l01996"></a>01996             *pui8Data++ = ui32Addr &amp; 0xff;
<a name="l01997"></a>01997         }
<a name="l01998"></a>01998 
<a name="l01999"></a>01999         <span class="comment">//</span>
<a name="l02000"></a>02000         <span class="comment">// Perform the final dummy write, marking it as the end of the frame.</span>
<a name="l02001"></a>02001         <span class="comment">//</span>
<a name="l02002"></a>02002         <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, 0);
<a name="l02003"></a>02003 
<a name="l02004"></a>02004         <span class="comment">//</span>
<a name="l02005"></a>02005         <span class="comment">// Read the next data byte from the receive FIFO and place it into the</span>
<a name="l02006"></a>02006         <span class="comment">// data buffer.</span>
<a name="l02007"></a>02007         <span class="comment">//</span>
<a name="l02008"></a>02008         <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Addr);
<a name="l02009"></a>02009         *pui8Data++ = ui32Addr &amp; 0xff;
<a name="l02010"></a>02010     }
<a name="l02011"></a>02011 
<a name="l02012"></a>02012     <span class="comment">//</span>
<a name="l02013"></a>02013     <span class="comment">// Read the final data byte from the receive FIFO and place it into the</span>
<a name="l02014"></a>02014     <span class="comment">// data buffer.</span>
<a name="l02015"></a>02015     <span class="comment">//</span>
<a name="l02016"></a>02016     <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Addr);
<a name="l02017"></a>02017     *pui8Data++ = ui32Addr &amp; 0xff;
<a name="l02018"></a>02018 }
<a name="l02019"></a>02019 
<a name="l02020"></a>02020 <span class="comment">//*****************************************************************************</span>
<a name="l02021"></a>02021 <span class="comment">//</span>
<a name="l02062"></a>02062 <span class="comment"></span><span class="comment">//</span>
<a name="l02063"></a>02063 <span class="comment">//*****************************************************************************</span>
<a name="l02064"></a>02064 <span class="keywordtype">void</span>
<a name="l02065"></a><a class="code" href="group__spi__flash__api.html#ga3d18eb28e1f73b8dc45b564dbb422a67">02065</a> <a class="code" href="group__spi__flash__api.html#ga3d18eb28e1f73b8dc45b564dbb422a67">SPIFlashDualReadNonBlocking</a>(<a class="code" href="structt_s_p_i_flash_state.html" title="The state structure used when performing non-blocking SPI flash operations.">tSPIFlashState</a> *pState, uint32_t ui32Base,
<a name="l02066"></a>02066                             uint32_t ui32Addr, uint8_t *pui8Data,
<a name="l02067"></a>02067                             uint32_t ui32Count, <span class="keywordtype">bool</span> bUseDMA,
<a name="l02068"></a>02068                             uint32_t ui32TxChannel, uint32_t ui32RxChannel)
<a name="l02069"></a>02069 {
<a name="l02070"></a>02070     uint32_t ui32Trash;
<a name="l02071"></a>02071 
<a name="l02072"></a>02072     <span class="comment">//</span>
<a name="l02073"></a>02073     <span class="comment">// Drain any residual data from the receive FIFO.</span>
<a name="l02074"></a>02074     <span class="comment">//</span>
<a name="l02075"></a>02075     <span class="keywordflow">while</span>(<a class="code" href="rom__map_8h.html#a2985d0cd62b5efa437dd6c4053a66e4f">MAP_SSIDataGetNonBlocking</a>(ui32Base, &amp;ui32Trash) != 0)
<a name="l02076"></a>02076     {
<a name="l02077"></a>02077     }
<a name="l02078"></a>02078 
<a name="l02079"></a>02079     <span class="comment">//</span>
<a name="l02080"></a>02080     <span class="comment">// Save the parameters of this read operation to the state structure.</span>
<a name="l02081"></a>02081     <span class="comment">//</span>
<a name="l02082"></a>02082     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> = ui32Base;
<a name="l02083"></a>02083     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a074f5ab3f6e39f06334bf7ce875c8027" title="The command that is being send to the SPI flash.">ui16Cmd</a> = <a class="code" href="group__spi__flash__api.html#gac7464fa85e0f285f4f293e4a5109b88a">CMD_DREAD</a>;
<a name="l02084"></a>02084     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga88c4e00f812e9b6becece01b8f60d678">STATE_CMD</a>;
<a name="l02085"></a>02085     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a14849eb4c3631e87c93d6bc2ed7c5a9d" title="The SPI flash address associated with the command.">ui32Addr</a> = ui32Addr;
<a name="l02086"></a>02086     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a> = pui8Data;
<a name="l02087"></a>02087     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> = ui32Count;
<a name="l02088"></a>02088     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> = ui32Count;
<a name="l02089"></a>02089     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ab33983a1783bc5f7593f60ebf8975645" title="A flag that is true if uDMA used be used for the transfer.">bUseDMA</a> = bUseDMA;
<a name="l02090"></a>02090     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a> = ui32TxChannel &amp; 0x1f;
<a name="l02091"></a>02091     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a> = ui32RxChannel &amp; 0x1f;
<a name="l02092"></a>02092 
<a name="l02093"></a>02093     <span class="comment">//</span>
<a name="l02094"></a>02094     <span class="comment">// Enable the SSI transmit and receive interrupts.  This will start the</span>
<a name="l02095"></a>02095     <span class="comment">// transfer.  If uDMA is being used, the uDMA-related interrupts will be</span>
<a name="l02096"></a>02096     <span class="comment">// enabled at the appropriate time by the interrupt handler.</span>
<a name="l02097"></a>02097     <span class="comment">//</span>
<a name="l02098"></a>02098     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(ui32Base + <a class="code" href="hw__ssi_8h.html#aaf63879f2c29b6fd6d9903153dd4271a">SSI_O_ICR</a>) = <a class="code" href="hw__ssi_8h.html#a873e573501798cee815d0e810979e579">SSI_ICR_DMATXIC</a> | <a class="code" href="hw__ssi_8h.html#a954860482fa17ad95cd0d4cb44fda84b">SSI_ICR_DMARXIC</a>;
<a name="l02099"></a>02099     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(ui32Base + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) = <a class="code" href="hw__ssi_8h.html#a22cc1ee908ec15a4ae5cec1f77195b53">SSI_IM_TXIM</a> | <a class="code" href="hw__ssi_8h.html#a991109b454b7f2a294ce9dd2b523f378">SSI_IM_RXIM</a> | <a class="code" href="hw__ssi_8h.html#afd3ac990370ed4a0100b719fc1c7da7f">SSI_IM_RTIM</a>;
<a name="l02100"></a>02100 }
<a name="l02101"></a>02101 
<a name="l02102"></a>02102 <span class="comment">//*****************************************************************************</span>
<a name="l02103"></a>02103 <span class="comment">//</span>
<a name="l02117"></a>02117 <span class="comment"></span><span class="comment">//</span>
<a name="l02118"></a>02118 <span class="comment">//*****************************************************************************</span>
<a name="l02119"></a>02119 <span class="keywordtype">void</span>
<a name="l02120"></a><a class="code" href="group__spi__flash__api.html#gafa67db81dbf7cbe97458c24dd3945bfb">02120</a> <a class="code" href="group__spi__flash__api.html#gafa67db81dbf7cbe97458c24dd3945bfb">SPIFlashBlockErase32</a>(uint32_t ui32Base, uint32_t ui32Addr)
<a name="l02121"></a>02121 {
<a name="l02122"></a>02122     <span class="comment">//</span>
<a name="l02123"></a>02123     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l02124"></a>02124     <span class="comment">//</span>
<a name="l02125"></a>02125     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l02126"></a>02126 
<a name="l02127"></a>02127     <span class="comment">//</span>
<a name="l02128"></a>02128     <span class="comment">// Send the 32 KB block erase command command.</span>
<a name="l02129"></a>02129     <span class="comment">//</span>
<a name="l02130"></a>02130     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#ga4c5cce6b9a2f31616e9421737feb2f51">CMD_BE32</a>);
<a name="l02131"></a>02131 
<a name="l02132"></a>02132     <span class="comment">//</span>
<a name="l02133"></a>02133     <span class="comment">// Send the address of the 32 KB block to be erased, marking the last byte</span>
<a name="l02134"></a>02134     <span class="comment">// of the address as the end of the frame.</span>
<a name="l02135"></a>02135     <span class="comment">//</span>
<a name="l02136"></a>02136     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 16) &amp; 0xff);
<a name="l02137"></a>02137     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 8) &amp; 0xff);
<a name="l02138"></a>02138     <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, ui32Addr &amp; 0xff);
<a name="l02139"></a>02139 }
<a name="l02140"></a>02140 
<a name="l02141"></a>02141 <span class="comment">//*****************************************************************************</span>
<a name="l02142"></a>02142 <span class="comment">//</span>
<a name="l02156"></a>02156 <span class="comment"></span><span class="comment">//</span>
<a name="l02157"></a>02157 <span class="comment">//*****************************************************************************</span>
<a name="l02158"></a>02158 <span class="keywordtype">void</span>
<a name="l02159"></a><a class="code" href="group__spi__flash__api.html#gae88d59957feec85adc1801777157b578">02159</a> <a class="code" href="group__spi__flash__api.html#gae88d59957feec85adc1801777157b578">SPIFlashQuadRead</a>(uint32_t ui32Base, uint32_t ui32Addr, uint8_t *pui8Data,
<a name="l02160"></a>02160                  uint32_t ui32Count)
<a name="l02161"></a>02161 {
<a name="l02162"></a>02162     uint32_t ui32Trash;
<a name="l02163"></a>02163 
<a name="l02164"></a>02164     <span class="comment">//</span>
<a name="l02165"></a>02165     <span class="comment">// Drain any residual data from the receive FIFO.</span>
<a name="l02166"></a>02166     <span class="comment">//</span>
<a name="l02167"></a>02167     <span class="keywordflow">while</span>(<a class="code" href="rom__map_8h.html#a2985d0cd62b5efa437dd6c4053a66e4f">MAP_SSIDataGetNonBlocking</a>(ui32Base, &amp;ui32Trash) != 0)
<a name="l02168"></a>02168     {
<a name="l02169"></a>02169     }
<a name="l02170"></a>02170 
<a name="l02171"></a>02171     <span class="comment">//</span>
<a name="l02172"></a>02172     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l02173"></a>02173     <span class="comment">//</span>
<a name="l02174"></a>02174     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l02175"></a>02175 
<a name="l02176"></a>02176     <span class="comment">//</span>
<a name="l02177"></a>02177     <span class="comment">// Send the quad read command.</span>
<a name="l02178"></a>02178     <span class="comment">//</span>
<a name="l02179"></a>02179     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#gaccf40d95b8aa697f4023b4ff334b61fa">CMD_QREAD</a>);
<a name="l02180"></a>02180 
<a name="l02181"></a>02181     <span class="comment">//</span>
<a name="l02182"></a>02182     <span class="comment">// Send the address of the first byte to read.</span>
<a name="l02183"></a>02183     <span class="comment">//</span>
<a name="l02184"></a>02184     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 16) &amp; 0xff);
<a name="l02185"></a>02185     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 8) &amp; 0xff);
<a name="l02186"></a>02186     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, ui32Addr &amp; 0xff);
<a name="l02187"></a>02187 
<a name="l02188"></a>02188     <span class="comment">//</span>
<a name="l02189"></a>02189     <span class="comment">// Send a dummy byte.</span>
<a name="l02190"></a>02190     <span class="comment">//</span>
<a name="l02191"></a>02191     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l02192"></a>02192 
<a name="l02193"></a>02193     <span class="comment">//</span>
<a name="l02194"></a>02194     <span class="comment">// Set the SSI module into Quad-SPI read mode.  In this mode, dummy writes</span>
<a name="l02195"></a>02195     <span class="comment">// are required in order to make the transfer occur; the SSI module will</span>
<a name="l02196"></a>02196     <span class="comment">// ignore the data (the SPI flash will never see the dummy data since</span>
<a name="l02197"></a>02197     <span class="comment">// Quad-SPI read mode is a uni-directional input mode).</span>
<a name="l02198"></a>02198     <span class="comment">//</span>
<a name="l02199"></a>02199     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#a4dd541d5976ffab841e75cbaa5515a48">SSI_ADV_MODE_QUAD_READ</a>);
<a name="l02200"></a>02200 
<a name="l02201"></a>02201     <span class="comment">//</span>
<a name="l02202"></a>02202     <span class="comment">// See if there is a single byte to be read.</span>
<a name="l02203"></a>02203     <span class="comment">//</span>
<a name="l02204"></a>02204     <span class="keywordflow">if</span>(ui32Count == 1)
<a name="l02205"></a>02205     {
<a name="l02206"></a>02206         <span class="comment">//</span>
<a name="l02207"></a>02207         <span class="comment">// Perform a single dummy write, marking it as the end of the frame.</span>
<a name="l02208"></a>02208         <span class="comment">//</span>
<a name="l02209"></a>02209         <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, 0);
<a name="l02210"></a>02210     }
<a name="l02211"></a>02211     <span class="keywordflow">else</span>
<a name="l02212"></a>02212     {
<a name="l02213"></a>02213         <span class="comment">//</span>
<a name="l02214"></a>02214         <span class="comment">// Perform a dummy write to prime the loop.</span>
<a name="l02215"></a>02215         <span class="comment">//</span>
<a name="l02216"></a>02216         <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l02217"></a>02217 
<a name="l02218"></a>02218         <span class="comment">//</span>
<a name="l02219"></a>02219         <span class="comment">// Loop while there is more than one byte left to be read.</span>
<a name="l02220"></a>02220         <span class="comment">//</span>
<a name="l02221"></a>02221         <span class="keywordflow">while</span>(--ui32Count != 1)
<a name="l02222"></a>02222         {
<a name="l02223"></a>02223             <span class="comment">//</span>
<a name="l02224"></a>02224             <span class="comment">// Perform a dummy write to keep the transmit FIFO from going</span>
<a name="l02225"></a>02225             <span class="comment">// empty.</span>
<a name="l02226"></a>02226             <span class="comment">//</span>
<a name="l02227"></a>02227             <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l02228"></a>02228 
<a name="l02229"></a>02229             <span class="comment">//</span>
<a name="l02230"></a>02230             <span class="comment">// Read the next data byte from the receive FIFO and place it into</span>
<a name="l02231"></a>02231             <span class="comment">// the data buffer.</span>
<a name="l02232"></a>02232             <span class="comment">//</span>
<a name="l02233"></a>02233             <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Addr);
<a name="l02234"></a>02234             *pui8Data++ = ui32Addr &amp; 0xff;
<a name="l02235"></a>02235         }
<a name="l02236"></a>02236 
<a name="l02237"></a>02237         <span class="comment">//</span>
<a name="l02238"></a>02238         <span class="comment">// Perform the final dummy write, marking it as the end of the frame.</span>
<a name="l02239"></a>02239         <span class="comment">//</span>
<a name="l02240"></a>02240         <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, 0);
<a name="l02241"></a>02241 
<a name="l02242"></a>02242         <span class="comment">//</span>
<a name="l02243"></a>02243         <span class="comment">// Read the next data byte from the receive FIFO and place it into the</span>
<a name="l02244"></a>02244         <span class="comment">// data buffer.</span>
<a name="l02245"></a>02245         <span class="comment">//</span>
<a name="l02246"></a>02246         <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Addr);
<a name="l02247"></a>02247         *pui8Data++ = ui32Addr &amp; 0xff;
<a name="l02248"></a>02248     }
<a name="l02249"></a>02249 
<a name="l02250"></a>02250     <span class="comment">//</span>
<a name="l02251"></a>02251     <span class="comment">// Read the final data byte from the receive FIFO and place it into the</span>
<a name="l02252"></a>02252     <span class="comment">// data buffer.</span>
<a name="l02253"></a>02253     <span class="comment">//</span>
<a name="l02254"></a>02254     <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Addr);
<a name="l02255"></a>02255     *pui8Data++ = ui32Addr &amp; 0xff;
<a name="l02256"></a>02256 }
<a name="l02257"></a>02257 
<a name="l02258"></a>02258 <span class="comment">//*****************************************************************************</span>
<a name="l02259"></a>02259 <span class="comment">//</span>
<a name="l02300"></a>02300 <span class="comment"></span><span class="comment">//</span>
<a name="l02301"></a>02301 <span class="comment">//*****************************************************************************</span>
<a name="l02302"></a>02302 <span class="keywordtype">void</span>
<a name="l02303"></a><a class="code" href="group__spi__flash__api.html#gaa4ef70354c42d9ed4a78583e46c16ccd">02303</a> <a class="code" href="group__spi__flash__api.html#gaa4ef70354c42d9ed4a78583e46c16ccd">SPIFlashQuadReadNonBlocking</a>(<a class="code" href="structt_s_p_i_flash_state.html" title="The state structure used when performing non-blocking SPI flash operations.">tSPIFlashState</a> *pState, uint32_t ui32Base,
<a name="l02304"></a>02304                             uint32_t ui32Addr, uint8_t *pui8Data,
<a name="l02305"></a>02305                             uint32_t ui32Count, <span class="keywordtype">bool</span> bUseDMA,
<a name="l02306"></a>02306                             uint32_t ui32TxChannel, uint32_t ui32RxChannel)
<a name="l02307"></a>02307 {
<a name="l02308"></a>02308     uint32_t ui32Trash;
<a name="l02309"></a>02309 
<a name="l02310"></a>02310     <span class="comment">//</span>
<a name="l02311"></a>02311     <span class="comment">// Drain any residual data from the receive FIFO.</span>
<a name="l02312"></a>02312     <span class="comment">//</span>
<a name="l02313"></a>02313     <span class="keywordflow">while</span>(<a class="code" href="rom__map_8h.html#a2985d0cd62b5efa437dd6c4053a66e4f">MAP_SSIDataGetNonBlocking</a>(ui32Base, &amp;ui32Trash) != 0)
<a name="l02314"></a>02314     {
<a name="l02315"></a>02315     }
<a name="l02316"></a>02316 
<a name="l02317"></a>02317     <span class="comment">//</span>
<a name="l02318"></a>02318     <span class="comment">// Save the parameters of this read operation to the state structure.</span>
<a name="l02319"></a>02319     <span class="comment">//</span>
<a name="l02320"></a>02320     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#afa5492f2bf96fc487cb9c6e89ee75dbf" title="The base address of the SSI module that is being used.">ui32Base</a> = ui32Base;
<a name="l02321"></a>02321     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a074f5ab3f6e39f06334bf7ce875c8027" title="The command that is being send to the SPI flash.">ui16Cmd</a> = <a class="code" href="group__spi__flash__api.html#gaccf40d95b8aa697f4023b4ff334b61fa">CMD_QREAD</a>;
<a name="l02322"></a>02322     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a13617645ea59a89666b09faca56d5e83" title="The current state of the SPI flash state machine.">ui16State</a> = <a class="code" href="group__spi__flash__api.html#ga88c4e00f812e9b6becece01b8f60d678">STATE_CMD</a>;
<a name="l02323"></a>02323     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a14849eb4c3631e87c93d6bc2ed7c5a9d" title="The SPI flash address associated with the command.">ui32Addr</a> = ui32Addr;
<a name="l02324"></a>02324     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a2bc8ac2fab0bc4c2a47f207c976ba875" title="A pointer to the data buffer that is being read or written.">pui8Buffer</a> = pui8Data;
<a name="l02325"></a>02325     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ade82e929a6d52eb542fe1d34ee210764" title="The count of bytes left to be read.">ui32ReadCount</a> = ui32Count;
<a name="l02326"></a>02326     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a31ff9833643e984d1fd9e48d7a851a6b" title="The count of bytes left to be written.">ui32WriteCount</a> = ui32Count;
<a name="l02327"></a>02327     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#ab33983a1783bc5f7593f60ebf8975645" title="A flag that is true if uDMA used be used for the transfer.">bUseDMA</a> = bUseDMA;
<a name="l02328"></a>02328     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#a3bb98b66624f93e28338d954d3fd9032">ui32TxChannel</a> = ui32TxChannel &amp; 0x1f;
<a name="l02329"></a>02329     pState-&gt;<a class="code" href="structt_s_p_i_flash_state.html#aa47658e72d6edfdebf29fd87a368c23e" title="The uDMA channel to use for receiving when using uDMA for the transfer.">ui32RxChannel</a> = ui32RxChannel &amp; 0x1f;
<a name="l02330"></a>02330 
<a name="l02331"></a>02331     <span class="comment">//</span>
<a name="l02332"></a>02332     <span class="comment">// Enable the SSI transmit and receive interrupts.  This will start the</span>
<a name="l02333"></a>02333     <span class="comment">// transfer.  If uDMA is being used, the uDMA-related interrupts will be</span>
<a name="l02334"></a>02334     <span class="comment">// enabled at the appropriate time by the interrupt handler.</span>
<a name="l02335"></a>02335     <span class="comment">//</span>
<a name="l02336"></a>02336     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(ui32Base + <a class="code" href="hw__ssi_8h.html#aaf63879f2c29b6fd6d9903153dd4271a">SSI_O_ICR</a>) = <a class="code" href="hw__ssi_8h.html#a873e573501798cee815d0e810979e579">SSI_ICR_DMATXIC</a> | <a class="code" href="hw__ssi_8h.html#a954860482fa17ad95cd0d4cb44fda84b">SSI_ICR_DMARXIC</a>;
<a name="l02337"></a>02337     <a class="code" href="hw__types_8h.html#ac9660181819fceac0b5abcd67d76ca6e">HWREG</a>(ui32Base + <a class="code" href="hw__ssi_8h.html#a0c839fa56316268d9d3c1a6338d5b9a8">SSI_O_IM</a>) = <a class="code" href="hw__ssi_8h.html#a22cc1ee908ec15a4ae5cec1f77195b53">SSI_IM_TXIM</a> | <a class="code" href="hw__ssi_8h.html#a991109b454b7f2a294ce9dd2b523f378">SSI_IM_RXIM</a> | <a class="code" href="hw__ssi_8h.html#afd3ac990370ed4a0100b719fc1c7da7f">SSI_IM_RTIM</a>;
<a name="l02338"></a>02338 }
<a name="l02339"></a>02339 
<a name="l02340"></a>02340 <span class="comment">//*****************************************************************************</span>
<a name="l02341"></a>02341 <span class="comment">//</span>
<a name="l02359"></a>02359 <span class="comment"></span><span class="comment">//</span>
<a name="l02360"></a>02360 <span class="comment">//*****************************************************************************</span>
<a name="l02361"></a>02361 <span class="keywordtype">void</span>
<a name="l02362"></a><a class="code" href="group__spi__flash__api.html#ga8d594d8bdd9e5f553ed8f626a118ed7c">02362</a> <a class="code" href="group__spi__flash__api.html#ga8d594d8bdd9e5f553ed8f626a118ed7c">SPIFlashReadID</a>(uint32_t ui32Base, uint8_t *pui8ManufacturerID,
<a name="l02363"></a>02363                uint16_t *pui16DeviceID)
<a name="l02364"></a>02364 {
<a name="l02365"></a>02365     uint32_t ui32Data1, ui32Data2;
<a name="l02366"></a>02366 
<a name="l02367"></a>02367     <span class="comment">//</span>
<a name="l02368"></a>02368     <span class="comment">// Drain any residual data from the receive FIFO.</span>
<a name="l02369"></a>02369     <span class="comment">//</span>
<a name="l02370"></a>02370     <span class="keywordflow">while</span>(<a class="code" href="rom__map_8h.html#a2985d0cd62b5efa437dd6c4053a66e4f">MAP_SSIDataGetNonBlocking</a>(ui32Base, &amp;ui32Data1) != 0)
<a name="l02371"></a>02371     {
<a name="l02372"></a>02372     }
<a name="l02373"></a>02373 
<a name="l02374"></a>02374     <span class="comment">//</span>
<a name="l02375"></a>02375     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l02376"></a>02376     <span class="comment">//</span>
<a name="l02377"></a>02377     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l02378"></a>02378 
<a name="l02379"></a>02379     <span class="comment">//</span>
<a name="l02380"></a>02380     <span class="comment">// Send the read ID command.</span>
<a name="l02381"></a>02381     <span class="comment">//</span>
<a name="l02382"></a>02382     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#ga7dcce537746ff1c0c717f6ac1f4af57b">CMD_RDID</a>);
<a name="l02383"></a>02383 
<a name="l02384"></a>02384     <span class="comment">//</span>
<a name="l02385"></a>02385     <span class="comment">// Set the SSI module into read/write mode.  In this mode, dummy writes are</span>
<a name="l02386"></a>02386     <span class="comment">// required in order to make the transfer occur; the SPI flash will ignore</span>
<a name="l02387"></a>02387     <span class="comment">// the data.</span>
<a name="l02388"></a>02388     <span class="comment">//</span>
<a name="l02389"></a>02389     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#a3b381e1d2c940e29363b2e12591f9a0b">SSI_ADV_MODE_READ_WRITE</a>);
<a name="l02390"></a>02390 
<a name="l02391"></a>02391     <span class="comment">//</span>
<a name="l02392"></a>02392     <span class="comment">// Send three dummy bytes, marking the last as the end of the frame.</span>
<a name="l02393"></a>02393     <span class="comment">//</span>
<a name="l02394"></a>02394     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l02395"></a>02395     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, 0);
<a name="l02396"></a>02396     <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, 0);
<a name="l02397"></a>02397 
<a name="l02398"></a>02398     <span class="comment">//</span>
<a name="l02399"></a>02399     <span class="comment">// Read the first returned data byte, which contains the manufacturer ID.</span>
<a name="l02400"></a>02400     <span class="comment">//</span>
<a name="l02401"></a>02401     <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Data1);
<a name="l02402"></a>02402     *pui8ManufacturerID = ui32Data1 &amp; 0xff;
<a name="l02403"></a>02403 
<a name="l02404"></a>02404     <span class="comment">//</span>
<a name="l02405"></a>02405     <span class="comment">// Read the remaining two data bytes, which contain the device ID.</span>
<a name="l02406"></a>02406     <span class="comment">//</span>
<a name="l02407"></a>02407     <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Data1);
<a name="l02408"></a>02408     <a class="code" href="rom__map_8h.html#a8f9f9fa6cc04e29027eaa0531d308ff1">MAP_SSIDataGet</a>(ui32Base, &amp;ui32Data2);
<a name="l02409"></a>02409     *pui16DeviceID = ((ui32Data1 &amp; 0xff) &lt;&lt; 8) | (ui32Data2 &amp; 0xff);
<a name="l02410"></a>02410 }
<a name="l02411"></a>02411 
<a name="l02412"></a>02412 <span class="comment">//*****************************************************************************</span>
<a name="l02413"></a>02413 <span class="comment">//</span>
<a name="l02424"></a>02424 <span class="comment"></span><span class="comment">//</span>
<a name="l02425"></a>02425 <span class="comment">//*****************************************************************************</span>
<a name="l02426"></a>02426 <span class="keywordtype">void</span>
<a name="l02427"></a><a class="code" href="group__spi__flash__api.html#gac9d54a0cd51fcd2f310ef08bff6c8541">02427</a> <a class="code" href="group__spi__flash__api.html#gac9d54a0cd51fcd2f310ef08bff6c8541">SPIFlashChipErase</a>(uint32_t ui32Base)
<a name="l02428"></a>02428 {
<a name="l02429"></a>02429     <span class="comment">//</span>
<a name="l02430"></a>02430     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l02431"></a>02431     <span class="comment">//</span>
<a name="l02432"></a>02432     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l02433"></a>02433 
<a name="l02434"></a>02434     <span class="comment">//</span>
<a name="l02435"></a>02435     <span class="comment">// Send the chip erase command, marking this byte as the end of the frame.</span>
<a name="l02436"></a>02436     <span class="comment">//</span>
<a name="l02437"></a>02437     <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#ga90f680398020583fafb3d1a9c03a2aeb">CMD_CE</a>);
<a name="l02438"></a>02438 }
<a name="l02439"></a>02439 
<a name="l02440"></a>02440 <span class="comment">//*****************************************************************************</span>
<a name="l02441"></a>02441 <span class="comment">//</span>
<a name="l02455"></a>02455 <span class="comment"></span><span class="comment">//</span>
<a name="l02456"></a>02456 <span class="comment">//*****************************************************************************</span>
<a name="l02457"></a>02457 <span class="keywordtype">void</span>
<a name="l02458"></a><a class="code" href="group__spi__flash__api.html#gad5901f8570e88ba3b56d7b9748180dbd">02458</a> <a class="code" href="group__spi__flash__api.html#gad5901f8570e88ba3b56d7b9748180dbd">SPIFlashBlockErase64</a>(uint32_t ui32Base, uint32_t ui32Addr)
<a name="l02459"></a>02459 {
<a name="l02460"></a>02460     <span class="comment">//</span>
<a name="l02461"></a>02461     <span class="comment">// Set the SSI module into write-only mode.</span>
<a name="l02462"></a>02462     <span class="comment">//</span>
<a name="l02463"></a>02463     <a class="code" href="rom__map_8h.html#af2a8506d9ba0b87db9ebb07871785993">MAP_SSIAdvModeSet</a>(ui32Base, <a class="code" href="ssi_8h.html#ac06e63f4a08c332b7dbd3b1cb0c6154c">SSI_ADV_MODE_WRITE</a>);
<a name="l02464"></a>02464 
<a name="l02465"></a>02465     <span class="comment">//</span>
<a name="l02466"></a>02466     <span class="comment">// Send the 64 KB block erase command command.</span>
<a name="l02467"></a>02467     <span class="comment">//</span>
<a name="l02468"></a>02468     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, <a class="code" href="group__spi__flash__api.html#ga2e6d2d790472ab4751450307d668fc6a">CMD_BE64</a>);
<a name="l02469"></a>02469 
<a name="l02470"></a>02470     <span class="comment">//</span>
<a name="l02471"></a>02471     <span class="comment">// Send the address of the 64 KB block to be erased, marking the last byte</span>
<a name="l02472"></a>02472     <span class="comment">// of the address as the end of the frame.</span>
<a name="l02473"></a>02473     <span class="comment">//</span>
<a name="l02474"></a>02474     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 16) &amp; 0xff);
<a name="l02475"></a>02475     <a class="code" href="rom__map_8h.html#aed26e3b46561e08948d24d8f583a7c43">MAP_SSIDataPut</a>(ui32Base, (ui32Addr &gt;&gt; 8) &amp; 0xff);
<a name="l02476"></a>02476     <a class="code" href="rom__map_8h.html#a96329eb749a2f91f9676bbfacbe0bb7d">MAP_SSIAdvDataPutFrameEnd</a>(ui32Base, ui32Addr &amp; 0xff);
<a name="l02477"></a>02477 }
<a name="l02478"></a>02478 
<a name="l02479"></a>02479 <span class="comment">//*****************************************************************************</span>
<a name="l02480"></a>02480 <span class="comment">//</span>
<a name="l02481"></a>02481 <span class="comment">// Close the Doxygen group.</span>
<a name="l02483"></a>02483 <span class="comment"></span><span class="comment">//</span>
<a name="l02484"></a>02484 <span class="comment">//*****************************************************************************</span>
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="spi__flash_8c.html">spi_flash.c</a>      </li>

    <li class="footer">Generated on Tue Jan 27 2015 21:45:31 for EE 445M by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
