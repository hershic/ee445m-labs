#!/usr/bin/env bash
#
## \file
## \author Eric Crosson <eric.s.crosson@utexas.edu>
## \brief Wrap OpenOCD for communication with the cortex M4 used in ee445m.
## \copyright WTFPLv2
## \version 1.0
#
#########
# License:
#
#             DO WHAT THE FUCK YOU WANT TO PUBLIC LICENSE
#                    Version 2, December 2004
#
# Copyright (C) 2015 Eric Crosson
#
# Everyone is permitted to copy and distribute verbatim or modified
# copies of this license document, and changing it is allowed as long
# as the name is changed.
#
#            DO WHAT THE FUCK YOU WANT TO PUBLIC LICENSE
#   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
#
#  0. You just DO WHAT THE FUCK YOU WANT TO.
#
#########
#
## \details
## \par Script abstract
##
## This script acts as a wrapper to use OpenOCD for communication with
## the cortex M4 used in ee445m.
##
## \par Usage
## \param help Display the help screen
## \param dry-run Don't attempt to execute anything
## \param program Program the M4
## \param debug Open GDB for debugging on the M4
#
## \addtogroup OpenOCD OpenOCD invocation wrapper

# Execute getopt
ARGS=$(getopt -o p:dnh -l "program:,debug,dry-run,help" -n "$0" -- "$@");

# Fail on bad arguments
if [ $? -ne 0 ]; then
    exit 1
fi

eval set -- "${ARGS}";

## @var HELP_OCD
## @brief Contains script invocation information
## @details Contains script invocation information and abstract.
## @ingroup OpenOCD
declare HELP_OCD
HELP_OCD=$(cat <<'EOF'
$0 : Wrap OpenOCD for communication with the cortex M4 used in ee445m.

Usage : [-n] [-p|-d]

  -h : print this help menu
  -n : dry-run -- don't execute anything
  -p : program
  -d : debug

EOF
)

# Determine the context in which OpenOCD will be invoked: su or echo
## @var execute_ocd
## @brief For internal use only.
## @details Controls the executing context of the openocd command.
## @ingroup OpenOCD
declare execute_ocd=sudo

## @var interface_prefixes
## @brief For internal use only.
## @details Users paths to OpenOCD interfaces.
## @ingroup OpenOCD
declare -A interface_prefixes
interface_prefixes=([eric]=/usr/share [hershal]=/opt/local/share)

## @var interface
## @brief For internal use only.
## @details Path to OpenOCD interface for use on this system.
## @ingroup OpenOCD
declare interface=${interface_prefixes[$(whoami)]}/openocd/scripts/board/ek-lm4f120xl.cfg

## @var openocd_target_binary
## @brief For internal use only.
## @details Target binary to flash to M4.
## @ingroup OpenOCD
declare openocd_target_binary

## @var openocd_args_program
## @brief For internal use only.
## @details Openocd command to program the M4.
## @ingroup OpenOCD
declare openocd_args_program

## @var gdb_port
## @brief For internal use only.
## @details Port to communicate to gdb with.
## @ingroup OpenOCD
declare -ri gdb_port=3333

## @var openocd_args_debug
## @brief For internal use only.
## @details Openocd command to open gdb on the M4.
## @ingroup OpenOCD
declare -r openocd_args_debug="gdb_port ${gdb_port}"

# TODO: document
# TODO: kill after three seconds of no activity
retry() {
    local n=0
    local try=$1
    shift

    until [[ $n -ge $try ]]; do
        "$@" && break || {
		((n++))
	    }
    done
}

## @fn openocd_program()
## @brief Program the M4
## @retval 0 if success
## @ingroup OpenOCD
openocd_program() {

    retry 10 ${execute_ocd} openocd --file "${interface}" -c "${openocd_args_program}"
}

## @fn openocd_debug()
## @brief Open GDB on the M4
## @retval 0 if success
## @ingroup OpenOCD
openocd_debug() {

    retry 10 ${execute_ocd} openocd --file "${interface}" -c "${openocd_args_debug}"
}

# Obey command line arguments
while true; do
    case "$1" in

	-p|--program)
	    shift
	    openocd_target_binary="$1"
	    openocd_args_program="program ${openocd_target_binary} verify reset"
	    openocd_program
	    ;;

	-d|--debug)
	    openocd_debug
	    ;;

	-n|--dry_run)
	    # Transform the context in which openocd is invoked
	    execute_ocd=echo
	    ;;

	-h|--help)
	    echo -e "${HELP_OCD}"
	    exit
	    ;;

	--)
	    shift
	    break ;;
    esac
    shift
done
