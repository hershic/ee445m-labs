<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>EE445M Real Time Operating Systems: Flash_pb_api</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">EE445M Real Time Operating Systems
   
   </div>
   <div id="projectbrief">Taken at the University of Texas Spring 2015</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('group__flash__pb__api.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">Flash_pb_api</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__pb__api.html#gae9560b79ebc5c7d96bea3c0821a0373a">FLASH_SECTOR_SIZE</a>&#160;&#160;&#160;<a class="el" href="rom__map_8h.html#a4733444c4a83606e8c5da4f15b712bf0">MAP_SysCtlFlashSectorSizeGet</a>()</td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__pb__api.html#ga41e4a66661ce7849933e9f11135a32c3">FlashPBIsValid</a> (uint8_t *pui8Offset)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__pb__api.html#gab243c2b0f158e0a3c8c89d25d923df5f">FlashPBGet</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__pb__api.html#ga0f202e339edf1758a8b484afa19fb074">FlashPBSave</a> (uint8_t *pui8Buffer)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__pb__api.html#gae1026232dae81709cbe4f7b956749942">FlashPBInit</a> (uint32_t ui32Start, uint32_t ui32End, uint32_t ui32Size)</td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static uint8_t *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__pb__api.html#gab42a6589f3783b6f46d545c4c243f9e0">g_pui8FlashPBStart</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static uint8_t *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__pb__api.html#ga4659f8cb42d49528e15842b6f77563d4">g_pui8FlashPBEnd</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__pb__api.html#ga40ccee1f319920630fb706e12ecf6511">g_ui32FlashPBSize</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static uint8_t *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__flash__pb__api.html#ga1ce1bf42893f1d7d6c4277778a5fa76d">g_pui8FlashPBCurrent</a></td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="gae9560b79ebc5c7d96bea3c0821a0373a"></a><!-- doxytag: member="flash_pb.c::FLASH_SECTOR_SIZE" ref="gae9560b79ebc5c7d96bea3c0821a0373a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define <a class="el" href="group__flash__pb__api.html#gae9560b79ebc5c7d96bea3c0821a0373a">FLASH_SECTOR_SIZE</a>&#160;&#160;&#160;<a class="el" href="rom__map_8h.html#a4733444c4a83606e8c5da4f15b712bf0">MAP_SysCtlFlashSectorSizeGet</a>()</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="flash__pb_8c_source.html#l00083">83</a> of file <a class="el" href="flash__pb_8c_source.html">flash_pb.c</a>.</p>

<p>Referenced by <a class="el" href="flash__pb_8c_source.html#l00410">FlashPBInit()</a>, and <a class="el" href="flash__pb_8c_source.html#l00200">FlashPBSave()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="gab243c2b0f158e0a3c8c89d25d923df5f"></a><!-- doxytag: member="flash_pb.c::FlashPBGet" ref="gab243c2b0f158e0a3c8c89d25d923df5f" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t* <a class="el" href="group__flash__pb__api.html#gab243c2b0f158e0a3c8c89d25d923df5f">FlashPBGet</a> </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Gets the address of the most recent parameter block.</p>
<p>This function returns the address of the most recent parameter block that is stored in flash.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>Returns the address of the most recent parameter block, or NULL if there are no valid parameter blocks in flash. </dd></dl>

<p>Definition at line <a class="el" href="flash__pb_8c_source.html#l00150">150</a> of file <a class="el" href="flash__pb_8c_source.html">flash_pb.c</a>.</p>

<p>References <a class="el" href="flash__pb_8c_source.html#l00076">g_pui8FlashPBCurrent</a>.</p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">//</span>
    <span class="comment">// See if there is a valid parameter block.</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span>(<a class="code" href="group__flash__pb__api.html#ga1ce1bf42893f1d7d6c4277778a5fa76d">g_pui8FlashPBCurrent</a>)
    {
        <span class="comment">//</span>
        <span class="comment">// Return the address of the most recent parameter block.</span>
        <span class="comment">//</span>
        <span class="keywordflow">return</span>(<a class="code" href="group__flash__pb__api.html#ga1ce1bf42893f1d7d6c4277778a5fa76d">g_pui8FlashPBCurrent</a>);
    }

    <span class="comment">//</span>
    <span class="comment">// There are no valid parameter blocks in flash, so return NULL.</span>
    <span class="comment">//</span>
    <span class="keywordflow">return</span>(0);
}
</pre></div>
</div>
</div>
<a class="anchor" id="gae1026232dae81709cbe4f7b956749942"></a><!-- doxytag: member="flash_pb.c::FlashPBInit" ref="gae1026232dae81709cbe4f7b956749942" args="(uint32_t ui32Start, uint32_t ui32End, uint32_t ui32Size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="group__flash__pb__api.html#gae1026232dae81709cbe4f7b956749942">FlashPBInit</a> </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>ui32Start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>ui32End</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>ui32Size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Initializes the flash parameter block.</p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">ui32Start</td><td>is the address of the flash memory to be used for storing flash parameter blocks; this must be the start of an erase block in the flash. </td></tr>
    <tr><td class="paramname">ui32End</td><td>is the address of the end of flash memory to be used for storing flash parameter blocks; this must be the start of an erase block in the flash (the first block that is NOT part of the flash memory to be used), or the address of the first word after the flash array if the last block of flash is to be used. </td></tr>
    <tr><td class="paramname">ui32Size</td><td>is the size of the parameter block when stored in flash; this must be a power of two less than or equal to the flash erase block size (typically 1024).</td></tr>
  </table>
  </dd>
</dl>
<p>This function initializes a fault-tolerant, persistent storage mechanism for a parameter block for an application. The last several erase blocks of flash (as specified by <em>ui32Start</em> and <em>ui32End</em> are used for the storage; more than one erase block is required in order to be fault-tolerant.</p>
<p>A parameter block is an array of bytes that contain the persistent parameters for the application. The only special requirement for the parameter block is that the first byte is a sequence number (explained in <a class="el" href="group__flash__pb__api.html#ga0f202e339edf1758a8b484afa19fb074">FlashPBSave()</a>) and the second byte is a checksum used to validate the correctness of the data (the checksum byte is the byte such that the sum of all bytes in the parameter block is zero).</p>
<p>The portion of flash for parameter block storage is split into N equal-sized regions, where each region is the size of a parameter block (<em>ui32Size</em>). Each region is scanned to find the most recent valid parameter block. The region that has a valid checksum and has the highest sequence number (with special consideration given to wrapping back to zero) is considered to be the current parameter block.</p>
<p>In order to make this efficient and effective, three conditions must be met. The first is <em>ui32Start</em> and <em>ui32End</em> must be specified such that at least two erase blocks of flash are dedicated to parameter block storage. If not, fault tolerance can not be guaranteed since an erase of a single block will leave a window where there are no valid parameter blocks in flash. The second condition is that the size (<em>ui32Size</em>) of the parameter block must be an integral divisor of the size of an erase block of flash. If not, a parameter block will end up spanning between two erase blocks of flash, making it more difficult to manage. The final condition is that the size of the flash dedicated to parameter blocks (<em>ui32End</em> - <em>ui32Start</em>) divided by the parameter block size (<em>ui32Size</em>) must be less than or equal to 128. If not, it will not be possible in all cases to determine which parameter block is the most recent (specifically when dealing with the sequence number wrapping back to zero).</p>
<p>When the microcontroller is initially programmed, the flash blocks used for parameter block storage are left in an erased state.</p>
<p>This function must be called before any other flash parameter block functions are called.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>None. </dd></dl>

<p>Definition at line <a class="el" href="flash__pb_8c_source.html#l00410">410</a> of file <a class="el" href="flash__pb_8c_source.html">flash_pb.c</a>.</p>

<p>References <a class="el" href="debug_8h_source.html#l00067">ASSERT</a>, <a class="el" href="flash__pb_8c_source.html#l00083">FLASH_SECTOR_SIZE</a>, <a class="el" href="flash__pb_8c_source.html#l00098">FlashPBIsValid()</a>, <a class="el" href="flash__pb_8c_source.html#l00076">g_pui8FlashPBCurrent</a>, <a class="el" href="flash__pb_8c_source.html#l00060">g_pui8FlashPBEnd</a>, <a class="el" href="flash__pb_8c_source.html#l00050">g_pui8FlashPBStart</a>, and <a class="el" href="flash__pb_8c_source.html#l00069">g_ui32FlashPBSize</a>.</p>
<div class="fragment"><pre class="fragment">{
    uint8_t *pui8Offset, *pui8Current;
    uint8_t ui8One, ui8Two;

    <span class="comment">//</span>
    <span class="comment">// Check the arguments.</span>
    <span class="comment">//</span>
    <a class="code" href="debug_8h.html#a28301f76c53b643912da7c538f74e2c6">ASSERT</a>((ui32Start % <a class="code" href="group__flash__pb__api.html#gae9560b79ebc5c7d96bea3c0821a0373a">FLASH_SECTOR_SIZE</a>) == 0);
    <a class="code" href="debug_8h.html#a28301f76c53b643912da7c538f74e2c6">ASSERT</a>((ui32End % <a class="code" href="group__flash__pb__api.html#gae9560b79ebc5c7d96bea3c0821a0373a">FLASH_SECTOR_SIZE</a>) == 0);
    <a class="code" href="debug_8h.html#a28301f76c53b643912da7c538f74e2c6">ASSERT</a>((<a class="code" href="group__flash__pb__api.html#gae9560b79ebc5c7d96bea3c0821a0373a">FLASH_SECTOR_SIZE</a> % ui32Size) == 0);

    <span class="comment">//</span>
    <span class="comment">// Save the characteristics of the flash memory to be used for storing</span>
    <span class="comment">// parameter blocks.</span>
    <span class="comment">//</span>
    <a class="code" href="group__flash__pb__api.html#gab42a6589f3783b6f46d545c4c243f9e0">g_pui8FlashPBStart</a> = (uint8_t *)ui32Start;
    <a class="code" href="group__flash__pb__api.html#ga4659f8cb42d49528e15842b6f77563d4">g_pui8FlashPBEnd</a> = (uint8_t *)ui32End;
    <a class="code" href="group__flash__pb__api.html#ga40ccee1f319920630fb706e12ecf6511">g_ui32FlashPBSize</a> = ui32Size;

    <span class="comment">//</span>
    <span class="comment">// Loop through the portion of flash memory used for storing parameter</span>
    <span class="comment">// blocks.</span>
    <span class="comment">//</span>
    <span class="keywordflow">for</span>(pui8Offset = <a class="code" href="group__flash__pb__api.html#gab42a6589f3783b6f46d545c4c243f9e0">g_pui8FlashPBStart</a>, pui8Current = 0;
        pui8Offset &lt; <a class="code" href="group__flash__pb__api.html#ga4659f8cb42d49528e15842b6f77563d4">g_pui8FlashPBEnd</a>; pui8Offset += <a class="code" href="group__flash__pb__api.html#ga40ccee1f319920630fb706e12ecf6511">g_ui32FlashPBSize</a>)
    {
        <span class="comment">//</span>
        <span class="comment">// See if this is a valid parameter block (in other words, the checksum</span>
        <span class="comment">// is correct).</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span>(<a class="code" href="group__flash__pb__api.html#ga41e4a66661ce7849933e9f11135a32c3">FlashPBIsValid</a>(pui8Offset))
        {
            <span class="comment">//</span>
            <span class="comment">// See if a valid parameter block has been previously found.</span>
            <span class="comment">//</span>
            <span class="keywordflow">if</span>(pui8Current != 0)
            {
                <span class="comment">//</span>
                <span class="comment">// Get the sequence numbers for the current and new parameter</span>
                <span class="comment">// blocks.</span>
                <span class="comment">//</span>
                ui8One = pui8Current[0];
                ui8Two = pui8Offset[0];

                <span class="comment">//</span>
                <span class="comment">// See if the sequence number for the new parameter block is</span>
                <span class="comment">// greater than the current block.  The comparison isn&#39;t</span>
                <span class="comment">// straightforward since the one byte sequence number will wrap</span>
                <span class="comment">// after 256 parameter blocks.</span>
                <span class="comment">//</span>
                <span class="keywordflow">if</span>(((ui8One &gt; ui8Two) &amp;&amp; ((ui8One - ui8Two) &lt; 128)) ||
                   ((ui8Two &gt; ui8One) &amp;&amp; ((ui8Two - ui8One) &gt; 128)))
                {
                    <span class="comment">//</span>
                    <span class="comment">// The new parameter block is older than the current</span>
                    <span class="comment">// parameter block, so skip the new parameter block and</span>
                    <span class="comment">// keep searching.</span>
                    <span class="comment">//</span>
                    <span class="keywordflow">continue</span>;
                }
            }

            <span class="comment">//</span>
            <span class="comment">// The new parameter block is more recent than the current one, so</span>
            <span class="comment">// make it the new current parameter block.</span>
            <span class="comment">//</span>
            pui8Current = pui8Offset;
        }
    }

    <span class="comment">//</span>
    <span class="comment">// Save the address of the most recent parameter block found.  If no valid</span>
    <span class="comment">// parameter blocks were found, this will be a NULL pointer.</span>
    <span class="comment">//</span>
    <a class="code" href="group__flash__pb__api.html#ga1ce1bf42893f1d7d6c4277778a5fa76d">g_pui8FlashPBCurrent</a> = pui8Current;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="group__flash__pb__api_gae1026232dae81709cbe4f7b956749942_cgraph.png" border="0" usemap="#group__flash__pb__api_gae1026232dae81709cbe4f7b956749942_cgraph" alt=""/></div>
<map name="group__flash__pb__api_gae1026232dae81709cbe4f7b956749942_cgraph" id="group__flash__pb__api_gae1026232dae81709cbe4f7b956749942_cgraph">
<area shape="rect" id="node3" href="group__flash__pb__api.html#ga41e4a66661ce7849933e9f11135a32c3" title="FlashPBIsValid" alt="" coords="144,5,256,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ga41e4a66661ce7849933e9f11135a32c3"></a><!-- doxytag: member="flash_pb.c::FlashPBIsValid" ref="ga41e4a66661ce7849933e9f11135a32c3" args="(uint8_t *pui8Offset)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static uint32_t <a class="el" href="group__flash__pb__api.html#ga41e4a66661ce7849933e9f11135a32c3">FlashPBIsValid</a> </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>pui8Offset</em></td><td>)</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Determines if the parameter block at the given address is valid.</p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">pui8Offset</td><td>is the address of the parameter block to check.</td></tr>
  </table>
  </dd>
</dl>
<p>This function will compute the checksum of a parameter block in flash to determine if it is valid.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>Returns one if the parameter block is valid and zero if it is not. </dd></dl>

<p>Definition at line <a class="el" href="flash__pb_8c_source.html#l00098">98</a> of file <a class="el" href="flash__pb_8c_source.html">flash_pb.c</a>.</p>

<p>References <a class="el" href="debug_8h_source.html#l00067">ASSERT</a>, and <a class="el" href="flash__pb_8c_source.html#l00069">g_ui32FlashPBSize</a>.</p>

<p>Referenced by <a class="el" href="flash__pb_8c_source.html#l00410">FlashPBInit()</a>.</p>
<div class="fragment"><pre class="fragment">{
    uint32_t ui32Idx, ui32Sum;

    <span class="comment">//</span>
    <span class="comment">// Check the arguments.</span>
    <span class="comment">//</span>
    <a class="code" href="debug_8h.html#a28301f76c53b643912da7c538f74e2c6">ASSERT</a>(pui8Offset != (<span class="keywordtype">void</span> *)0);

    <span class="comment">//</span>
    <span class="comment">// Loop through the bytes in the block, computing the checksum.</span>
    <span class="comment">//</span>
    <span class="keywordflow">for</span>(ui32Idx = 0, ui32Sum = 0; ui32Idx &lt; <a class="code" href="group__flash__pb__api.html#ga40ccee1f319920630fb706e12ecf6511">g_ui32FlashPBSize</a>; ui32Idx++)
    {
        ui32Sum += pui8Offset[ui32Idx];
    }

    <span class="comment">//</span>
    <span class="comment">// The checksum should be zero, so return a failure if it is not.</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span>((ui32Sum &amp; 255) != 0)
    {
        <span class="keywordflow">return</span>(0);
    }

    <span class="comment">//</span>
    <span class="comment">// If the sum is equal to the size * 255, then the block is all ones and</span>
    <span class="comment">// should not be considered valid.</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span>((g_ui32FlashPBSize * 255) == ui32Sum)
    {
        <span class="keywordflow">return</span>(0);
    }

    <span class="comment">//</span>
    <span class="comment">// This is a valid parameter block.</span>
    <span class="comment">//</span>
    <span class="keywordflow">return</span>(1);
}
</pre></div>
<p><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="group__flash__pb__api_ga41e4a66661ce7849933e9f11135a32c3_icgraph.png" border="0" usemap="#group__flash__pb__api_ga41e4a66661ce7849933e9f11135a32c3_icgraph" alt=""/></div>
<map name="group__flash__pb__api_ga41e4a66661ce7849933e9f11135a32c3_icgraph" id="group__flash__pb__api_ga41e4a66661ce7849933e9f11135a32c3_icgraph">
<area shape="rect" id="node3" href="group__flash__pb__api.html#gae1026232dae81709cbe4f7b956749942" title="FlashPBInit" alt="" coords="165,5,256,35"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ga0f202e339edf1758a8b484afa19fb074"></a><!-- doxytag: member="flash_pb.c::FlashPBSave" ref="ga0f202e339edf1758a8b484afa19fb074" args="(uint8_t *pui8Buffer)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="group__flash__pb__api.html#ga0f202e339edf1758a8b484afa19fb074">FlashPBSave</a> </td>
          <td>(</td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>pui8Buffer</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Writes a new parameter block to flash.</p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">pui8Buffer</td><td>is the address of the parameter block to be written to flash.</td></tr>
  </table>
  </dd>
</dl>
<p>This function will write a parameter block to flash. Saving the new parameter blocks involves three steps:</p>
<ul>
<li>Setting the sequence number such that it is one greater than the sequence number of the latest parameter block in flash.</li>
<li>Computing the checksum of the parameter block.</li>
<li>Writing the parameter block into the storage immediately following the latest parameter block in flash; if that storage is at the start of an erase block, that block is erased first.</li>
</ul>
<p>By this process, there is always a valid parameter block in flash. If power is lost while writing a new parameter block, the checksum will not match and the partially written parameter block will be ignored. This is what makes this fault-tolerant.</p>
<p>Another benefit of this scheme is that it provides wear leveling on the flash. Since multiple parameter blocks fit into each erase block of flash, and multiple erase blocks are used for parameter block storage, it takes quite a few parameter block saves before flash is re-written.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>None. </dd></dl>

<p>Definition at line <a class="el" href="flash__pb_8c_source.html#l00200">200</a> of file <a class="el" href="flash__pb_8c_source.html">flash_pb.c</a>.</p>

<p>References <a class="el" href="debug_8h_source.html#l00067">ASSERT</a>, <a class="el" href="flash__pb_8c_source.html#l00083">FLASH_SECTOR_SIZE</a>, <a class="el" href="flash__pb_8c_source.html#l00076">g_pui8FlashPBCurrent</a>, <a class="el" href="flash__pb_8c_source.html#l00060">g_pui8FlashPBEnd</a>, <a class="el" href="flash__pb_8c_source.html#l00050">g_pui8FlashPBStart</a>, <a class="el" href="flash__pb_8c_source.html#l00069">g_ui32FlashPBSize</a>, <a class="el" href="rom__map_8h_source.html#l01668">MAP_FlashErase</a>, and <a class="el" href="rom__map_8h_source.html#l01661">MAP_FlashProgram</a>.</p>
<div class="fragment"><pre class="fragment">{
    uint8_t *pui8New;
    uint32_t ui32Idx, ui32Sum;

    <span class="comment">//</span>
    <span class="comment">// Check the arguments.</span>
    <span class="comment">//</span>
    <a class="code" href="debug_8h.html#a28301f76c53b643912da7c538f74e2c6">ASSERT</a>(pui8Buffer != (<span class="keywordtype">void</span> *)0);

    <span class="comment">//</span>
    <span class="comment">// See if there is a valid parameter block in flash.</span>
    <span class="comment">//</span>
    <span class="keywordflow">if</span>(<a class="code" href="group__flash__pb__api.html#ga1ce1bf42893f1d7d6c4277778a5fa76d">g_pui8FlashPBCurrent</a>)
    {
        <span class="comment">//</span>
        <span class="comment">// Set the sequence number to one greater than the most recent</span>
        <span class="comment">// parameter block.</span>
        <span class="comment">//</span>
        pui8Buffer[0] = <a class="code" href="group__flash__pb__api.html#ga1ce1bf42893f1d7d6c4277778a5fa76d">g_pui8FlashPBCurrent</a>[0] + 1;

        <span class="comment">//</span>
        <span class="comment">// Try to write the new parameter block immediately after the most</span>
        <span class="comment">// recent parameter block.</span>
        <span class="comment">//</span>
        pui8New = <a class="code" href="group__flash__pb__api.html#ga1ce1bf42893f1d7d6c4277778a5fa76d">g_pui8FlashPBCurrent</a> + <a class="code" href="group__flash__pb__api.html#ga40ccee1f319920630fb706e12ecf6511">g_ui32FlashPBSize</a>;
        <span class="keywordflow">if</span>(pui8New == <a class="code" href="group__flash__pb__api.html#ga4659f8cb42d49528e15842b6f77563d4">g_pui8FlashPBEnd</a>)
        {
            pui8New = <a class="code" href="group__flash__pb__api.html#gab42a6589f3783b6f46d545c4c243f9e0">g_pui8FlashPBStart</a>;
        }
    }
    <span class="keywordflow">else</span>
    {
        <span class="comment">//</span>
        <span class="comment">// There is not a valid parameter block in flash, so set the sequence</span>
        <span class="comment">// number of this parameter block to zero.</span>
        <span class="comment">//</span>
        pui8Buffer[0] = 0;

        <span class="comment">//</span>
        <span class="comment">// Try to write the new parameter block at the beginning of the flash</span>
        <span class="comment">// space for parameter blocks.</span>
        <span class="comment">//</span>
        pui8New = <a class="code" href="group__flash__pb__api.html#gab42a6589f3783b6f46d545c4c243f9e0">g_pui8FlashPBStart</a>;
    }

    <span class="comment">//</span>
    <span class="comment">// Compute the checksum of the parameter block to be written.</span>
    <span class="comment">//</span>
    <span class="keywordflow">for</span>(ui32Idx = 0, ui32Sum = 0; ui32Idx &lt; <a class="code" href="group__flash__pb__api.html#ga40ccee1f319920630fb706e12ecf6511">g_ui32FlashPBSize</a>; ui32Idx++)
    {
        ui32Sum -= pui8Buffer[ui32Idx];
    }

    <span class="comment">//</span>
    <span class="comment">// Store the checksum into the parameter block.</span>
    <span class="comment">//</span>
    pui8Buffer[1] += ui32Sum;

    <span class="comment">//</span>
    <span class="comment">// Look for a location to store this parameter block.  This infinite loop</span>
    <span class="comment">// will be explicitly broken out of when a valid location is found.</span>
    <span class="comment">//</span>
    <span class="keywordflow">while</span>(1)
    {
        <span class="comment">//</span>
        <span class="comment">// See if this location is at the start of an erase block.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span>(((uint32_t)pui8New &amp; (<a class="code" href="group__flash__pb__api.html#gae9560b79ebc5c7d96bea3c0821a0373a">FLASH_SECTOR_SIZE</a> - 1)) == 0)
        {
            <span class="comment">//</span>
            <span class="comment">// Erase this block of the flash.  This does not assume that the</span>
            <span class="comment">// erase succeeded in case this block of the flash has become bad</span>
            <span class="comment">// through too much use.  Given the extremely low frequency that</span>
            <span class="comment">// the parameter blocks are written, this will likely never fail.</span>
            <span class="comment">// But, that assumption is not made in order to be safe.</span>
            <span class="comment">//</span>
            <a class="code" href="rom__map_8h.html#a3c36187721cd1f7ba1f45d7367753dca">MAP_FlashErase</a>((uint32_t)pui8New);
        }

        <span class="comment">//</span>
        <span class="comment">// Loop through this portion of flash to see if is all ones (in other</span>
        <span class="comment">// words, it is an erased portion of flash).</span>
        <span class="comment">//</span>
        <span class="keywordflow">for</span>(ui32Idx = 0; ui32Idx &lt; <a class="code" href="group__flash__pb__api.html#ga40ccee1f319920630fb706e12ecf6511">g_ui32FlashPBSize</a>; ui32Idx++)
        {
            <span class="keywordflow">if</span>(pui8New[ui32Idx] != 0xff)
            {
                <span class="keywordflow">break</span>;
            }
        }

        <span class="comment">//</span>
        <span class="comment">// If all bytes in this portion of flash are ones, then break out of</span>
        <span class="comment">// the loop since this is a good location for storing the parameter</span>
        <span class="comment">// block.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span>(ui32Idx == g_ui32FlashPBSize)
        {
            <span class="keywordflow">break</span>;
        }

        <span class="comment">//</span>
        <span class="comment">// Increment to the next parameter block location.</span>
        <span class="comment">//</span>
        pui8New += <a class="code" href="group__flash__pb__api.html#ga40ccee1f319920630fb706e12ecf6511">g_ui32FlashPBSize</a>;
        <span class="keywordflow">if</span>(pui8New == <a class="code" href="group__flash__pb__api.html#ga4659f8cb42d49528e15842b6f77563d4">g_pui8FlashPBEnd</a>)
        {
            pui8New = <a class="code" href="group__flash__pb__api.html#gab42a6589f3783b6f46d545c4c243f9e0">g_pui8FlashPBStart</a>;
        }

        <span class="comment">//</span>
        <span class="comment">// If every possible location has been checked and none are valid, then</span>
        <span class="comment">// it will not be possible to write this parameter block.  Simply</span>
        <span class="comment">// return without writing it.</span>
        <span class="comment">//</span>
        <span class="keywordflow">if</span>((<a class="code" href="group__flash__pb__api.html#ga1ce1bf42893f1d7d6c4277778a5fa76d">g_pui8FlashPBCurrent</a> &amp;&amp; (pui8New == <a class="code" href="group__flash__pb__api.html#ga1ce1bf42893f1d7d6c4277778a5fa76d">g_pui8FlashPBCurrent</a>)) ||
           (!<a class="code" href="group__flash__pb__api.html#ga1ce1bf42893f1d7d6c4277778a5fa76d">g_pui8FlashPBCurrent</a> &amp;&amp; (pui8New == <a class="code" href="group__flash__pb__api.html#gab42a6589f3783b6f46d545c4c243f9e0">g_pui8FlashPBStart</a>)))
        {
            <span class="keywordflow">return</span>;
        }
    }

    <span class="comment">//</span>
    <span class="comment">// Write this parameter block to flash.</span>
    <span class="comment">//</span>
    <a class="code" href="rom__map_8h.html#a117a1fdf7bf547f2e7ffed91e3a9d0b4">MAP_FlashProgram</a>((uint32_t *)pui8Buffer, (uint32_t)pui8New,
                     g_ui32FlashPBSize);

    <span class="comment">//</span>
    <span class="comment">// Compare the parameter block data to the data that should now be in</span>
    <span class="comment">// flash.  Return if any of the data does not compare, leaving the previous</span>
    <span class="comment">// parameter block in flash as the most recent (since the current parameter</span>
    <span class="comment">// block failed to properly program).</span>
    <span class="comment">//</span>
    <span class="keywordflow">for</span>(ui32Idx = 0; ui32Idx &lt; <a class="code" href="group__flash__pb__api.html#ga40ccee1f319920630fb706e12ecf6511">g_ui32FlashPBSize</a>; ui32Idx++)
    {
        <span class="keywordflow">if</span>(pui8New[ui32Idx] != pui8Buffer[ui32Idx])
        {
            <span class="keywordflow">return</span>;
        }
    }

    <span class="comment">//</span>
    <span class="comment">// The new parameter block becomes the most recent parameter block.</span>
    <span class="comment">//</span>
    <a class="code" href="group__flash__pb__api.html#ga1ce1bf42893f1d7d6c4277778a5fa76d">g_pui8FlashPBCurrent</a> = pui8New;
}
</pre></div>
</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="ga1ce1bf42893f1d7d6c4277778a5fa76d"></a><!-- doxytag: member="flash_pb.c::g_pui8FlashPBCurrent" ref="ga1ce1bf42893f1d7d6c4277778a5fa76d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t* <a class="el" href="group__flash__pb__api.html#ga1ce1bf42893f1d7d6c4277778a5fa76d">g_pui8FlashPBCurrent</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="flash__pb_8c_source.html#l00076">76</a> of file <a class="el" href="flash__pb_8c_source.html">flash_pb.c</a>.</p>

<p>Referenced by <a class="el" href="flash__pb_8c_source.html#l00150">FlashPBGet()</a>, <a class="el" href="flash__pb_8c_source.html#l00410">FlashPBInit()</a>, and <a class="el" href="flash__pb_8c_source.html#l00200">FlashPBSave()</a>.</p>

</div>
</div>
<a class="anchor" id="ga4659f8cb42d49528e15842b6f77563d4"></a><!-- doxytag: member="flash_pb.c::g_pui8FlashPBEnd" ref="ga4659f8cb42d49528e15842b6f77563d4" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t* <a class="el" href="group__flash__pb__api.html#ga4659f8cb42d49528e15842b6f77563d4">g_pui8FlashPBEnd</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="flash__pb_8c_source.html#l00060">60</a> of file <a class="el" href="flash__pb_8c_source.html">flash_pb.c</a>.</p>

<p>Referenced by <a class="el" href="flash__pb_8c_source.html#l00410">FlashPBInit()</a>, and <a class="el" href="flash__pb_8c_source.html#l00200">FlashPBSave()</a>.</p>

</div>
</div>
<a class="anchor" id="gab42a6589f3783b6f46d545c4c243f9e0"></a><!-- doxytag: member="flash_pb.c::g_pui8FlashPBStart" ref="gab42a6589f3783b6f46d545c4c243f9e0" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t* <a class="el" href="group__flash__pb__api.html#gab42a6589f3783b6f46d545c4c243f9e0">g_pui8FlashPBStart</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="flash__pb_8c_source.html#l00050">50</a> of file <a class="el" href="flash__pb_8c_source.html">flash_pb.c</a>.</p>

<p>Referenced by <a class="el" href="flash__pb_8c_source.html#l00410">FlashPBInit()</a>, and <a class="el" href="flash__pb_8c_source.html#l00200">FlashPBSave()</a>.</p>

</div>
</div>
<a class="anchor" id="ga40ccee1f319920630fb706e12ecf6511"></a><!-- doxytag: member="flash_pb.c::g_ui32FlashPBSize" ref="ga40ccee1f319920630fb706e12ecf6511" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t <a class="el" href="group__flash__pb__api.html#ga40ccee1f319920630fb706e12ecf6511">g_ui32FlashPBSize</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="flash__pb_8c_source.html#l00069">69</a> of file <a class="el" href="flash__pb_8c_source.html">flash_pb.c</a>.</p>

<p>Referenced by <a class="el" href="flash__pb_8c_source.html#l00410">FlashPBInit()</a>, <a class="el" href="flash__pb_8c_source.html#l00098">FlashPBIsValid()</a>, and <a class="el" href="flash__pb_8c_source.html#l00200">FlashPBSave()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div>
  <div id="nav-path" class="navpath">
    <ul>

    <li class="footer">Generated on Tue Jan 27 2015 22:34:58 for EE445M Real Time Operating Systems by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
